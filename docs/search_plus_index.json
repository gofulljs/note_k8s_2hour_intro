{"./":{"url":"./","title":"Kubernetes è¯¾ç¨‹å¯¼è¯»","keywords":"","body":"k8s è¯¾ç¨‹å¯¼è¯» a note use gitbook for Kubernetes äºŒå°æ—¶å…¥é—¨æ•™ç¨‹, æ ¹æ®è‡ªå·±çš„å­¦ä¹ ä¼šåšä¸€äº›æ·»åŠ å’Œè¡¥å……, é˜²æ­¢ç¾½é›€åˆå´©äº†, 2023-10-23 å´©è¿‡ ğŸ˜‚ B ç«™è§†é¢‘åœ°å€ https://www.bilibili.com/video/BV1k24y197KC åŸæ–‡æ¡£åœ°å€ https://www.yuque.com/wukong-zorrm/qdoy5p ä¸ºä»€ä¹ˆ Kubernetes å­¦èµ·æ¥å¾ˆéš¾ï¼Ÿ zh Kubernetes æœ¬èº«æ¯”è¾ƒå¤æ‚ï¼Œç»„ä»¶ä¼—å¤šï¼Œå®‰è£…è¿‡ç¨‹æ¯”è¾ƒéº»çƒ¦ æœ¬è¯¾ç¨‹ä½¿ç”¨ K3s å¿«é€Ÿåˆ›å»ºå­¦ä¹ ç¯å¢ƒï¼Œä¸è¦æŠŠæ—¶é—´å’Œç²¾åŠ›æµªè´¹åœ¨æ­ç¯å¢ƒä¸Š ç½‘ç»œé—®é¢˜ï¼Œè®¸å¤šè°·æ­Œé•œåƒæˆ–è½¯ä»¶ä»“åº“è®¿é—®ä¸åˆ°ï¼Œæ‹‰å–å¤±è´¥ é…ç½®é˜¿é‡Œäº‘é•œåƒåŠ é€Ÿ æ‰‹åŠ¨æ‹‰å–é•œåƒã€æ‰‹åŠ¨å¯¼å‡ºã€å¯¼å…¥é•œåƒ Kubernetes ç‰ˆæœ¬æœ‰é‡å¤§å˜åŒ–ï¼Œç½‘ä¸Šå¥½å¤šæ•™ç¨‹å·²è¿‡æ—¶ kubernetes ä» 1.24 ç‰ˆæœ¬å¼€å§‹ï¼Œç§»é™¤äº†å¯¹ docker çš„æ”¯æŒ æœ¬è¯¾ç¨‹é‡‡ç”¨ 1.25 ç‰ˆæœ¬ï¼Œä½¿ç”¨ containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ è¯¾ç¨‹ä¸­å¯¹ containerd ç”¨æ³•ä»¥åŠå¯èƒ½é‡åˆ°çš„é—®é¢˜è¿›è¡Œäº†è¯´æ˜ å®˜æ–¹æ–‡æ¡£æœ‰é”™è¯¯ï¼Œè®¸å¤šä¾‹å­æˆ–å‘½ä»¤è¿è¡Œä¸èµ·æ¥ æœ¬è¯¾ç¨‹ä¼šå¸®ä½ é¿è¿‡å®˜æ–¹æ–‡æ¡£ä¸­çš„å‘ å¾ˆå¤šæ•™ç¨‹åªæœ‰ä¾‹å­ï¼Œæ²¡æœ‰å®æˆ˜ï¼Œå¯¼è‡´â€œä¸€å­¦å°±ä¼šï¼Œä¸€ç”¨å°±åºŸâ€ æœ¬è¯¾ç¨‹ä¼šæ¼”ç¤ºå¸¸ç”¨ä¸­é—´ä»¶çš„å®‰è£…ï¼ˆMySQL ä¸»ä»é›†ç¾¤ã€Redis ä¸»ä»é›†ç¾¤ï¼‰ æœ¬è¯¾ç¨‹ä¼šæ¼”ç¤ºå¦‚ä½•åœ¨ K8s ä¸Šè¿è¡Œä¸€ä¸ªå®Œæ•´çš„åº”ç”¨ åº”ç”¨ç¨‹åºåŒ…æ‹¬å‰ç«¯(node/nginx)ã€ç¼“å­˜(redis)ã€æ•°æ®åº“(mysql)ã€åç«¯(javaï¼‰ "},"base/":{"url":"base/","title":"Kubernetes åŸºç¡€","keywords":"","body":""},"base/intro.html":{"url":"base/intro.html","title":"Kubernetes ç®€ä»‹","keywords":"","body":"Kubernetes ç®€ä»‹ ç®€ä»‹ Kubernetes æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å¼•æ“å’Œå®¹å™¨é›†ç¾¤ç®¡ç†å·¥å…·ï¼Œç”¨æ¥å¯¹å®¹å™¨åŒ–åº”ç”¨è¿›è¡Œè‡ªåŠ¨åŒ–éƒ¨ç½²ã€ æ‰©ç¼©å’Œç®¡ç†ã€‚ Kubernetes è¿™ä¸ªåå­—æºäºå¸Œè…Šè¯­ï¼Œæ„ä¸ºâ€œèˆµæ‰‹â€æˆ–â€œé£è¡Œå‘˜â€ã€‚k8s è¿™ä¸ªç¼©å†™æ˜¯å› ä¸º k å’Œ s ä¹‹é—´æœ‰ 8 ä¸ªå­—ç¬¦ã€‚ Google åœ¨ 2014 å¹´å¼€æºäº† Kubernetes é¡¹ç›®ã€‚ ä¼˜åŠ¿ Kubernetes å»ºç«‹åœ¨ Google å¤§è§„æ¨¡è¿è¡Œç”Ÿäº§å·¥ä½œè´Ÿè½½åå‡ å¹´ç»éªŒçš„åŸºç¡€ä¸Šï¼Œ ç»“åˆäº†ç¤¾åŒºä¸­æœ€ä¼˜ç§€çš„æƒ³æ³•å’Œå®è·µã€‚å®ƒä¹‹æ‰€ä»¥èƒ½å¤Ÿè¿…é€Ÿæµè¡Œèµ·æ¥ï¼Œæ˜¯å› ä¸ºå®ƒçš„è®¸å¤šåŠŸèƒ½é«˜åº¦å¥‘åˆäº’è”ç½‘å¤§å‚çš„éƒ¨ç½²å’Œè¿ç»´éœ€æ±‚ã€‚ Kubernetes å¯ä»¥æä¾›ï¼š æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ Kubernetes å¯ä»¥ä½¿ç”¨ DNS åç§°æˆ–è‡ªå·±çš„ IP åœ°å€æ¥æ›éœ²å®¹å™¨ã€‚ å¦‚æœè¿›å…¥å®¹å™¨çš„æµé‡å¾ˆå¤§ Kubernetes å¯ä»¥è´Ÿè½½å‡è¡¡å¹¶åˆ†é…ç½‘ç»œæµé‡ï¼Œä»è€Œä½¿éƒ¨ç½²ç¨³å®šã€‚ å­˜å‚¨ç¼–æ’ Kubernetes å…è®¸ä½ è‡ªåŠ¨æŒ‚è½½ä½ é€‰æ‹©çš„å­˜å‚¨ç³»ç»Ÿï¼Œä¾‹å¦‚æœ¬åœ°å­˜å‚¨ã€å…¬å…±äº‘æä¾›å•†ç­‰ã€‚ è‡ªåŠ¨éƒ¨ç½²å’Œå›æ»š ä½ å¯ä»¥ä½¿ç”¨ Kubernetes æè¿°å·²éƒ¨ç½²å®¹å™¨çš„æ‰€éœ€çŠ¶æ€ï¼Œ å®ƒå¯ä»¥ä»¥å—æ§çš„é€Ÿç‡å°†å®é™…çŠ¶æ€æ›´æ”¹ä¸ºæœŸæœ›çŠ¶æ€ã€‚ ä¾‹å¦‚ï¼Œä½ å¯ä»¥è‡ªåŠ¨åŒ– Kubernetes æ¥ä¸ºä½ çš„éƒ¨ç½²åˆ›å»ºæ–°å®¹å™¨ï¼Œ åˆ é™¤ç°æœ‰å®¹å™¨å¹¶å°†å®ƒä»¬çš„æ‰€æœ‰èµ„æºç”¨äºæ–°å®¹å™¨ã€‚ä¹Ÿå¯ä»¥æ˜¯æ–¹ä¾¿çš„å®ç°é‡‘ä¸é›€éƒ¨ç½²(canary deployment )ã€‚ è‡ªåŠ¨å®Œæˆè£…ç®±è®¡ç®— ä½ ä¸º Kubernetes æä¾›è®¸å¤šèŠ‚ç‚¹ç»„æˆçš„é›†ç¾¤ï¼Œåœ¨è¿™ä¸ªé›†ç¾¤ä¸Šè¿è¡Œå®¹å™¨åŒ–çš„ä»»åŠ¡ã€‚ ä½ å‘Šè¯‰ Kubernetes æ¯ä¸ªå®¹å™¨éœ€è¦å¤šå°‘ CPU å’Œå†…å­˜ (RAM)ã€‚ Kubernetes å¯ä»¥å°†è¿™äº›å®¹å™¨æŒ‰å®é™…æƒ…å†µè°ƒåº¦åˆ°ä½ çš„èŠ‚ç‚¹ä¸Šï¼Œä»¥æœ€ä½³æ–¹å¼åˆ©ç”¨ä½ çš„èµ„æºã€‚ è‡ªæˆ‘ä¿®å¤ Kubernetes å°†é‡æ–°å¯åŠ¨å¤±è´¥çš„å®¹å™¨ã€æ›¿æ¢å®¹å™¨ã€æ€æ­»ä¸å“åº”ç”¨æˆ·å®šä¹‰çš„è¿è¡ŒçŠ¶å†µæ£€æŸ¥çš„å®¹å™¨ï¼Œ å¹¶ä¸”åœ¨å‡†å¤‡å¥½æœåŠ¡ä¹‹å‰ä¸å°†å…¶é€šå‘Šç»™å®¢æˆ·ç«¯ã€‚ å¯†é’¥ä¸é…ç½®ç®¡ç† ubernetes å…è®¸ä½ å­˜å‚¨å’Œç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å¯†ç ã€OAuth ä»¤ç‰Œå’Œ ssh å¯†é’¥ã€‚ ä½ å¯ä»¥åœ¨ä¸é‡å»ºå®¹å™¨é•œåƒçš„æƒ…å†µä¸‹éƒ¨ç½²å’Œæ›´æ–°å¯†é’¥å’Œåº”ç”¨ç¨‹åºé…ç½®ï¼Œä¹Ÿæ— éœ€åœ¨å †æ ˆé…ç½®ä¸­æš´éœ²å¯†é’¥ã€‚ äº‘åŸç”Ÿ 2015 å¹´ç”± Googleã€Redhat ç­‰å¤§å‹äº‘è®¡ç®—å‚å•†ä»¥åŠä¸€äº›å¼€æºå…¬å¸å…±åŒç‰µå¤´æˆç«‹äº† Cloud Native Computing Foundationï¼ˆäº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼‰ã€‚ äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼ˆCNCFï¼‰è‡´åŠ›äºåŸ¹è‚²å’Œç»´æŠ¤ä¸€ä¸ªå‚å•†ä¸­ç«‹çš„å¼€æºç”Ÿæ€ç³»ç»Ÿï¼Œæ¥æ¨å¹¿äº‘åŸç”ŸæŠ€æœ¯ã€‚ äº‘åŸç”Ÿçš„æ¦‚å¿µä»æ­¤å¹¿æ³›ä¼ æ’­ã€‚ äº‘åŸç”Ÿå®šä¹‰ Kubernetes æ˜¯ CNCF æ‰˜ç®¡çš„ç¬¬ä¸€ä¸ªå¼€æºé¡¹ç›®ã€‚å› æ­¤ç°åœ¨æåˆ°äº‘åŸç”Ÿï¼Œå¾€å¾€æˆ‘ä»¬éƒ½æŠŠå®ƒä¸ kubernetes è”ç³»èµ·æ¥ã€‚ é€šä¿—è§£é‡Š ä½¿ç”¨ Javaã€Goã€PHPã€Python ç­‰è¯­è¨€å¼€å‘çš„åº”ç”¨æˆ‘ä»¬ç§°ä¹‹ä¸ºåŸç”Ÿåº”ç”¨ï¼Œåœ¨è®¾è®¡å’Œå¼€å‘è¿™äº›åº”ç”¨æ—¶ï¼Œä½¿ä»–ä»¬èƒ½å¤Ÿè¿è¡Œåœ¨äº‘åŸºç¡€è®¾æ–½(æˆ– kubernetes)ä¸Šï¼Œä»è€Œä½¿åº”ç”¨å…·å¤‡å¯å¼¹æ€§æ‰©å±•çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºäº‘åŸç”Ÿåº”ç”¨ã€‚æˆ‘ä»¬å¯ä»¥å°†äº‘åŸç”Ÿç†è§£ä¸ºä»¥å®¹å™¨æŠ€æœ¯ä¸ºè½½ä½“ã€åŸºäºå¾®æœåŠ¡æ¶æ„æ€æƒ³çš„ä¸€å¥—æŠ€æœ¯ä½“ç³»å’Œæ–¹æ³•è®ºã€‚ å®˜æ–¹å®šä¹‰ äº‘åŸç”ŸæŠ€æœ¯æœ‰åˆ©äºå„ç»„ç»‡åœ¨å…¬æœ‰äº‘ã€ç§æœ‰äº‘å’Œæ··åˆäº‘ç­‰æ–°å‹åŠ¨æ€ç¯å¢ƒä¸­ï¼Œæ„å»ºå’Œè¿è¡Œå¯å¼¹æ€§æ‰©å±•çš„åº”ç”¨ã€‚äº‘åŸç”Ÿçš„ä»£è¡¨æŠ€æœ¯åŒ…æ‹¬å®¹å™¨ã€æœåŠ¡ç½‘æ ¼ã€å¾®æœåŠ¡ã€ä¸å¯å˜åŸºç¡€è®¾æ–½å’Œå£°æ˜å¼APIã€‚ è¿™äº›æŠ€æœ¯èƒ½å¤Ÿæ„å»ºå®¹é”™æ€§å¥½ã€æ˜“äºç®¡ç†å’Œä¾¿äºè§‚å¯Ÿçš„æ¾è€¦åˆç³»ç»Ÿã€‚ç»“åˆå¯é çš„è‡ªåŠ¨åŒ–æ‰‹æ®µï¼Œäº‘åŸç”ŸæŠ€æœ¯ä½¿å·¥ç¨‹å¸ˆèƒ½å¤Ÿè½»æ¾åœ°å¯¹ç³»ç»Ÿä½œå‡ºé¢‘ç¹å’Œå¯é¢„æµ‹çš„é‡å¤§å˜æ›´ã€‚ å¾®æœåŠ¡ åœ¨ Kubernetes ä¹‹å‰ï¼ŒPivotalï¼ˆå¼€æº Java å¼€å‘æ¡†æ¶ Spring çš„æ¯å…¬å¸ï¼Œåè¢« VMware æ”¶è´­ï¼‰æ˜¯äº‘åŸç”Ÿåº”ç”¨çš„æå‡ºè€…ï¼Œå¹¶æ¨å‡ºäº† Pivotal Cloud Foundry äº‘åŸç”Ÿåº”ç”¨å¹³å°å’Œ Spring Cloud å¼€å‘æ¡†æ¶ï¼Œæˆä¸ºäº‘åŸç”Ÿåº”ç”¨æ¶æ„ä¸­å…ˆé©±è€…å’Œæ¢è·¯è€…ã€‚Spring Cloud é€šè¿‡å¾®æœåŠ¡æ¶æ„ï¼Œä½¿ç¨‹åºå…·å¤‡å¯æ‹“å±•æ€§å’Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒè¿è¡Œçš„èƒ½åŠ›ã€‚Spring Cloud å’Œ Kubernetes æœ‰å¾ˆå¤šåŠŸèƒ½æ˜¯é‡åˆçš„ï¼Œä¾‹å¦‚ï¼š æœåŠ¡æ³¨å†Œå’Œå‘ç° API ç½‘å…³ è´Ÿè½½å‡è¡¡ é…ç½®ç®¡ç† ä½†æ˜¯ Spring Cloud åªèƒ½ç”¨äº Java åº”ç”¨å¼€å‘ï¼Œè€Œ kubernetes æ˜¯è¯­è¨€æ— å…³çš„ï¼Œå¯ä»¥ç”¨äºå„ç§è¯­è¨€å¼€å‘çš„åº”ç”¨ã€‚ æ–‡æ¡£å‚è€ƒ:https://kubernetes.io/zh-cn/docs/concepts/overview/ https://github.com/cncf/toc/blob/main/DEFINITION.md "},"base/architecture.html":{"url":"base/architecture.html","title":"Kubernetes æ¶æ„","keywords":"","body":"kubernetes æ¶æ„ kubernetes æ¶æ„ ä¸€ä¸ª Kubernetes é›†ç¾¤è‡³å°‘åŒ…å«ä¸€ä¸ªæ§åˆ¶å¹³é¢(control plane)ï¼Œä»¥åŠä¸€ä¸ªæˆ–å¤šä¸ªå·¥ä½œèŠ‚ç‚¹(worker node)ã€‚ æ§åˆ¶å¹³é¢(Control Plane) : æ§åˆ¶å¹³é¢è´Ÿè´£ç®¡ç†å·¥ä½œèŠ‚ç‚¹å’Œç»´æŠ¤é›†ç¾¤çŠ¶æ€ã€‚æ‰€æœ‰ä»»åŠ¡åˆ†é…éƒ½æ¥è‡ªäºæ§åˆ¶å¹³é¢ã€‚ å·¥ä½œèŠ‚ç‚¹(Worker Node) : å·¥ä½œèŠ‚ç‚¹è´Ÿè´£æ‰§è¡Œç”±æ§åˆ¶å¹³é¢åˆ†é…çš„è¯·æ±‚ä»»åŠ¡,è¿è¡Œå®é™…çš„åº”ç”¨å’Œå·¥ä½œè´Ÿè½½ã€‚ æ§åˆ¶å¹³é¢ æ§åˆ¶å¹³é¢ç»„ä»¶ä¼šä¸ºé›†ç¾¤åšå‡ºå…¨å±€å†³ç­–ï¼Œæ¯”å¦‚èµ„æºçš„è°ƒåº¦ã€æ£€æµ‹å’Œå“åº”é›†ç¾¤äº‹ä»¶ã€‚ kube-apiserver å¦‚æœéœ€è¦ä¸ Kubernetes é›†ç¾¤è¿›è¡Œäº¤äº’ï¼Œå°±è¦é€šè¿‡ APIã€‚ apiserveræ˜¯ Kubernetes æ§åˆ¶å¹³é¢çš„å‰ç«¯ï¼Œç”¨äºå¤„ç†å†…éƒ¨å’Œå¤–éƒ¨è¯·æ±‚ã€‚ kube-scheduler é›†ç¾¤çŠ¶å†µæ˜¯å¦è‰¯å¥½ï¼Ÿå¦‚æœéœ€è¦åˆ›å»ºæ–°çš„å®¹å™¨ï¼Œè¦å°†å®ƒä»¬æ”¾åœ¨å“ªé‡Œï¼Ÿè¿™äº›æ˜¯è°ƒåº¦ç¨‹åºéœ€è¦å…³æ³¨çš„é—®é¢˜ã€‚ schedulerè°ƒåº¦ç¨‹åºä¼šè€ƒè™‘å®¹å™¨é›†çš„èµ„æºéœ€æ±‚ï¼ˆä¾‹å¦‚ CPU æˆ–å†…å­˜ï¼‰ä»¥åŠé›†ç¾¤çš„è¿è¡ŒçŠ¶å†µã€‚éšåï¼Œå®ƒä¼šå°†å®¹å™¨é›†å®‰æ’åˆ°é€‚å½“çš„è®¡ç®—èŠ‚ç‚¹ã€‚ etcd etcd æ˜¯ä¸€ä¸ªé”®å€¼å¯¹æ•°æ®åº“ï¼Œç”¨äºå­˜å‚¨é…ç½®æ•°æ®å’Œé›†ç¾¤çŠ¶æ€ä¿¡æ¯ã€‚ kube-controller-manager æ§åˆ¶å™¨è´Ÿè´£å®é™…è¿è¡Œé›†ç¾¤ï¼Œcontroller-manager æ§åˆ¶å™¨ç®¡ç†å™¨åˆ™æ˜¯å°†å¤šä¸ªæ§åˆ¶å™¨åŠŸèƒ½åˆè€Œä¸ºä¸€ï¼Œé™ä½äº†ç¨‹åºçš„å¤æ‚æ€§ã€‚ controller-manager åŒ…å«äº†è¿™äº›æ§åˆ¶å™¨ï¼š èŠ‚ç‚¹æ§åˆ¶å™¨ï¼ˆNode Controllerï¼‰ï¼šè´Ÿè´£åœ¨èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶è¿›è¡Œé€šçŸ¥å’Œå“åº” ä»»åŠ¡æ§åˆ¶å™¨ï¼ˆJob Controllerï¼‰ï¼šç›‘æµ‹ä»£è¡¨ä¸€æ¬¡æ€§ä»»åŠ¡çš„ Job å¯¹è±¡ï¼Œç„¶ååˆ›å»º Pods æ¥è¿è¡Œè¿™äº›ä»»åŠ¡ç›´è‡³å®Œæˆ ç«¯ç‚¹æ§åˆ¶å™¨ï¼ˆEndpoints Controllerï¼‰ï¼šå¡«å……ç«¯ç‚¹ï¼ˆEndpointsï¼‰å¯¹è±¡ï¼ˆå³åŠ å…¥ Service ä¸ Podï¼‰ æœåŠ¡å¸æˆ·å’Œä»¤ç‰Œæ§åˆ¶å™¨ï¼ˆService Account & Token Controllersï¼‰ï¼šä¸ºæ–°çš„å‘½åç©ºé—´åˆ›å»ºé»˜è®¤å¸æˆ·å’Œ API è®¿é—®ä»¤ç‰Œ Node ç»„ä»¶ èŠ‚ç‚¹ç»„ä»¶ä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œè´Ÿè´£ç»´æŠ¤è¿è¡Œçš„ Pod å¹¶æä¾› Kubernetes è¿è¡Œç¯å¢ƒã€‚ kubelet kubelet ä¼šåœ¨é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ï¼ˆnodeï¼‰ä¸Šè¿è¡Œã€‚ å®ƒä¿è¯å®¹å™¨ï¼ˆcontainersï¼‰éƒ½è¿è¡Œåœ¨ Pod ä¸­ã€‚ å½“æ§åˆ¶å¹³é¢éœ€è¦åœ¨èŠ‚ç‚¹ä¸­æ‰§è¡ŒæŸä¸ªæ“ä½œæ—¶ï¼Œkubelet å°±ä¼šæ‰§è¡Œè¯¥æ“ä½œã€‚ kube-proxy kube-proxy æ˜¯é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ï¼ˆnodeï¼‰ä¸Šè¿è¡Œçš„ç½‘ç»œä»£ç†ï¼Œæ˜¯å®ç° Kubernetes æœåŠ¡ï¼ˆServiceï¼‰ æ¦‚å¿µçš„ä¸€éƒ¨åˆ†ã€‚ kube-proxy ç»´æŠ¤èŠ‚ç‚¹ç½‘ç»œè§„åˆ™å’Œè½¬å‘æµé‡ï¼Œå®ç°ä»é›†ç¾¤å†…éƒ¨æˆ–å¤–éƒ¨çš„ç½‘ç»œä¸ Pod è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚ å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰ è¿™ä¸ªåŸºç¡€ç»„ä»¶ä½¿ Kubernetes èƒ½å¤Ÿæœ‰æ•ˆè¿è¡Œå®¹å™¨ã€‚ å®ƒè´Ÿè´£ç®¡ç† Kubernetes ç¯å¢ƒä¸­å®¹å™¨çš„æ‰§è¡Œå’Œç”Ÿå‘½å‘¨æœŸã€‚ Kubernetes æ”¯æŒè®¸å¤šå®¹å™¨è¿è¡Œç¯å¢ƒï¼Œä¾‹å¦‚ containerdã€ docker ä»¥åŠ Kubernetes CRI (å®¹å™¨è¿è¡Œç¯å¢ƒæ¥å£) çš„å…¶ä»–ä»»ä½•å®ç°ã€‚ ç»„ä»¶å…³ç³» cloud-controller-manager æ§åˆ¶å¹³é¢è¿˜åŒ…å«ä¸€ä¸ªå¯é€‰ç»„ä»¶cloud-controller-managerã€‚ äº‘æ§åˆ¶å™¨ç®¡ç†å™¨ï¼ˆCloud Controller Managerï¼‰å…è®¸ä½ å°†ä½ çš„é›†ç¾¤è¿æ¥åˆ°äº‘æä¾›å•†çš„ API ä¹‹ä¸Šï¼Œ å¹¶å°†ä¸è¯¥äº‘å¹³å°äº¤äº’çš„ç»„ä»¶åŒä¸ä½ çš„é›†ç¾¤äº¤äº’çš„ç»„ä»¶åˆ†ç¦»å¼€æ¥ã€‚ å¦‚æœåœ¨è‡ªå·±çš„ç¯å¢ƒä¸­è¿è¡Œ Kubernetesï¼Œæˆ–è€…åœ¨æœ¬åœ°è®¡ç®—æœºä¸­è¿è¡Œå­¦ä¹ ç¯å¢ƒï¼Œ æ‰€éƒ¨ç½²çš„é›†ç¾¤ä¸éœ€è¦æœ‰äº‘æ§åˆ¶å™¨ç®¡ç†å™¨ã€‚ å‚è€ƒèµ„æ–™ï¼šhttps://kubernetes.io/zh-cn/docs/concepts/overview/components/ https://www.redhat.com/zh/topics/containers/kubernetes-architecture "},"base/minikube.html":{"url":"base/minikube.html","title":"å®‰è£… Minikube","keywords":"","body":"å®‰è£… Minikube docker-desktop æ–°ç‰ˆæœ¬è‡ªå¸¦äº† kubenetes, ä¸éœ€è¦ä½¿ç”¨ minikube äº†ã€‚ è‡ªå¸¦çš„å®‰è£…è¾ƒæ…¢å¯ä»¥ä½¿ç”¨ https://github.com/AliyunContainerService/k8s-for-docker-desktop å»å®‰è£… kubenetes å’Œ dashboard dashbord https://github.com/kubernetes/dashboard å®‰è£…å®˜æ–¹æ§åˆ¶å° kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml æŸ¥çœ‹æ˜¯å¦å…è®¸æˆåŠŸ $ kubectl get pods -A NAMESPACE NAME READY STATUS RESTARTS AGE kube-system coredns-5d78c9869d-tjhgv 1/1 Running 5 (7m45s ago) 2d22h kube-system coredns-5d78c9869d-vbzjn 1/1 Running 5 (7m45s ago) 2d22h kube-system etcd-docker-desktop 1/1 Running 5 (7m49s ago) 2d22h kube-system kube-apiserver-docker-desktop 1/1 Running 5 (7m40s ago) 2d22h kube-system kube-controller-manager-docker-desktop 1/1 Running 5 (7m50s ago) 2d22h kube-system kube-proxy-nrmkx 1/1 Running 5 (7m50s ago) 2d22h kube-system kube-scheduler-docker-desktop 1/1 Running 5 (7m50s ago) 2d22h kube-system storage-provisioner 1/1 Running 9 (6m28s ago) 2d22h kube-system vpnkit-controller 1/1 Running 5 (7m50s ago) 2d22h kubernetes-dashboard dashboard-metrics-scraper-5cb4f4bb9c-ws8sk 1/1 Running 1 (7m50s ago) 11m kubernetes-dashboard kubernetes-dashboard-6967859bff-5tvh6 1/1 Running 1 (7m50s ago) 11m ä»¥ä¸Šå 2 è¡Œå‡ºç°ä»£è¡¨æˆåŠŸ å¯ç”¨ dashboard kubectl proxy kubectl ä¼šä½¿å¾— Dashboard å¯ä»¥é€šè¿‡ http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/ è®¿é—®ã€‚ UI åªèƒ½ é€šè¿‡æ‰§è¡Œè¿™æ¡å‘½ä»¤çš„æœºå™¨è¿›è¡Œè®¿é—®ã€‚ ä»¥ä¸Šéœ€è¦è®¿é—®ä»¤ç‰Œ å‚è€ƒ https://github.com/AliyunContainerService/k8s-for-docker-desktop éƒ¨ç½²è®¿é—®ä»¤ç‰Œ æˆæƒ kube-system é»˜è®¤æœåŠ¡è´¦å· kubectl apply -f https://raw.githubusercontent.com/AliyunContainerService/k8s-for-docker-desktop/master/kube-system-default.yaml è·å– token windows $TOKEN=((kubectl -n kube-system describe secret default | Select-String \"token:\") -split \" +\")[1] kubectl config set-credentials docker-desktop --token=\"${TOKEN}\" echo $TOKEN or linux TOKEN=$(kubectl -n kube-system describe secret default| awk '$1==\"token:\"{print $2}') kubectl config set-credentials docker-desktop --token=\"${TOKEN}\" echo $TOKEN ç”Ÿæˆå¥½ååœ¨ä»¥ä¸‹è·¯å¾„ powershell: %UserProfile%\\.kube\\config or sh: $HOME/.kube/config "},"base/env_k3s.html":{"url":"base/env_k3s.html","title":"ä½¿ç”¨ K3s å¿«é€Ÿæ­å»ºé›†ç¾¤","keywords":"","body":"ä½¿ç”¨ K3s å¿«é€Ÿæ­å»ºé›†ç¾¤ æç¤ºï¼š 1.æœ¬è¯¾ç¨‹åŸºäºkubernetes V1.25ç‰ˆæœ¬ã€‚æç¤ºï¼š 2.ä»V1.24å¼€å§‹ï¼Œkubernetesé»˜è®¤å®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨containerdï¼Œä¸å†ä½¿ç”¨dockerã€‚ ä¸ºä»€ä¹ˆä½¿ç”¨ K3s K3s æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ã€å®Œå…¨å…¼å®¹çš„ Kubernetes å‘è¡Œç‰ˆæœ¬ã€‚éå¸¸é€‚åˆåˆå­¦è€…ã€‚ K3s å°†æ‰€æœ‰ Kubernetes æ§åˆ¶å¹³é¢ç»„ä»¶éƒ½å°è£…åœ¨å•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å’Œè¿›ç¨‹ä¸­ï¼Œæ–‡ä»¶å¤§å° æç¤ºï¼š K3så®Œå…¨å…¼å®¹kubernetesï¼ŒäºŒè€…çš„æ“ä½œæ˜¯ä¸€æ ·çš„ï¼Œä½¿ç”¨k3så®Œå…¨æ»¡è¶³æˆ‘ä»¬å­¦ä¹ kubernetesçš„è¦æ±‚ï¼Œè¯¾ç¨‹çš„æœ€åï¼Œæˆ‘ä»¬å†ä½¿ç”¨kubeadmå®‰è£…ä¸€ä¸ªå®Œæ•´çš„é›†ç¾¤ã€‚ ç¦»çº¿å®‰è£… K3s é›†ç¾¤ K3s é›†ç¾¤åˆ†ä¸º k3s Server(æ§åˆ¶å¹³é¢)å’Œ k3s Agent(å·¥ä½œèŠ‚ç‚¹)ã€‚æ‰€æœ‰çš„ç»„ä»¶éƒ½æ‰“åŒ…åœ¨å•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚ è¿è¡Œç¯å¢ƒ æœ€ä½è¿è¡Œè¦æ±‚ å†…å­˜: 512MB / CPU: 1 æ ¸å¿ƒ K3s ç‰ˆæœ¬ï¼šv1.25.0+k3s1 é›†ç¾¤è§„åˆ’ ä¸»æœºå IP åœ°å€ é…ç½® ç³»ç»Ÿ ç½‘ç»œ k8s-master 192.168.56.109 å†…å­˜ï¼š2GCPUï¼š2æ ¸ç¡¬ç›˜ï¼š20G CentOS7.9.2009æœ€å°åŒ–å®‰è£… äº’è”ç½‘:NATç½‘ç»œå†…éƒ¨ç½‘ç»œ: Host-only k8s-worker1 192.168.56.111 k8s-worker2 192.168.56.112 ps æ¯ä¸ªä¸»æœºéœ€è¦è®¾ç½® hostname k8s-master hostnamectl set-hostname k8s-master k8s-worker # k8s-worker1 hostnamectl set-hostname k8s-worker1 # k8s-worker2 hostnamectl set-hostname k8s-worker2 1.å‡†å¤‡å·¥ä½œ éœ€è¦åœ¨æ¯å°æœºå™¨ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š å…³é—­é˜²ç«å¢™ è®¾ç½® selinux(éœ€è¦è”ç½‘) systemctl disable firewalld --now yum install -y container-selinux selinux-policy-base yum install -y https://rpm.rancher.io/k3s/latest/common/centos/7/noarch/k3s-selinux-0.2-1.el7_8.noarch.rpm 2.ä¸‹è½½å®‰è£…åŒ… ä¸‹è½½å®‰è£…è„šæœ¬ install.shï¼šhttps://get.k3s.io/ ä¸‹è½½ k3s äºŒè¿›åˆ¶æ–‡ä»¶ï¼šk3s ä¸‹è½½å¿…è¦çš„ imageï¼šç¦»çº¿å®‰è£…éœ€è¦çš„ image æ–‡ä»¶ è¿™äº›æ–‡ä»¶éƒ½å¯ä»¥åœ¨githubä»“åº“ä¸­è·å–ï¼šhttps://github.com/k3s-io/k3s 3.æ‰§è¡Œå®‰è£…è„šæœ¬ å°†k3säºŒè¿›åˆ¶æ–‡ä»¶ç§»åŠ¨åˆ°/usr/local/bin ç›®å½•ï¼Œå¹¶æ·»åŠ æ‰§è¡Œæƒé™ mv k3s /usr/local/bin chmod +x /usr/local/bin/k3s å°†é•œåƒç§»åŠ¨åˆ°/var/lib/rancher/k3s/agent/images/ç›®å½•ï¼ˆæ— éœ€è§£å‹ï¼‰ mkdir -p /var/lib/rancher/k3s/agent/images/ cp ./k3s-airgap-images-amd64.tar.gz /var/lib/rancher/k3s/agent/images/ åœ¨k8s-masterèŠ‚ç‚¹æ‰§è¡Œï¼š #ä¿®æ”¹æƒé™ chmod +x install.sh #ç¦»çº¿å®‰è£… INSTALL_K3S_SKIP_DOWNLOAD=true ./install.sh #å®‰è£…å®Œæˆåï¼ŒæŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ kubectl get node #æŸ¥çœ‹token cat /var/lib/rancher/k3s/server/node-token #K10c4b79481685b50e4bca2513078f4e83b62d1d0b5f133a8a668b65c8f9249c53e::server:bf7b63be7f3471838cbafa12c1a1964d åœ¨k8s-worker1å’Œk8s-worker2èŠ‚ç‚¹æ‰§è¡Œ INSTALL_K3S_SKIP_DOWNLOAD=true \\ K3S_URL=https://192.168.56.109:6443 \\ K3S_TOKEN=K1012bdc3ffe7a5d89ecb125e56c38f9fe84a9f9aed6db605f7698fa744f2f2f12f::server:fdf33f4921dd607cadf2ae3c8eaf6ad9 \\ ./install.sh æ’æŸ¥é”™è¯¯ å¦‚æœå®‰è£…æˆ–å¯åŠ¨ä¸æˆåŠŸï¼Œå¯èƒ½æœ‰ä»¥ä¸‹å‡ ä¸ªåŸå› ï¼š 1. æ—¶é—´ä¸ç»Ÿä¸€ 2. IPæœ‰å†²çªï¼Œè¯·ä¸ºæ¯ä¸ªä¸»æœºåˆ†é…ä¸åŒçš„IP 3. ä¸»æœºå(hostname)é‡å¤ï¼Œè¯·ä¸ºæ¯ä¸ªä¸»æœºè®¾ç½®ä¸åŒçš„ä¸»æœºå 4. ç½‘å¡çš„MACæœ‰å†²çªï¼Œå¤åˆ¶è™šæ‹Ÿæœºæ—¶ï¼Œè¯·ä¸ºæ‰€æœ‰ç½‘å¡é‡æ–°ç”Ÿäº§MACåœ°å€ å‚è€ƒæ–‡æ¡£ï¼š https://k3s.io/ https://rancher.com/docs/k3s/latest/en/ https://rancher.com/docs/k3s/latest/en/quick-start/ https://rancher.com/docs/k3s/latest/en/installation/airgap/ "},"base/pod.html":{"url":"base/pod.html","title":"Pod(å®¹å™¨é›†)","keywords":"","body":"Pod(å®¹å™¨é›†) Pod Pod æ˜¯åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„å®¹å™¨ç»„ï¼Œæ˜¯ Kubernetes ä¸­åˆ›å»ºå’Œç®¡ç†çš„æœ€å°å¯¹è±¡ã€‚ Pod æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š Pod æ˜¯ kubernetes ä¸­ æœ€å°çš„è°ƒåº¦å•ä½ï¼ˆåŸå­å•å…ƒï¼‰ï¼ŒKubernetes ç›´æ¥ç®¡ç† Pod è€Œä¸æ˜¯å®¹å™¨ã€‚ åŒä¸€ä¸ª Pod ä¸­çš„å®¹å™¨æ€»æ˜¯ä¼šè¢«è‡ªåŠ¨å®‰æ’åˆ°é›†ç¾¤ä¸­çš„ åŒä¸€èŠ‚ç‚¹ï¼ˆç‰©ç†æœºæˆ–è™šæ‹Ÿæœºï¼‰ä¸Šï¼Œå¹¶ä¸”ä¸€èµ·è°ƒåº¦ã€‚ Pod å¯ä»¥ç†è§£ä¸ºè¿è¡Œç‰¹å®šåº”ç”¨çš„â€œé€»è¾‘ä¸»æœºâ€ï¼Œè¿™äº›å®¹å™¨å…±äº«å­˜å‚¨ã€ç½‘ç»œå’Œé…ç½®å£°æ˜(å¦‚èµ„æºé™åˆ¶)ã€‚ æ¯ä¸ª Pod æœ‰å”¯ä¸€çš„ IP åœ°å€ã€‚ IP åœ°å€åˆ†é…ç»™ Podï¼Œåœ¨åŒä¸€ä¸ª Pod å†…ï¼Œæ‰€æœ‰å®¹å™¨å…±äº«ä¸€ä¸ª IP åœ°å€å’Œç«¯å£ç©ºé—´ï¼ŒPod å†…çš„å®¹å™¨å¯ä»¥ä½¿ç”¨ localhost äº’ç›¸é€šä¿¡ã€‚ ä¾‹å¦‚ï¼Œä½ å¯èƒ½æœ‰ä¸€ä¸ªå®¹å™¨ï¼Œä¸ºå…±äº«å·ä¸­çš„æ–‡ä»¶æä¾› Web æœåŠ¡å™¨æ”¯æŒï¼Œä»¥åŠä¸€ä¸ªå•ç‹¬çš„ \"è¾¹è½¦ (sidercar)\" å®¹å™¨è´Ÿè´£ä»è¿œç«¯æ›´æ–°è¿™äº›æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š åˆ›å»ºå’Œç®¡ç† Pod # åˆ›å»º mynginx pod å¹¶ä½¿ç”¨å®¹å™¨é•œåƒ nginx çš„ 1.22 ç‰ˆæœ¬ kubectl run mynginx --image=nginx:1.22 # æŸ¥çœ‹Pod kubectl get pod # æŸ¥çœ‹podæ—¥å¿— kubectl logs -f mynginx # æŸ¥çœ‹podæè¿°ä¿¡æ¯ kubectl describe pod mynginx è®¿é—® pod # æŸ¥çœ‹Podè¯¦ç»†ä¿¡æ¯(åŒ…å«IPå’Œè¿è¡ŒèŠ‚ç‚¹ä¿¡æ¯) $ kubectl get pod -owide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES mynginx 1/1 Running 0 14m 10.42.2.5 k3d-demo-server-0 è·å–åˆ°è®¿é—®çš„å†…å®¹ # ä½¿ç”¨Podçš„ip+podé‡Œé¢è¿è¡Œå®¹å™¨çš„ç«¯å£ curl 10.42.2.5 # æˆ–ä½¿ç”¨ wget wget -qO- http://10.42.2.5 å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤ #åœ¨å®¹å™¨ä¸­æ‰§è¡Œ kubectl exec mynginx -it -- /bin/bash #è¿›å…¥å®¹å™¨è®¿é—®è‡ªèº« curl localhost è¿è¡Œ podï¼Œé€€å‡ºåè‡ªåŠ¨åˆ é™¤å®¹å™¨ # è¿è¡Œ busybox å®¹å™¨ kubectl run my-busybox --image=busybox -ti --rm # ping ä¸»æœºip ping {{host_ip}} # é€€å‡º exit # å‘ç° pod å·²ä¸å­˜åœ¨ kubectl get pod åˆ é™¤å®¹å™¨ # åˆ é™¤ mynginx kubectl delete pod mynginx # å¼ºåˆ¶åˆ é™¤ kubectl delete pod mynginx --force watch æ¨¡å¼ kubectl get pod --watch é•œåƒåŠ é€Ÿ ç”±äº kubernetes ä»V1.24ç‰ˆæœ¬å¼€å§‹é»˜è®¤ä½¿ç”¨containerdï¼Œéœ€è¦ä¿®æ”¹containerdçš„é…ç½®æ–‡ä»¶ï¼Œæ‰èƒ½è®© Pod çš„é•œåƒä½¿ç”¨é•œåƒåŠ é€Ÿå™¨ã€‚ é…ç½®æ–‡ä»¶è·¯å¾„ä¸€èˆ¬ä¸º/etc/containerd/config.tomlï¼Œè¯¦è§é˜¿é‡Œäº‘é•œåƒåŠ é€Ÿã€‚ åœ¨ K3s ä¸­é…ç½®é•œåƒä»“åº“ K3s ä¼šè‡ªåŠ¨ç”Ÿæˆ containerd çš„é…ç½®æ–‡ä»¶/var/lib/rancher/k3s/agent/etc/containerd/config.toml,ä¸è¦ç›´æ¥ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶ï¼Œk3s é‡å¯åä¿®æ”¹ä¼šä¸¢å¤±ã€‚ ä¸ºäº†ç®€åŒ–é…ç½®ï¼ŒK3s é€šè¿‡/etc/rancher/k3s/registries.yamlæ–‡ä»¶æ¥é…ç½®é•œåƒä»“åº“ï¼ŒK3s ä¼šåœ¨å¯åŠ¨æ—¶æ£€æŸ¥è¿™ä¸ªæ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚ æˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ–°å»º/etc/rancher/k3s/registries.yamlæ–‡ä»¶ï¼Œé…ç½®å†…å®¹å¦‚ä¸‹ï¼š mirrors: docker.io: endpoint: - \"https://fsp2sfpr.mirror.aliyuncs.com/\" é‡å¯æ¯ä¸ªèŠ‚ç‚¹ systemctl restart k3s systemctl restart k3s-agent æŸ¥çœ‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆã€‚ cat /var/lib/rancher/k3s/agent/etc/containerd/config.toml å®¹å™¨ä¸é•œåƒ å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰ Kubelet è¿è¡Œåœ¨æ¯ä¸ªèŠ‚ç‚¹(Node)ä¸Š,ç”¨äºç®¡ç†å’Œç»´æŠ¤ Pod å’Œå®¹å™¨çš„çŠ¶æ€ã€‚ å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰æ˜¯ kubelet å’Œå®¹å™¨è¿è¡Œæ—¶ä¹‹é—´é€šä¿¡çš„ä¸»è¦åè®®ã€‚å®ƒå°† Kubelet ä¸å®¹å™¨è¿è¡Œæ—¶è§£è€¦ï¼Œç†è®ºä¸Šï¼Œå®ç°äº† CRI æ¥å£çš„å®¹å™¨å¼•æ“ï¼Œéƒ½å¯ä»¥ä½œä¸º kubernetes çš„å®¹å™¨è¿è¡Œæ—¶ã€‚ Dockeræ²¡æœ‰å®ç°ï¼ˆCRIï¼‰æ¥å£ï¼ŒKubernetesä½¿ç”¨dockershimæ¥å…¼å®¹dockerã€‚ è‡ªV1.24ç‰ˆæœ¬èµ·ï¼ŒDockershim å·²ä» Kubernetes é¡¹ç›®ä¸­ç§»é™¤ã€‚ crictlæ˜¯ä¸€ä¸ªå…¼å®¹ CRI çš„å®¹å™¨è¿è¡Œæ—¶å‘½ä»¤ï¼Œä»–çš„ç”¨æ³•è·Ÿ docker å‘½ä»¤ä¸€æ ·ï¼Œå¯ä»¥ç”¨æ¥æ£€æŸ¥å’Œè°ƒè¯•åº•å±‚çš„è¿è¡Œæ—¶å®¹å™¨ã€‚ æŸ¥çœ‹å®¹å™¨å’Œé•œåƒ # æŸ¥çœ‹å®¹å™¨ $ crictl ps CONTAINER IMAGE CREATED STATE NAME ATTEMPT POD ID POD 47aaa00baba1e 0f8498f13f3ad 7 hours ago Running nginx 0 ad79f75bc4e04 nginx-deploy-5964889c54-fkd8t 2c47bdd5aaa26 ead0a4a53df89 3 days ago Running coredns 10 05fbcfa8067b8 coredns-77ccd57875-rf6s4 f1bcf4785b184 af74bd845c4a8 3 days ago Running lb-tcp-443 1 d793ffcccf6fe svclb-traefik-c090484e-cnsgm 2cc1af75acf27 af74bd845c4a8 3 days ago Running lb-tcp-80 1 d793ffcccf6fe svclb-traefik-c090484e-cnsgm # æŸ¥çœ‹é•œåƒ $ crictl images IMAGE TAG IMAGE ID SIZE docker.io/library/nginx 1.22 0f8498f13f3ad 57MB docker.io/library/nginx 1.23 a7be6198544f0 57MB docker.io/rancher/klipper-helm v0.8.0-build20230510 6f42df210d7fa 95MB docker.io/rancher/klipper-lb v0.4.4 af74bd845c4a8 4.92MB docker.io/rancher/mirrored-coredns-coredns 1.10.1 ead0a4a53df89 16.2MB docker.io/rancher/mirrored-pause 3.6 6270bb605e12e 301kB crictl å‘½ä»¤ å‘½ä»¤ç›¸å¯¹ docker å°‘ä¸€äº›ï¼Œæ¯”å¦‚æ— æ³•å¯¼å…¥å¯¼å‡ºé•œåƒ $ crictl -h NAME: crictl - client for CRI USAGE: crictl [global options] command [command options] [arguments...] VERSION: v1.26.0-rc.0-k3s1 COMMANDS: attach Attach to a running container create Create a new container exec Run a command in a running container version Display runtime version information images, image, img List images inspect Display the status of one or more containers inspecti Return the status of one or more images imagefsinfo Return image filesystem info inspectp Display the status of one or more pods logs Fetch the logs of a container port-forward Forward local port to a pod ps List containers pull Pull an image from a registry run Run a new container inside a sandbox runp Run a new pod rm Remove one or more containers rmi Remove one or more images rmp Remove one or more pods pods List pods start Start one or more created containers info Display information of the container runtime stop Stop one or more running containers stopp Stop one or more running pods update Update one or more running containers config Get and set crictl client configuration options stats List container(s) resource usage statistics statsp List pod resource usage statistics completion Output shell completion code checkpoint Checkpoint one or more running containers help, h Shows a list of commands or help for one command GLOBAL OPTIONS: --config value, -c value Location of the client config file. If not specified and the default does not exist, the program's directory is searched as well (default: \"/etc/crictl.yaml\") [$CRI_CONFIG_FILE] --debug, -D Enable debug mode (default: false) --image-endpoint value, -i value Endpoint of CRI image manager service (default: uses 'runtime-endpoint' setting) [$IMAGE_SERVICE_ENDPOINT] --runtime-endpoint value, -r value Endpoint of CRI container runtime service (default: uses in order the first successful one of [unix:///run/k3s/containerd/containerd.sock unix:///var/run/dockershim.sock unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock]). Default is now deprecated and the endpoint should be set instead. [$CONTAINER_RUNTIME_ENDPOINT] --timeout value, -t value Timeout of connecting to the server in seconds (e.g. 2s, 20s.). 0 or less is set to default (default: 2s) --help, -h show help (default: false) --version, -v print the version (default: false) åœ¨ä¸€äº›å±€åŸŸç½‘ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬æ²¡æ³•é€šè¿‡äº’è”ç½‘æ‹‰å–é•œåƒï¼Œå¯ä»¥æ‰‹åŠ¨çš„å¯¼å‡ºã€å¯¼å…¥é•œåƒã€‚ crictl å‘½ä»¤æ²¡æœ‰å¯¼å‡ºã€å¯¼å…¥é•œåƒçš„åŠŸèƒ½ã€‚ éœ€è¦ä½¿ç”¨ ctr å‘½ä»¤å¯¼å‡ºã€å¯¼å…¥é•œåƒï¼Œå®ƒæ˜¯ containerd çš„å‘½ä»¤è¡Œæ¥å£ã€‚ # åªéœ€è¦æŒæ¡å¯¼å…¥å¯¼å‡ºé•œåƒå³å¯ $ ctr -h NAME: ctr - __ _____/ /______ / ___/ __/ ___/ / /__/ /_/ / \\___/\\__/_/ containerd CLI USAGE: ctr [global options] command [command options] [arguments...] VERSION: v1.7.1-k3s1 DESCRIPTION: ctr is an unsupported debug and administrative client for interacting with the containerd daemon. Because it is unsupported, the commands, options, and operations are not guaranteed to be backward compatible or stable from release to release of the containerd project. COMMANDS: plugins, plugin Provides information about containerd plugins version Print the client and server versions containers, c, container Manage containers content Manage content events, event Display containerd events images, image, i Manage images leases Manage leases namespaces, namespace, ns Manage namespaces pprof Provide golang pprof outputs for containerd run Run a container snapshots, snapshot Manage snapshots tasks, t, task Manage tasks install Install a new package oci OCI tools sandboxes, sandbox, sb, s Manage sandboxes info Print the server info shim Interact with a shim directly help, h Shows a list of commands or help for one command GLOBAL OPTIONS: --debug Enable debug output in logs --address value, -a value Address for containerd's GRPC server (default: \"/run/k3s/containerd/containerd.sock\") [$CONTAINERD_ADDRESS] --timeout value Total timeout for ctr commands (default: 0s) --connect-timeout value Timeout for connecting to containerd (default: 0s) --namespace value, -n value Namespace to use with commands (default: \"k8s.io\") [$CONTAINERD_NAMESPACE] --help, -h show help --version, -v print the version ä»dockerå¯¼å‡ºé•œåƒå†å¯¼å…¥åˆ°containerdä¸­ $ docker pull alpine:3.15 $ docker save alpine:3.15 > alpine-3.15.tar # å°†taræ‹·è´åˆ°å¯¹åº”k8sä¸»æœº #kubernetesä½¿ç”¨çš„é•œåƒéƒ½åœ¨k8s.ioå‘½åç©ºé—´ä¸­, éœ€è¦åˆ¶å®šå¯¹åº”å¹³å°ï¼Œå¦‚linux/amd64 $ ctr -n k8s.io images import alpine-3.15.tar --platform linux/amd64 unpacking docker.io/library/alpine:3.15 (sha256:69ba0f584ebec4ccf2ccf44817931f3facfb924380355466495274b2e273fe7b)...done # å¯ä»¥çœ‹åˆ°é•œåƒå¯¼å…¥äº† $ crictl images IMAGE TAG IMAGE ID SIZE docker.io/library/alpine 3.15 d51a1e6a80db9 5.87MB ã€‚ã€‚ã€‚ ä»containerdå¯¼å‡ºã€å¯¼å…¥é•œåƒ #å¯¼å‡ºé•œåƒ ctr -n k8s.io images export alpine.tar docker.io/library/alpine:3.15 --platform linux/amd64 å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/zh-cn/docs/concepts/workloads/pods/ https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/crictl/ https://docs.k3s.io/installation/private-registry "},"base/deployment_replicaset.html":{"url":"base/deployment_replicaset.html","title":"Deployment(éƒ¨ç½²)ä¸ ReplicaSet(å‰¯æœ¬é›†)","keywords":"","body":"Deployment(éƒ¨ç½²)ä¸ ReplicaSet(å‰¯æœ¬é›†) Deploymentæ˜¯å¯¹ ReplicaSet å’Œ Pod æ›´é«˜çº§çš„æŠ½è±¡ã€‚ å®ƒä½¿ Pod æ‹¥æœ‰å¤šå‰¯æœ¬ï¼Œè‡ªæ„ˆï¼Œæ‰©ç¼©å®¹ã€æ»šåŠ¨å‡çº§ç­‰èƒ½åŠ›ã€‚ ReplicaSet(å‰¯æœ¬é›†)æ˜¯ä¸€ä¸ª Pod çš„é›†åˆã€‚ å®ƒå¯ä»¥è®¾ç½®è¿è¡Œ Pod çš„æ•°é‡ï¼Œç¡®ä¿ä»»ä½•æ—¶é—´éƒ½æœ‰æŒ‡å®šæ•°é‡çš„ Pod å‰¯æœ¬åœ¨è¿è¡Œã€‚ é€šå¸¸æˆ‘ä»¬ä¸ç›´æ¥ä½¿ç”¨ ReplicaSetï¼Œè€Œæ˜¯åœ¨ Deployment ä¸­å£°æ˜ã€‚ #åˆ›å»ºdeployment,éƒ¨ç½²3ä¸ªè¿è¡Œnginxçš„Pod $ kubectl create deployment nginx-deploy --image=nginx:1.22 --replicas=3 #æŸ¥çœ‹deployment(ç¼©å†™æˆdeploy) $ kubectl get deploy # æŸ¥çœ‹pod $ kubectl get pod NAME READY STATUS RESTARTS AGE nginx-deploy-5964889c54-zmk6p 1/1 Running 0 6m1s nginx-deploy-5964889c54-th9f8 1/1 Running 0 6m1s nginx-deploy-5964889c54-28689 1/1 Running 0 6m1s #æŸ¥çœ‹replicaSet(ç¼©å†™ä¸ºrs) $ kubectl get replicaSet NAME DESIRED CURRENT READY AGE nginx-deploy-5964889c54 3 3 3 7m13s å¯ä»¥çœ‹åˆ° 5964889c54 ä¸ºå‰¯æœ¬é›† ï¼Œ æœ‰ 3 ä¸ª pod åˆ†åˆ«ä¸º zmk6pã€th9f8ã€28689 åˆ é™¤æœ€åä¸€ä¸ª pod ä¼šå†ç”Ÿæˆæ–°çš„ pod $ kubectl delete pod nginx-deploy-5964889c54-28689 pod \"nginx-deploy-5964889c54-28689\" deleted # å¯ä»¥çœ‹åˆ°ç”Ÿæˆäº†æ–°çš„pod k9xnjï¼Œä½“ç°äº† deploy ä½¿podæ‹¥æœ‰çš„è‡ªæ„ˆèƒ½åŠ› $ kubectl get pod NAME READY STATUS RESTARTS AGE nginx-deploy-5964889c54-zmk6p 1/1 Running 0 9m29s nginx-deploy-5964889c54-th9f8 1/1 Running 0 9m29s nginx-deploy-5964889c54-k9xnj 1/1 Running 0 13s ç¼©æ”¾ æ‰‹åŠ¨ç¼©æ”¾ # å‰¯æœ¬æ‰©å®¹åˆ°5ä¸ª $ kubectl scale deploy nginx-deploy --replicas=5 æ‰©å®¹è¿‡ç¨‹ # DESIRED ç›®æ ‡ CURRENT å½“å‰ READY å‡†å¤‡å°±ç»ª $ kubectl get rs --watch NAME DESIRED CURRENT READY AGE nginx-deploy-5964889c54 3 3 3 12m nginx-deploy-5964889c54 5 3 3 13m // Step A nginx-deploy-5964889c54 5 3 3 13m nginx-deploy-5964889c54 5 4 3 13m // Step B nginx-deploy-5964889c54 5 5 3 13m // Step C nginx-deploy-5964889c54 5 5 4 13m // Step D nginx-deploy-5964889c54 5 5 5 13m // Step E å¯ä»¥çœ‹åˆ°åœ¨è§‚æµ‹å‰¯æœ¬æ—¶è¿‡ç¨‹ æ‰§è¡Œäº†æ‰©å®¹å DESIRED å°±å˜æˆäº† 5 (Step A) CURRENT å˜æˆ 4ï¼Œ è¯æ˜ å¯åŠ¨äº†ä¸€ä¸ª podï¼ŒREADY è¿˜æ˜¯ 3ï¼Œ è¯´æ˜è¿˜æ²¡å¯åŠ¨å®Œæˆ (Step B) CURRENT å˜æˆ 5ï¼Œ è¯æ˜ åˆå¯åŠ¨äº†ä¸€ä¸ª podï¼ŒREADY è¿˜æ˜¯ 3ï¼Œ è¯´æ˜è¿˜æ²¡å¯åŠ¨å®Œæˆ (Step C) READY å˜æˆäº† 4ï¼Œ è¯´æ˜æˆåŠŸè¿è¡Œäº†ä¸€ä¸ª pod (Step D) READY å˜æˆäº† 5ï¼Œ è¯´æ˜åˆæˆåŠŸè¿è¡Œäº†ä¸€ä¸ª pod, è¿™æ · READY å’Œ DESIRED ç›¸ç­‰ï¼Œæ‰©å®¹å®Œæˆ (Step D) è°ƒæ•´å›å» $ kubectl scale deploy nginx-deploy --replicas=3 è¿‡ç¨‹ $ kubectl get rs --watch NAME DESIRED CURRENT READY AGE nginx-deploy-5964889c54 5 5 5 27m nginx-deploy-5964889c54 3 5 5 28m nginx-deploy-5964889c54 3 5 5 28m nginx-deploy-5964889c54 3 3 3 28m è‡ªåŠ¨ç¼©æ”¾ è‡ªåŠ¨ç¼©æ”¾é€šè¿‡å¢åŠ å’Œå‡å°‘å‰¯æœ¬çš„æ•°é‡ï¼Œä»¥ä¿æŒæ‰€æœ‰ Pod çš„å¹³å‡ CPU åˆ©ç”¨ç‡ä¸è¶…è¿‡ 75%ã€‚ è‡ªåŠ¨ä¼¸ç¼©éœ€è¦å£°æ˜ Pod çš„èµ„æºé™åˆ¶ï¼ŒåŒæ—¶ä½¿ç”¨ Metrics Server æœåŠ¡ï¼ˆK3s é»˜è®¤å·²å®‰è£…ï¼‰ã€‚ æœ¬ä¾‹ä»…ç”¨æ¥è¯´æ˜kubectl autoscaleå‘½ä»¤çš„ä½¿ç”¨ï¼Œå®Œæ•´ç¤ºä¾‹å‚è€ƒï¼šHPAæ¼”ç¤º #è‡ªåŠ¨ç¼©æ”¾ kubectl autoscale deployment/nginx-auto --min=3 --max=10 --cpu-percent=75 #æŸ¥çœ‹è‡ªåŠ¨ç¼©æ”¾ kubectl get hpa #åˆ é™¤è‡ªåŠ¨ç¼©æ”¾ kubectl delete hpa nginx-deployment æ»šåŠ¨æ›´æ–° è®¾ç½®é•œåƒä¸º 1.23 $ kubectl set image deploy/nginx-deploy nginx=nginx:1.23 # æŸ¥çœ‹æ»šåŠ¨æ›´æ–°çŠ¶æ€ $ kubectl rollout status deployment/nginx-deploy deployment \"nginx-deploy\" successfully rolled out æŸ¥çœ‹æ›´æ–°åçš„ç‰ˆæœ¬å’Œ pod $ kubectl get deploy/nginx-deploy -owide NAME READY UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTOR nginx-deploy 3/3 3 3 39m nginx nginx:1.23 app=nginx-deploy è¿‡ç¨‹åŠè¯´æ˜ $ kubectl get rs --watch NAME DESIRED CURRENT READY AGE nginx-deploy-5964889c54 3 3 3 35m nginx-deploy-7c88b8c7c9 1 0 0 0s // Step 1 nginx-deploy-7c88b8c7c9 1 0 0 0s nginx-deploy-7c88b8c7c9 1 1 0 0s // Step 2 nginx-deploy-7c88b8c7c9 1 1 1 22s // Step 3 nginx-deploy-5964889c54 2 3 3 37m // Step 4 nginx-deploy-5964889c54 2 3 3 37m nginx-deploy-5964889c54 2 2 2 37m // Step 5 nginx-deploy-7c88b8c7c9 2 1 1 23s // Step 6 nginx-deploy-7c88b8c7c9 2 1 1 23s nginx-deploy-7c88b8c7c9 2 2 1 23s nginx-deploy-7c88b8c7c9 2 2 2 43s // Step 7 nginx-deploy-5964889c54 1 2 2 37m nginx-deploy-7c88b8c7c9 3 2 2 43s nginx-deploy-5964889c54 1 2 2 37m nginx-deploy-5964889c54 1 1 1 37m nginx-deploy-7c88b8c7c9 3 2 2 43s nginx-deploy-7c88b8c7c9 3 3 2 43s nginx-deploy-7c88b8c7c9 3 3 3 63s nginx-deploy-5964889c54 0 1 1 37m nginx-deploy-5964889c54 0 1 1 37m nginx-deploy-5964889c54 0 0 0 37m å¯ä»¥çœ‹åˆ° 7c88b8c7c9 ä¸ºæ–°éƒ¨ç½² nginx çš„ deployï¼Œ 5964889c54 ä¸º ä¹‹å‰éƒ¨ç½²çš„ nginx çš„ deploy step: æ–° deploy ç›®æ ‡ä¸º 1 ä¸ª podï¼Œå½“å‰å’Œå°±ç»ªä¸º 0 æ–° deploy 1 ä¸ªæ­£åœ¨ å¯åŠ¨ æ–° deploy æˆåŠŸå¯åŠ¨ 1 ä¸ª æ—§ deploy å‡†å¤‡å‡å°‘ä¸€ä¸ª æ—§ deploy å‡å°‘ä¸€ä¸ªå®Œæˆ æ–° deploy å‡†å¤‡å†èµ· 1 ä¸ª pod æ–° deploy æˆåŠŸåˆå¯åŠ¨äº† 1 ä¸ª pod åç»­æ­¥éª¤åŒç†ç›´åˆ° æ–° deploy æ»¡è¶³è¦æ±‚ æ—§ deploy åœæ­¢æ‰€æœ‰ podï¼Œå‰¯æœ¬é›†æ¸… 0 ç‰ˆæœ¬å›æ»š #æŸ¥çœ‹å†å²ç‰ˆæœ¬ $ kubectl rollout history deployment/nginx-deploy deployment.apps/nginx-deploy REVISION CHANGE-CAUSE 1 2 # æŸ¥çœ‹ç‰ˆæœ¬1è¯¦æƒ… 5964889c54 ä¸ºç‰ˆæœ¬1 hashå€¼ $ kubectl rollout history deployment/nginx-deploy --revision=1 deployment.apps/nginx-deploy with revision #1 Pod Template: Labels: app=nginx-deploy pod-template-hash=5964889c54 Containers: nginx: Image: nginx:1.22 Port: Host Port: Environment: Mounts: Volumes: #å›æ»šåˆ°å†å²ç‰ˆæœ¬ $ kubectl rollout undo deployment/nginx-deploy --to-revision=1 deployment.apps/nginx-deploy rolled back å›æ»šè¿‡ç¨‹ $ kubectl get rs --watch NAME DESIRED CURRENT READY AGE nginx-deploy-7c88b8c7c9 3 3 3 20m nginx-deploy-5964889c54 0 0 0 57m nginx-deploy-5964889c54 0 0 0 57m nginx-deploy-5964889c54 1 0 0 57m nginx-deploy-5964889c54 1 0 0 57m nginx-deploy-5964889c54 1 1 0 57m nginx-deploy-5964889c54 1 1 1 57m nginx-deploy-7c88b8c7c9 2 3 3 21m nginx-deploy-7c88b8c7c9 2 3 3 21m nginx-deploy-5964889c54 2 1 1 57m nginx-deploy-7c88b8c7c9 2 2 2 21m nginx-deploy-5964889c54 2 1 1 57m nginx-deploy-5964889c54 2 2 1 57m nginx-deploy-5964889c54 2 2 2 57m nginx-deploy-7c88b8c7c9 1 2 2 21m nginx-deploy-5964889c54 3 2 2 57m nginx-deploy-7c88b8c7c9 1 2 2 21m nginx-deploy-7c88b8c7c9 1 1 1 21m nginx-deploy-5964889c54 3 2 2 57m nginx-deploy-5964889c54 3 3 2 57m nginx-deploy-5964889c54 3 3 3 57m nginx-deploy-7c88b8c7c9 0 1 1 21m nginx-deploy-7c88b8c7c9 0 1 1 21m nginx-deploy-7c88b8c7c9 0 0 0 21m æŸ¥çœ‹å›æ»šåçš„çŠ¶æ€ # æŸ¥çœ‹å‰¯æœ¬é›†çŠ¶æ€ $ kubectl get rs NAME DESIRED CURRENT READY AGE nginx-deploy-5964889c54 3 3 3 59m nginx-deploy-7c88b8c7c9 0 0 0 22m # æŸ¥çœ‹podçŠ¶æ€ï¼Œå‘ç°å‰¯æœ¬é›†å›æ»šäº† $ kubectl get pod NAME READY STATUS RESTARTS AGE nginx-deploy-5964889c54-fkd8t 1/1 Running 0 2m31s nginx-deploy-5964889c54-lnd79 1/1 Running 0 2m30s nginx-deploy-5964889c54-tfdf7 1/1 Running 0 2m28s åˆ é™¤æ— ç”¨å‰¯æœ¬é›† $ kubectl delete rs nginx-deploy-7c88b8c7c9 replicaset.apps \"nginx-deploy-7c88b8c7c9\" deleted å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/replicaset/ https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/ https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/ "},"base/service.html":{"url":"base/service.html","title":"Service(æœåŠ¡)","keywords":"","body":"Service(æœåŠ¡) Service å°†è¿è¡Œåœ¨ä¸€ç»„ Pods ä¸Šçš„åº”ç”¨ç¨‹åºå…¬å¼€ä¸ºç½‘ç»œæœåŠ¡çš„æŠ½è±¡æ–¹æ³•ã€‚ Service ä¸ºä¸€ç»„ Pod æä¾›ç›¸åŒçš„ DNS åï¼Œå¹¶ä¸”åœ¨å®ƒä»¬ä¹‹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚ Kubernetes ä¸º Pod æä¾›åˆ†é…äº† IP åœ°å€ï¼Œä½† IP åœ°å€å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚ é›†ç¾¤å†…çš„å®¹å™¨å¯ä»¥é€šè¿‡ service åç§°è®¿é—®æœåŠ¡ï¼Œè€Œä¸éœ€è¦æ‹…å¿ƒ Pod çš„ IP å‘ç”Ÿå˜åŒ–ã€‚ Kubernetes Service å®šä¹‰äº†è¿™æ ·ä¸€ç§æŠ½è±¡ï¼š é€»è¾‘ä¸Šçš„ä¸€ç»„å¯ä»¥äº’ç›¸æ›¿æ¢çš„ Podï¼Œé€šå¸¸ç§°ä¸ºå¾®æœåŠ¡ã€‚ Service å¯¹åº”çš„ Pod é›†åˆé€šå¸¸æ˜¯é€šè¿‡é€‰æ‹©ç®—ç¬¦æ¥ç¡®å®šçš„ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸€ä¸ª Service ä¸­è¿è¡Œäº† 3 ä¸ª nginx çš„å‰¯æœ¬ã€‚è¿™äº›å‰¯æœ¬æ˜¯å¯äº’æ¢çš„ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒå®ƒä»¬è°ƒç”¨äº†å“ªä¸ª nginxï¼Œä¹Ÿä¸éœ€è¦å…³æ³¨ Pod çš„è¿è¡ŒçŠ¶æ€ï¼Œåªéœ€è¦è°ƒç”¨è¿™ä¸ªæœåŠ¡å°±å¯ä»¥äº†ã€‚ # æŸ¥çœ‹æ‰€æœ‰ $ kubectl get all NAME READY STATUS RESTARTS AGE pod/nginx-deploy-5964889c54-fkd8t 1/1 Running 0 8m37s pod/nginx-deploy-5964889c54-lnd79 1/1 Running 0 8m36s pod/nginx-deploy-5964889c54-tfdf7 1/1 Running 0 8m34s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/kubernetes ClusterIP 10.43.0.1 443/TCP 4d12h NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-deploy 3/3 3 3 66m NAME DESIRED CURRENT READY AGE replicaset.apps/nginx-deploy-5964889c54 3 3 3 66m replicaset.apps/nginx-deploy-7c88b8c7c9 0 0 0 29m # æ˜ å°„ pod å®¹å™¨ç«¯å£åˆ°æœåŠ¡å™¨ç«¯å£ $ kubectl expose deploy/nginx-deploy --name=nginx-service --port=8080 --target-port=80 service/nginx-service exposed # æŸ¥çœ‹service $ kubectl get service NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 443/TCP 4d12h nginx-service ClusterIP 10.43.146.225 8080/TCP 61s # é€šè¿‡ipè®¿é—®å¯¹åº”ç«¯å£ $ wget -qO- http://10.43.146.225:8080 Welcome to nginx! html { color-scheme: light dark; } body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } Welcome to nginx! If you see this page, the nginx web server is successfully installed and working. Further configuration is required. For online documentation and support please refer to nginx.org. Commercial support is available at nginx.com. Thank you for using nginx. é›†ç¾¤å†…éƒ¨å¯ä»¥é€šè¿‡ service åç§°+ ç«¯å£è®¿é—® # åˆ›å»ºä¸€æ¬¡æ€§çš„å†…éƒ¨pod æ¥æµ‹è¯• $ kubectl run test -ti --image=nginx:1.22 --rm -- bash If you don't see a command prompt, try pressing enter. # æµ‹è¯•è®¿é—®å†…éƒ¨ root@test:/# curl nginx-service:8080 Welcome to nginx! html { color-scheme: light dark; } body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } Welcome to nginx! If you see this page, the nginx web server is successfully installed and working. Further configuration is required. For online documentation and support please refer to nginx.org. Commercial support is available at nginx.com. Thank you for using nginx. æŸ¥çœ‹ service ä¿¡æ¯ # å¯ä»¥çœ‹åˆ°å¯¹åº”IP å’Œ åç«¯ç«¯ç‚¹ $ kubectl describe service nginx-service Name: nginx-service Namespace: default Labels: app=nginx-deploy Annotations: Selector: app=nginx-deploy Type: ClusterIP IP Family Policy: SingleStack IP Families: IPv4 IP: 10.43.146.225 IPs: 10.43.146.225 Port: 8080/TCP TargetPort: 80/TCP Endpoints: 10.42.0.8:80,10.42.1.10:80,10.42.2.9:80 Session Affinity: None Events: # è·å–podä¿¡æ¯ $ kubectl get pod NAME READY STATUS RESTARTS AGE nginx-deploy-5964889c54-fkd8t 1/1 Running 0 23m nginx-deploy-5964889c54-lnd79 1/1 Running 0 23m nginx-deploy-5964889c54-tfdf7 1/1 Running 0 23m # è¿›å…¥å…¶ä¸­ä¸€ä¸ªpod å¹¶å°†é¦–é¡µæ”¹ä¸º hello $ kubectl exec -ti nginx-deploy-5964889c54-tfdf7 -- bash root@nginx-deploy-5964889c54-tfdf7:/# cd /usr/share/nginx/html/ root@nginx-deploy-5964889c54-tfdf7:/usr/share/nginx/html# echo hello > index.html é€€å‡ºåå¤šè®¿é—®å‡ æ¬¡ ä¼šå‡ºç° hello, å¯è§å…¶é‡‡ç”¨äº†è´Ÿè½½å‡è¡¡æŠ€æœ¯ $ wget -qO- http://10.43.146.225:8080 hello åˆ›å»º Service å¯¹è±¡ æƒ³ä»é›†ç¾¤å¤–éƒ¨è®¿é—®æœåŠ¡å°±éœ€è¦å®šä¹‰ service ç±»å‹ ServiceType å–å€¼ ClusterIPï¼šå°†æœåŠ¡å…¬å¼€åœ¨é›†ç¾¤å†…éƒ¨ã€‚kubernetes ä¼šç»™æœåŠ¡åˆ†é…ä¸€ä¸ªé›†ç¾¤å†…éƒ¨çš„ IPï¼Œé›†ç¾¤å†…çš„æ‰€æœ‰ä¸»æœºéƒ½å¯ä»¥é€šè¿‡è¿™ä¸ª Cluster-IP è®¿é—®æœåŠ¡ã€‚é›†ç¾¤å†…éƒ¨çš„ Pod å¯ä»¥é€šè¿‡ service åç§°è®¿é—®æœåŠ¡ã€‚å¦‚æœä¸æŒ‡å®š ServiceTypeï¼Œå…¶ä¸ºè«ä»ç±»å‹ NodePortï¼šé€šè¿‡æ¯ä¸ªèŠ‚ç‚¹çš„ä¸»æœº IP å’Œé™æ€ç«¯å£ï¼ˆNodePortï¼‰æš´éœ²æœåŠ¡ã€‚ é›†ç¾¤çš„å¤–éƒ¨ä¸»æœºå¯ä»¥ä½¿ç”¨èŠ‚ç‚¹ IP å’Œ NodePort è®¿é—®æœåŠ¡ã€‚ $ æš´éœ²ä¸€ä¸ªå¤–éƒ¨ç«¯å£çš„æœåŠ¡ $ kubectl expose deploy/nginx-deploy --name=nginx-outside --type=NodePort --port=8081 --target-port=80 service/nginx-outside exposed / # kubectl get service NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 443/TCP 4d13h nginx-service ClusterIP 10.43.146.225 8080/TCP 18m nginx-outside NodePort 10.43.4.121 8081:32555/TCP 9s # é€šè¿‡èŠ‚ç‚¹ipè®¿é—® $ curl 172.25.0.2:32555 hello $ curl 172.25.0.2:32555 Welcome to nginx! html { color-scheme: light dark; } body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } Welcome to nginx! If you see this page, the nginx web server is successfully installed and working. Further configuration is required. For online documentation and support please refer to nginx.org. Commercial support is available at nginx.com. Thank you for using nginx. ExternalNameï¼šå°†é›†ç¾¤å¤–éƒ¨çš„ç½‘ç»œå¼•å…¥é›†ç¾¤å†…éƒ¨ã€‚ LoadBalancerï¼šä½¿ç”¨äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨å‘å¤–éƒ¨æš´éœ²æœåŠ¡ã€‚ è®¿é—® Service å‰é¢ NodePort è®¿é—®ä¸»æœºï¼š172.25.0.2:32555 1.NodePortç«¯å£æ˜¯éšæœºçš„ï¼ŒèŒƒå›´ä¸º:30000-32767ã€‚ 2.é›†ç¾¤ä¸­æ¯ä¸€ä¸ªä¸»æœºèŠ‚ç‚¹çš„NodePortç«¯å£éƒ½å¯ä»¥è®¿é—®ã€‚ 3.å¦‚æœéœ€è¦æŒ‡å®šç«¯å£ï¼Œä¸æƒ³éšæœºäº§ç”Ÿï¼Œéœ€è¦ä½¿ç”¨é…ç½®æ–‡ä»¶æ¥å£°æ˜ã€‚ å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/zh-cn/docs/concepts/services-networking/service/ https://kubernetes.io/zh-cn/docs/tutorials/stateless-application/expose-external-ip-address/ "},"base/namespace.html":{"url":"base/namespace.html","title":"Namespace(å‘½åç©ºé—´)","keywords":"","body":"Namespace(å‘½åç©ºé—´) å‘½åç©ºé—´(Namespace)æ˜¯ä¸€ç§èµ„æºéš”ç¦»æœºåˆ¶ï¼Œå°†åŒä¸€é›†ç¾¤ä¸­çš„èµ„æºåˆ’åˆ†ä¸ºç›¸äº’éš”ç¦»çš„ç»„ã€‚ å‘½åç©ºé—´å¯ä»¥åœ¨å¤šä¸ªç”¨æˆ·ä¹‹é—´åˆ’åˆ†é›†ç¾¤èµ„æºï¼ˆé€šè¿‡èµ„æºé…é¢ï¼‰ã€‚ ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥è®¾ç½®å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç­‰å¤šä¸ªå‘½åç©ºé—´ã€‚ åŒä¸€å‘½åç©ºé—´å†…çš„èµ„æºåç§°è¦å”¯ä¸€ï¼Œä½†è·¨å‘½åç©ºé—´æ—¶æ²¡æœ‰è¿™ä¸ªè¦æ±‚ã€‚ å‘½åç©ºé—´ä½œç”¨åŸŸä»…é’ˆå¯¹å¸¦æœ‰åå­—ç©ºé—´çš„å¯¹è±¡ï¼Œä¾‹å¦‚ Deploymentã€Service ç­‰ã€‚ è¿™ç§ä½œç”¨åŸŸå¯¹é›†ç¾¤è®¿é—®çš„å¯¹è±¡ä¸é€‚ç”¨ï¼Œä¾‹å¦‚ StorageClassã€Nodeã€PersistentVolume ç­‰ã€‚ # æŸ¥çœ‹å‘½åç©ºé—´ ç¼©å†™ ns $ kubectl get namespace NAME STATUS AGE default Active 4d15h kube-system Active 4d15h kube-public Active 4d15h kube-node-lease Active 4d15h Kubernetes ä¼šåˆ›å»ºå››ä¸ªåˆå§‹å‘½åç©ºé—´ï¼š default é»˜è®¤çš„å‘½åç©ºé—´ï¼Œä¸å¯åˆ é™¤ï¼ŒæœªæŒ‡å®šå‘½åç©ºé—´çš„å¯¹è±¡éƒ½ä¼šè¢«åˆ†é…åˆ° default ä¸­ã€‚ kube-system Kubernetes ç³»ç»Ÿå¯¹è±¡(æ§åˆ¶å¹³é¢å’Œ Node ç»„ä»¶)æ‰€ä½¿ç”¨çš„å‘½åç©ºé—´ã€‚ kube-public è‡ªåŠ¨åˆ›å»ºçš„å…¬å…±å‘½åç©ºé—´ï¼Œæ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬æœªç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ï¼‰éƒ½å¯ä»¥è¯»å–å®ƒã€‚é€šå¸¸æˆ‘ä»¬çº¦å®šï¼Œå°†æ•´ä¸ªé›†ç¾¤ä¸­å…¬ç”¨çš„å¯è§å’Œå¯è¯»çš„èµ„æºæ”¾åœ¨è¿™ä¸ªç©ºé—´ä¸­ã€‚ kube-node-lease ç§Ÿçº¦ï¼ˆLeaseï¼‰å¯¹è±¡ä½¿ç”¨çš„å‘½åç©ºé—´ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªå…³è”çš„ lease å¯¹è±¡ï¼Œlease æ˜¯ä¸€ç§è½»é‡çº§èµ„æºã€‚lease å¯¹è±¡é€šè¿‡å‘é€å¿ƒè·³ï¼Œæ£€æµ‹é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æ˜¯å¦å‘ç”Ÿæ•…éšœã€‚ ä½¿ç”¨ kubectl get lease -A æŸ¥çœ‹ lease å¯¹è±¡ kubenetes çš„ç»„ä»¶éƒ½è¿è¡Œåœ¨ kube-system å‘½åç©ºé—´ä¸­, è‡ªå·±éƒ¨ç½²çš„åœ¨ default ç›®å½•ä¸‹ $ kubectl get pod -A NAMESPACE NAME READY STATUS RESTARTS AGE kube-system helm-install-traefik-crd-bjf84 0/1 Completed 0 4d15h kube-system helm-install-traefik-bcrr6 0/1 Completed 5 4d15h kube-system svclb-traefik-c090484e-hwms9 2/2 Running 2 (3d11h ago) 4d15h kube-system svclb-traefik-c090484e-4rlrg 2/2 Running 2 (3d11h ago) 4d15h kube-system coredns-77ccd57875-rf6s4 1/1 Running 10 (3d11h ago) 4d15h kube-system svclb-traefik-c090484e-cnsgm 2/2 Running 2 (3d11h ago) 4d15h kube-system local-path-provisioner-957fdf8bc-dw92l 1/1 Running 0 4d15h kube-system metrics-server-648b5df564-tnzrm 1/1 Running 30 (3d11h ago) 4d15h kube-system traefik-64f55bb67d-bhb49 1/1 Running 28 (3d11h ago) 4d15h default nginx-deploy-5964889c54-fkd8t 1/1 Running 0 152m default nginx-deploy-5964889c54-lnd79 1/1 Running 0 152m default nginx-deploy-5964889c54-tfdf7 1/1 Running 0 152m æ–°ç‰ˆæœ¬ apiserver ä¹Ÿæ˜¯ä¸€ä¸ª lease å¯¹è±¡ $ kubectl get lease -A NAMESPACE NAME HOLDER AGE kube-node-lease k3d-demo-agent-0 k3d-demo-agent-0 4d15h kube-node-lease k3d-demo-agent-1 k3d-demo-agent-1 4d15h kube-node-lease k3d-demo-server-0 k3d-demo-server-0 4d15h kube-system apiserver-tbovar5ze2pqx4h6gvtcm557sm apiserver-tbovar5ze2pqx4h6gvtcm557sm_8167404a-b62f-45fb-81e8-72eddaf1aaf8 4d15h ä½¿ç”¨å¤šä¸ªå‘½åç©ºé—´ å‘½åç©ºé—´æ˜¯åœ¨å¤šä¸ªç”¨æˆ·ä¹‹é—´åˆ’åˆ†é›†ç¾¤èµ„æºçš„ä¸€ç§æ–¹æ³•ï¼ˆé€šè¿‡èµ„æºé…é¢ï¼‰ã€‚ ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥è®¾ç½®å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç­‰å¤šä¸ªå‘½åç©ºé—´ã€‚ ä¸å¿…ä½¿ç”¨å¤šä¸ªå‘½åç©ºé—´æ¥åˆ†éš”è½»å¾®ä¸åŒçš„èµ„æºã€‚ ä¾‹å¦‚åŒä¸€è½¯ä»¶çš„ä¸åŒç‰ˆæœ¬ï¼š åº”è¯¥ä½¿ç”¨æ ‡ç­¾ æ¥åŒºåˆ†åŒä¸€å‘½åç©ºé—´ä¸­çš„ä¸åŒèµ„æºã€‚ å‘½åç©ºé—´é€‚ç”¨äºè·¨å¤šä¸ªå›¢é˜Ÿæˆ–é¡¹ç›®çš„åœºæ™¯ã€‚ å¯¹äºåªæœ‰å‡ åˆ°å‡ åä¸ªç”¨æˆ·çš„é›†ç¾¤ï¼Œå¯ä»¥ä¸ç”¨åˆ›å»ºå‘½åç©ºé—´ã€‚ å‘½åç©ºé—´ä¸èƒ½ç›¸äº’åµŒå¥—ï¼Œæ¯ä¸ª Kubernetes èµ„æºåªèƒ½åœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸­ã€‚ ç®¡ç†å‘½åç©ºé—´ #åˆ›å»ºå‘½åç©ºé—´ $ kubectl create ns develop namespace/develop created #åœ¨å‘½åç©ºé—´å†…è¿è¡ŒPod --namespace ç­‰ä»·äº -n # kubectl run my-nginx --image=nginx -n=dev $ kubectl run nginx --image=nginx:1.22 --namespace=develop pod/nginx created #æŸ¥çœ‹å‘½åç©ºé—´å†…çš„Pod $ kubectl get pod -n=develop NAME READY STATUS RESTARTS AGE nginx 1/1 Running 0 37s # é»˜è®¤æ˜¯ default ä¸‹çš„å‘½åç©ºé—´ $ kubectl get pod NAME READY STATUS RESTARTS AGE nginx-deploy-5964889c54-fkd8t 1/1 Running 0 161m nginx-deploy-5964889c54-lnd79 1/1 Running 0 161m nginx-deploy-5964889c54-tfdf7 1/1 Running 0 161m åˆ‡æ¢å½“å‰å‘½åç©ºé—´ $ kubectl config set-context $(kubectl config current-context) --namespace=develop # é»˜è®¤å‘½åç©ºé—´å°±æ”¹å˜ä¸º develop äº† $ kubectl get pod NAME READY STATUS RESTARTS AGE nginx 1/1 Running 0 3m25s åˆ é™¤å‘½åç©ºé—´ $ kubectl delete ns develop namespace \"develop\" deleted # å› ä¸ºé»˜è®¤è¢«æ”¹ä¸º develop ä½†ç°åœ¨develop è¢«åˆ é™¤äº† $ kubectl get pod No resources found in develop namespace. # æŸ¥çœ‹nsçŠ¶æ€ $ kubectl get ns NAME STATUS AGE default Active 4d15h kube-system Active 4d15h kube-public Active 4d15h kube-node-lease Active 4d15h # åˆ‡æ¢ä¸ºdefault $ kubectl config set-context $(kubectl config current-context) --namespace=default $ kubectl get pod NAME READY STATUS RESTARTS AGE nginx-deploy-5964889c54-fkd8t 1/1 Running 0 6h6m nginx-deploy-5964889c54-lnd79 1/1 Running 0 6h6m nginx-deploy-5964889c54-tfdf7 1/1 Running 0 6h6m "},"base/declaration.html":{"url":"base/declaration.html","title":"å£°æ˜å¼å¯¹è±¡é…ç½®","keywords":"","body":"å£°æ˜å¼å¯¹è±¡é…ç½® äº‘åŸç”Ÿçš„ä»£è¡¨æŠ€æœ¯åŒ…æ‹¬ï¼š å®¹å™¨ æœåŠ¡ç½‘æ ¼ å¾®æœåŠ¡ ä¸å¯å˜åŸºç¡€è®¾æ–½ å£°æ˜å¼API ç®¡ç†å¯¹è±¡ å‘½ä»¤è¡ŒæŒ‡ä»¤ ä¾‹å¦‚ï¼Œä½¿ç”¨ kubectl å‘½ä»¤æ¥åˆ›å»ºå’Œç®¡ç† Kubernetes å¯¹è±¡ã€‚ å‘½ä»¤è¡Œå°±å¥½æ¯”å£å¤´ä¼ è¾¾ï¼Œç®€å•ã€å¿«é€Ÿã€é«˜æ•ˆã€‚ ä½†å®ƒåŠŸèƒ½æœ‰é™ï¼Œä¸é€‚åˆå¤æ‚åœºæ™¯ï¼Œæ“ä½œä¸å®¹æ˜“è¿½æº¯ï¼Œå¤šç”¨äºå¼€å‘å’Œè°ƒè¯•ã€‚ å£°æ˜å¼é…ç½® kubernetes ä½¿ç”¨ yaml æ–‡ä»¶æ¥æè¿° Kubernetes å¯¹è±¡ã€‚ å£°æ˜å¼é…ç½®å°±å¥½æ¯”ç”³è¯·è¡¨ï¼Œå­¦ä¹ éš¾åº¦å¤§ä¸”é…ç½®éº»çƒ¦ã€‚ å¥½å¤„æ˜¯æ“ä½œç•™ç—•ï¼Œé€‚åˆæ“ä½œå¤æ‚çš„å¯¹è±¡ï¼Œå¤šç”¨äºç”Ÿäº§ã€‚ å¸¸ç”¨å‘½ä»¤ç¼©å†™ åç§° ç¼©å†™ Kind namespaces ns Namespace nodes no Node pods po Pod services srv Service deployments deploy Deployment replicasets rs ReplicaSet statefulsets sts StatefulSet YAML è§„èŒƒ ç¼©è¿›ä»£è¡¨ä¸Šä¸‹çº§å…³ç³» ç¼©è¿›æ—¶ä¸å…è®¸ä½¿ç”¨ Tab é”®ï¼Œåªå…è®¸ä½¿ç”¨ç©ºæ ¼ï¼Œé€šå¸¸ç¼©è¿› 2 ä¸ªç©ºæ ¼ : é”®å€¼å¯¹ï¼Œåé¢å¿…é¡»æœ‰ç©ºæ ¼ -åˆ—è¡¨ï¼Œåé¢å¿…é¡»æœ‰ç©ºæ ¼ [ ]æ•°ç»„ æ³¨é‡Š | å¤šè¡Œæ–‡æœ¬å— ---è¡¨ç¤ºæ–‡æ¡£çš„å¼€å§‹ï¼Œå¤šç”¨äºåˆ†å‰²å¤šä¸ªèµ„æºå¯¹è±¡ group: s: 1 name: group-1 members: - name: \"Jack Ma\" UID: 10001 - name: \"Lei Jun\" UID: 10002 # comments words: [\"I don't care money\", \"R U OK\"] text: | line new line 3rd line # --- å¤šä¸ªèµ„æºå¯¹è±¡çš„åˆ†éš” --- group: name: group-2 members: - name: \"Jack Ma\" UID: 10001 - name: \"Lei Jun\" UID: 10002 # comments words: [\"I don't care money\", \"R U OK\"] text: | line new line 3rd line é…ç½®å¯¹è±¡ åœ¨åˆ›å»ºçš„ Kubernetes å¯¹è±¡æ‰€å¯¹åº”çš„ yaml æ–‡ä»¶ä¸­ï¼Œéœ€è¦é…ç½®çš„å­—æ®µå¦‚ä¸‹ï¼š apiVersion - Kubernetes API çš„ç‰ˆæœ¬ kind - å¯¹è±¡ç±»åˆ«ï¼Œä¾‹å¦‚ Podã€Deploymentã€Serviceã€ReplicaSet ç­‰ metadata - æè¿°å¯¹è±¡çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬ä¸€ä¸ª name å­—ç¬¦ä¸²ã€UID å’Œå¯é€‰çš„ namespace spec - å¯¹è±¡çš„é…ç½® æŒæ¡ç¨‹åº¦ï¼š ä¸è¦æ±‚è‡ªå·±ä¼šå†™ æ‰¾æ¨¡ç‰ˆ èƒ½çœ‹æ‡‚ ä¼šä¿®æ”¹ èƒ½æ’é”™ ä½¿ç”¨ yaml å®šä¹‰ä¸€ä¸ªPod Pod é…ç½®æ¨¡ç‰ˆ apiVersion: v1 kind: Pod metadata: name: nginx spec: containers: - name: nginx image: nginx:1.22 ports: - containerPort: 80 # æ‰§è¡Œ $ kubectl apply -f my-pod.yaml pod/nginx created # æŸ¥çœ‹ nginx åˆ›å»ºäº† $ kubectl get pod NAME READY STATUS RESTARTS AGE nginx-deploy-5964889c54-fkd8t 1/1 Running 0 6h7m nginx-deploy-5964889c54-lnd79 1/1 Running 0 6h7m nginx-deploy-5964889c54-tfdf7 1/1 Running 0 6h7m nginx 1/1 Running 0 16s # åˆ é™¤ $ kubectl delete -f my-pod.yaml pod \"nginx\" deleted æ ‡ç­¾ æ ‡ç­¾ï¼ˆLabelsï¼‰ æ˜¯é™„åŠ åˆ°å¯¹è±¡ï¼ˆæ¯”å¦‚ Podï¼‰ä¸Šçš„é”®å€¼å¯¹ï¼Œç”¨äºè¡¥å……å¯¹è±¡çš„æè¿°ä¿¡æ¯ã€‚ æ ‡ç­¾ä½¿ç”¨æˆ·èƒ½å¤Ÿä»¥æ¾æ•£çš„æ–¹å¼ç®¡ç†å¯¹è±¡æ˜ å°„ï¼Œè€Œæ— éœ€å®¢æˆ·ç«¯å­˜å‚¨è¿™äº›æ˜ å°„ã€‚ ç”±äºä¸€ä¸ªé›†ç¾¤ä¸­å¯èƒ½ç®¡ç†æˆåƒä¸Šä¸‡ä¸ªå®¹å™¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ ‡ç­¾é«˜æ•ˆçš„è¿›è¡Œé€‰æ‹©å’Œæ“ä½œå®¹å™¨é›†åˆã€‚ é”®çš„æ ¼å¼ï¼š å‰ç¼€(å¯é€‰)/åç§°(å¿…é¡»)ã€‚ æœ‰æ•ˆåç§°å’Œå€¼ï¼š å¿…é¡»ä¸º 63 ä¸ªå­—ç¬¦æˆ–æ›´å°‘ï¼ˆå¯ä»¥ä¸ºç©ºï¼‰ å¦‚æœä¸ä¸ºç©ºï¼Œå¿…é¡»ä»¥å­—æ¯æ•°å­—å­—ç¬¦ï¼ˆ[a-z0-9A-Z]ï¼‰å¼€å¤´å’Œç»“å°¾ åŒ…å«ç ´æŠ˜å·-ã€ä¸‹åˆ’çº¿_ã€ç‚¹.å’Œå­—æ¯æˆ–æ•°å­— label é…ç½®æ¨¡ç‰ˆ apiVersion: v1 kind: Pod metadata: name: label-demo labels: environment: production app: nginx spec: containers: - name: nginx image: nginx:1.22 ports: - containerPort: 80 $ kubectl apply -f label-pod.yaml pod/label-demo created $ kubectl get pod NAME READY STATUS RESTARTS AGE nginx-deploy-5964889c54-fkd8t 1/1 Running 0 6h14m nginx-deploy-5964889c54-lnd79 1/1 Running 0 6h14m nginx-deploy-5964889c54-tfdf7 1/1 Running 0 6h14m label-demo 1/1 Running 0 5s # æ˜¾ç¤ºæ ‡ç­¾ $ kubectl get pod --show-labels NAME READY STATUS RESTARTS AGE LABELS nginx-deploy-5964889c54-fkd8t 1/1 Running 0 6h14m app=nginx-deploy,pod-template-hash=5964889c54 nginx-deploy-5964889c54-lnd79 1/1 Running 0 6h14m app=nginx-deploy,pod-template-hash=5964889c54 nginx-deploy-5964889c54-tfdf7 1/1 Running 0 6h14m app=nginx-deploy,pod-template-hash=5964889c54 label-demo 1/1 Running 0 11s app=nginx,environment=production # -l è¿‡æ»¤ $ kubectl get pod -l \"app=nginx\" NAME READY STATUS RESTARTS AGE label-demo 1/1 Running 0 39s # , åˆ†éš”å¤šä¸ªæ¡ä»¶ $ kubectl get pod -l \"app=nginx,environment=production\" NAME READY STATUS RESTARTS AGE label-demo 1/1 Running 0 57s é€‰æ‹©å™¨ æ ‡ç­¾é€‰æ‹©å™¨ å¯ä»¥è¯†åˆ«ä¸€ç»„å¯¹è±¡ã€‚æ ‡ç­¾ä¸æ”¯æŒå”¯ä¸€æ€§ã€‚ æ ‡ç­¾é€‰æ‹©å™¨æœ€å¸¸è§çš„ç”¨æ³•æ˜¯ä¸º Service é€‰æ‹©ä¸€ç»„ Pod ä½œä¸ºåç«¯ã€‚ Service é…ç½®æ¨¡ç‰ˆ apiVersion: v1 kind: Service metadata: name: my-service spec: type: NodePort selector: app: nginx ports: # é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œ`targetPort` è¢«è®¾ç½®ä¸ºä¸ `port` å­—æ®µç›¸åŒçš„å€¼ã€‚ - port: 80 targetPort: 80 # å¯é€‰å­—æ®µ # é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼ŒKubernetes æ§åˆ¶å¹³é¢ä¼šä»æŸä¸ªèŒƒå›´å†…åˆ†é…ä¸€ä¸ªç«¯å£å· #ï¼ˆé»˜è®¤ï¼š30000-32767ï¼‰ nodePort: 30007 kubectl apply -f my-service.yaml service/my-service created $ kubectl get service NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 443/TCP 4d18h nginx-service ClusterIP 10.43.146.225 8080/TCP 6h9m nginx-outside NodePort 10.43.4.121 8081:32555/TCP 5h50m my-service NodePort 10.43.134.176 80:30007/TCP 4s $ kubectl describe svc/my-service Name: my-service Namespace: default Labels: Annotations: Selector: app=nginx Type: NodePort IP Family Policy: SingleStack IP Families: IPv4 IP: 10.43.134.176 IPs: 10.43.134.176 Port: 80/TCP TargetPort: 80/TCP NodePort: 30007/TCP Endpoints: 10.42.1.13:80 Session Affinity: None External Traffic Policy: Cluster Events: # æŸ¥çœ‹pod æ˜¯å¦è¢«service é€‰ä¸­, å¯ä»¥çœ‹åˆ° Endpoints å¯¹ä¸Š $ kubectl get pod -l \"app=nginx\" -owide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES label-demo 1/1 Running 0 10m 10.42.1.13 k3d-demo-agent-1 ç›®å‰æ”¯æŒä¸¤ç§ç±»å‹çš„é€‰æ‹©è¿ç®—ï¼šåŸºäºç­‰å€¼çš„å’ŒåŸºäºé›†åˆçš„ã€‚ å¤šä¸ªé€‰æ‹©æ¡ä»¶ä½¿ç”¨é€—å·åˆ†éš”ï¼Œç›¸å½“äº And(&&)è¿ç®—ã€‚ ç­‰å€¼é€‰æ‹© selector: matchLabels: # component=redis && version=7.0 component: redis version: 7.0 é›†åˆé€‰æ‹© selector: matchExpressions: # tier in (cache, backend) && environment not in (dev, prod) - { key: tier, operator: In, values: [cache, backend] } - { key: environment, operator: NotIn, values: [dev, prod] } å‚è€ƒèµ„æ–™ï¼šhttps://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/kubernetes-objects/ https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/object-management/ https://kubernetes.io/docs/reference/kubectl/#resource-types https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/ https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/labels/ "},"base/canary.html":{"url":"base/canary.html","title":"é‡‘ä¸é›€å‘å¸ƒ","keywords":"","body":"é‡‘ä¸é›€å‘å¸ƒ é‡‘ä¸é›€éƒ¨ç½²(canary deployment)ä¹Ÿè¢«ç§°ä¸ºç°åº¦å‘å¸ƒã€‚ æ—©æœŸï¼Œå·¥äººä¸‹çŸ¿äº•ä¹‹å‰ä¼šæ”¾å…¥ä¸€åªé‡‘ä¸é›€æ£€æµ‹äº•ä¸‹æ˜¯å¦å­˜åœ¨æœ‰æ¯’æ°”ä½“ã€‚ é‡‡ç”¨é‡‘ä¸é›€éƒ¨ç½²ï¼Œä½ å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒçš„åŸºç¡€è®¾æ–½ä¸­å°èŒƒå›´çš„éƒ¨ç½²æ–°çš„åº”ç”¨ä»£ç ã€‚ ä¸€æ—¦åº”ç”¨ç­¾ç½²å‘å¸ƒï¼Œåªæœ‰å°‘æ•°ç”¨æˆ·è¢«è·¯ç”±åˆ°å®ƒï¼Œæœ€å¤§é™åº¦çš„é™ä½å½±å“ã€‚ å¦‚æœæ²¡æœ‰é”™è¯¯å‘ç”Ÿï¼Œåˆ™å°†æ–°ç‰ˆæœ¬é€æ¸æ¨å¹¿åˆ°æ•´ä¸ªåŸºç¡€è®¾æ–½ã€‚ éƒ¨ç½²è¿‡ç¨‹ éƒ¨ç½²ç¬¬ä¸€ä¸ªç‰ˆæœ¬ å‘å¸ƒ v1 ç‰ˆæœ¬çš„åº”ç”¨ï¼Œé•œåƒä½¿ç”¨ nginx:1.22,æ•°é‡ä¸º 3ã€‚ åˆ›å»º Namespace Namespace é…ç½®æ¨¡ç‰ˆ åˆ›å»º Deployment Deployment é…ç½®æ¨¡ç‰ˆ åˆ›å»ºå¤–éƒ¨è®¿é—®çš„ Service Service é…ç½®æ¨¡ç‰ˆ apiVersion: v1 kind: Namespace metadata: name: dev --- apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment-v1 namespace: dev labels: app: nginx-deployment-v1 spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.22 ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: canary-demo namespace: dev spec: type: NodePort selector: app: nginx ports: - port: 80 # By default and for convenience, the `targetPort` is set to # the same value as the `port` field. targetPort: 80 # Optional field # By default and for convenience, the Kubernetes control plane # will allocate a port from a range (default: 30000-32767) nodePort: 30008 $ kubectl apply -f deploy-v1.yaml namespace/dev created deployment.apps/nginx-deployment-v1 created service/canary-demo created $ kubectl get all -n=dev NAME READY STATUS RESTARTS AGE pod/nginx-deployment-v1-5467856d7c-dr89n 1/1 Running 0 8s pod/nginx-deployment-v1-5467856d7c-wctbv 1/1 Running 0 8s pod/nginx-deployment-v1-5467856d7c-xwqtv 1/1 Running 0 8s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/canary-demo NodePort 10.43.119.219 80:30008/TCP 8s NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-deployment-v1 3/3 3 3 8s NAME DESIRED CURRENT READY AG # è·å–serviceæè¿° $ kubectl describe service canary-demo -n=dev Name: canary-demo Namespace: dev Labels: Annotations: Selector: app=nginx Type: NodePort IP Family Policy: SingleStack IP Families: IPv4 IP: 10.43.119.219 IPs: 10.43.119.219 Port: 80/TCP TargetPort: 80/TCP NodePort: 30008/TCP Endpoints: 10.42.0.9:80,10.42.1.14:80,10.42.2.11:80 Session Affinity: None External Traffic Policy: Cluster Events: åˆ›å»º Canary Deployment å‘å¸ƒæ–°ç‰ˆæœ¬çš„åº”ç”¨ï¼Œé•œåƒä½¿ç”¨ docker/getting-startedï¼Œæ•°é‡ä¸º 1ã€‚ apiVersion: v1 kind: Namespace metadata: name: dev --- apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment-canary namespace: dev labels: app: nginx-deployment-canary spec: replicas: 1 selector: matchLabels: app: nginx template: metadata: labels: # å› ä¸ºæ–°éƒ¨ç½²çš„æ ‡ç­¾å’ŒåŸéƒ¨ç½²serviceé€‰æ‹©çš„æ ‡ç­¾ä¸€æ ·ï¼Œæ‰€ä»¥éƒ¨ç½²åä¼šè‡ªåŠ¨åŠ å…¥åŸservice app: nginx track: canary spec: containers: - name: new-nginx image: docker/getting-started ports: - containerPort: 80 $ kubectl apply -f deploy-canary.yaml namespace/dev unchanged deployment.apps/nginx-deployment-canary created $ kubectl get all -n=dev NAME READY STATUS RESTARTS AGE pod/nginx-deployment-v1-5467856d7c-dr89n 1/1 Running 0 17m pod/nginx-deployment-v1-5467856d7c-wctbv 1/1 Running 0 17m pod/nginx-deployment-v1-5467856d7c-xwqtv 1/1 Running 0 17m pod/nginx-deployment-canary-596dd6f965-8jfn4 1/1 Running 0 19s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/canary-demo NodePort 10.43.119.219 80:30008/TCP 17m NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-deployment-v1 3/3 3 3 17m deployment.apps/nginx-deployment-canary 1/1 1 1 19s NAME DESIRED CURRENT READY AGE replicaset.apps/nginx-deployment-v1-5467856d7c 3 3 3 17m replicaset.apps/nginx-deployment-canary-596dd6f965 1 1 1 19s # è®¿é—®æˆåŠŸ $ wget -qO- 10.43.119.219 Welcome to nginx! html { color-scheme: light dark; } body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } Welcome to nginx! If you see this page, the nginx web server is successfully installed and working. Further configuration is required. For online documentation and support please refer to nginx.org. Commercial support is available at nginx.com. Thank you for using nginx. åˆ†é…æµé‡ æŸ¥çœ‹æœåŠ¡kubectl describe svc canary-demo --namespace=dev $ kubectl describe svc canary-demo -n=dev Name: canary-demo Namespace: dev Labels: Annotations: Selector: app=nginx Type: NodePort IP Family Policy: SingleStack IP Families: IPv4 IP: 10.43.119.219 IPs: 10.43.119.219 Port: 80/TCP TargetPort: 80/TCP NodePort: 30008/TCP Endpoints: 10.42.0.9:80,10.42.1.14:80,10.42.2.11:80 + 1 more... Session Affinity: None External Traffic Policy: Cluster Events: ä¸Šé¢ 1 more... è¡¨ç¤ºæ–°åŠ å…¥äº†ä¸€ä¸ªèŠ‚ç‚¹ # å¤šæ¬¡è®¿é—®ï¼Œç›´åˆ°å‡ºç°ä»¥ä¸‹è¡¨ç¤ºéƒ¨ç½²æˆåŠŸ $ wget -qO- 10.43.119.219 var anchor=window.location.hash.substr(1);location.href=\"/tutorial/\"+(anchor?\"#\"+anchor:\"\")Getting Startedbody,input{font-family:\"Roboto\",\"Helvetica Neue\",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:\"Roboto Mono\",\"Courier New\",Courier,monospace} Getting Started Home &#xE5CD; Type to start searching docker/getting-started Getting Started docker/getting-started Getting Started Our Application Updating our App Sharing our App Persisting our DB Using Bind Mounts Multi-Container Apps Using Docker Compose Image Building Best Practices What Next? Home Copyright &copy; 2020-2022 Docker powered by MkDocs and Material for MkDocs è°ƒæ•´æ¯”ä¾‹ å¾…ç¨³å®šè¿è¡Œä¸€æ®µæ—¶é—´åï¼Œæ‰©å¤§è¯•ç”¨èŒƒå›´ï¼Œå°†éƒ¨ç½²çš„ canary ç‰ˆæœ¬æ•°é‡è°ƒæ•´ä¸º 3ï¼Œv1 å’Œ canary çš„æ•°é‡éƒ½æ˜¯ 3 ä¸ªã€‚ $ kubectl scale deploy nginx-deployment-canary --replicas=3 -n=devdeployment.apps/nginx-deployment-canary scaled âš¡ # æŸ¥çœ‹æ˜¯å¦ä¸º3 $ kubectl get all -n=devNAME READY STATUS RESTARTS AGEpod/nginx-deployment-v1-5467856d7c-dr89n 1/1 Running 0 24mpod/nginx-deployment-v1-5467856d7c-wctbv 1/1 Running 0 24m pod/nginx-deployment-v1-5467856d7c-xwqtv 1/1 Running 0 24m pod/nginx-deployment-canary-596dd6f965-8jfn4 1/1 Running 0 7m47s pod/nginx-deployment-canary-596dd6f965-d7j92 0/1 ContainerCreating 0 10s pod/nginx-deployment-canary-596dd6f965-przpg 0/1 ContainerCreating 0 10s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/canary-demo NodePort 10.43.119.219 80:30008/TCP 24m NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-deployment-v1 3/3 3 3 24m deployment.apps/nginx-deployment-canary 1/3 3 1 7m47s NAME DESIRED CURRENT READY AGE replicaset.apps/nginx-deployment-v1-5467856d7c 3 3 3 24m replicaset.apps/nginx-deployment-canary-596dd6f965 3 3 1 7m47s ä¸‹çº¿æ—§ç‰ˆæœ¬ æœ€åä¸‹çº¿æ‰€æœ‰ v1 ç‰ˆæœ¬ï¼Œæ‰€æœ‰æœåŠ¡å‡çº§ä¸º canary ç‰ˆæœ¬ã€‚ kubectl scale deploy nginx-deployment-v1 --replicas=0 -n=dev deployment.apps/nginx-deployment-v1 scaled $ kubectl get all -n=dev NAME READY STATUS RESTARTS AGE pod/nginx-deployment-canary-596dd6f965-8jfn4 1/1 Running 0 10m pod/nginx-deployment-canary-596dd6f965-przpg 1/1 Running 0 2m28s pod/nginx-deployment-canary-596dd6f965-d7j92 1/1 Running 0 2m28s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/canary-demo NodePort 10.43.119.219 80:30008/TCP 27m NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-deployment-canary 3/3 3 3 10m deployment.apps/nginx-deployment-v1 0/0 0 0 27m NAME DESIRED CURRENT READY AGE replicaset.apps/nginx-deployment-canary-596dd6f965 3 3 3 10m replicaset.apps/nginx-deployment-v1-5467856d7c 0 0 0 27m æ¸…ç©ºç¯å¢ƒ $ kubectl delete all --all -n=dev pod \"nginx-deployment-canary-596dd6f965-8jfn4\" deleted pod \"nginx-deployment-canary-596dd6f965-przpg\" deleted pod \"nginx-deployment-canary-596dd6f965-d7j92\" deleted service \"canary-demo\" deleted deployment.apps \"nginx-deployment-v1\" deleted deployment.apps \"nginx-deployment-canary\" deleted replicaset.apps \"nginx-deployment-canary-596dd6f965\" deleted å±€é™æ€§ æŒ‰ç…§ Kubernetes é»˜è®¤æ”¯æŒçš„è¿™ç§æ–¹å¼è¿›è¡Œé‡‘ä¸é›€å‘å¸ƒï¼Œæœ‰ä¸€å®šçš„å±€é™æ€§ï¼š ä¸èƒ½æ ¹æ®ç”¨æˆ·æ³¨å†Œæ—¶é—´ã€åœ°åŒºç­‰è¯·æ±‚ä¸­çš„å†…å®¹å±æ€§è¿›è¡Œæµé‡åˆ†é… åŒä¸€ä¸ªç”¨æˆ·å¦‚æœå¤šæ¬¡è°ƒç”¨è¯¥ Serviceï¼Œæœ‰å¯èƒ½ç¬¬ä¸€æ¬¡è¯·æ±‚åˆ°äº†æ—§ç‰ˆæœ¬çš„ Podï¼Œç¬¬äºŒæ¬¡è¯·æ±‚åˆ°äº†æ–°ç‰ˆæœ¬çš„ Pod åœ¨ Kubernetes ä¸­ä¸èƒ½è§£å†³ä¸Šè¿°å±€é™æ€§çš„åŸå› æ˜¯ï¼šKubernetes Service åªåœ¨ TCP å±‚é¢è§£å†³è´Ÿè½½å‡è¡¡çš„é—®é¢˜ï¼Œå¹¶ä¸å¯¹è¯·æ±‚å“åº”çš„æ¶ˆæ¯å†…å®¹åšä»»ä½•è§£æå’Œè¯†åˆ«ã€‚å¦‚æœæƒ³è¦æ›´å®Œå–„åœ°å®ç°é‡‘ä¸é›€å‘å¸ƒï¼Œå¯ä»¥è€ƒè™‘ Istio ç°åº¦å‘å¸ƒã€‚ å‚è€ƒæ–‡æ¡£ï¼š https://www.infoq.cn/article/lei4vsfpiw5a6en-aso4 https://kuboard.cn/learning/k8s-intermediate/workload/wl-deployment/canary.html "},"runapp/":{"url":"runapp/","title":"è¿è¡Œæœ‰çŠ¶æ€çš„åº”ç”¨","keywords":"","body":"è¿è¡Œæœ‰çŠ¶æ€åº”ç”¨ æˆ‘ä»¬ä»¥ MySQL æ•°æ®åº“ä¸ºä¾‹ï¼Œåœ¨ kubernetes é›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ªæœ‰çŠ¶æ€çš„åº”ç”¨ã€‚ éƒ¨ç½²æ•°æ®åº“å‡ ä¹è¦†ç›–äº† kubernetes ä¸­å¸¸è§çš„å¯¹è±¡å’Œæ¦‚å¿µï¼š é…ç½®æ–‡ä»¶--ConfigMap ä¿å­˜å¯†ç --Secret æ•°æ®å­˜å‚¨--æŒä¹…å·(PV)å’ŒæŒä¹…å·å£°æ˜(PVC) åŠ¨æ€åˆ›å»ºå·--å­˜å‚¨ç±»(StorageClass) éƒ¨ç½²å¤šä¸ªå®ä¾‹--StatefulSet æ•°æ®åº“è®¿é—®--Headless Service ä¸»ä»å¤åˆ¶--åˆå§‹åŒ–å®¹å™¨å’Œ sidecar æ•°æ®åº“è°ƒè¯•--port-forward éƒ¨ç½² Mysql é›†ç¾¤--helm "},"runapp/create_mysql.html":{"url":"runapp/create_mysql.html","title":"åˆ›å»º MySQL æ•°æ®åº“","keywords":"","body":"åˆ›å»º MySQL æ•°æ®åº“ é…ç½®ç¯å¢ƒå˜é‡ ä½¿ç”¨ MySQL é•œåƒ åˆ›å»º Podï¼Œéœ€è¦ä½¿ç”¨ç¯å¢ƒå˜é‡è®¾ç½® MySQL çš„åˆå§‹å¯†ç ã€‚ ç¯å¢ƒå˜é‡é…ç½®ç¤ºä¾‹ æŒ‚è½½å· å°†æ•°æ®å­˜å‚¨åœ¨å®¹å™¨ä¸­ï¼Œä¸€æ—¦å®¹å™¨è¢«åˆ é™¤ï¼Œæ•°æ®ä¹Ÿä¼šè¢«åˆ é™¤ã€‚ å°†æ•°æ®å­˜å‚¨åˆ°å·(Volume)ä¸­ï¼Œåˆ é™¤å®¹å™¨æ—¶ï¼Œå·ä¸ä¼šè¢«åˆ é™¤ã€‚ hostPath å· hostPath å·å°†ä¸»æœºèŠ‚ç‚¹ä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•æŒ‚è½½åˆ° Pod ä¸­ã€‚ hostPath é…ç½®ç¤ºä¾‹ hostPath çš„ type å€¼ï¼š DirectoryOrCreate DirectoryOrCreate Directory æŒ‚è½½å·²å­˜åœ¨ç›®å½•ã€‚ä¸å­˜åœ¨ä¼šæŠ¥é”™ã€‚ FileOrCreate æ–‡ä»¶ä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»ºã€‚ä¸ä¼šè‡ªåŠ¨åˆ›å»ºæ–‡ä»¶çš„çˆ¶ç›®å½•ï¼Œå¿…é¡»ç¡®ä¿æ–‡ä»¶è·¯å¾„å·²ç»å­˜åœ¨ã€‚ File æŒ‚è½½å·²å­˜åœ¨çš„æ–‡ä»¶ã€‚ä¸å­˜åœ¨ä¼šæŠ¥é”™ã€‚ Socket æŒ‚è½½ UNIX å¥—æ¥å­—ã€‚ä¾‹å¦‚æŒ‚è½½/var/run/docker.sock è¿›ç¨‹ apiVersion: v1 kind: Pod metadata: name: mysql-pod labels: app: mysql spec: containers: - name: mysql image: mysql:5.7 env: - name: MYSQL_ROOT_PASSWORD value: \"123456\" volumeMounts: - mountPath: /var/lib/mysql name: data-volume volumes: - name: data-volume hostPath: # directory location on host path: /src/mysqldata # this field is optional type: DirectoryOrCreate æ³¨æ„ï¼šhostPath ä»…ç”¨äºåœ¨å•èŠ‚ç‚¹é›†ç¾¤ä¸Šè¿›è¡Œå¼€å‘å’Œæµ‹è¯•ï¼Œä¸é€‚ç”¨äºå¤šèŠ‚ç‚¹é›†ç¾¤ï¼› ä¾‹å¦‚ï¼Œå½“Podè¢«é‡æ–°åˆ›å»ºæ—¶ï¼Œå¯èƒ½ä¼šè¢«è°ƒåº¦åˆ°ä¸åŸå…ˆä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œå¯¼è‡´æ–°çš„Podæ²¡æœ‰æ•°æ®ã€‚ åœ¨å¤šèŠ‚ç‚¹é›†ç¾¤ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œå¯ä»¥ä½¿ç”¨localå·ã€‚ å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/zh-cn/docs/tasks/inject-data-application/define-environment-variable-container/ https://kubernetes.io/zh-cn/docs/concepts/storage/volumes/#hostpath https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-persistent-volume-storage/ "},"runapp/configmap_secret.html":{"url":"runapp/configmap_secret.html","title":"ConfigMap ä¸ Secret","keywords":"","body":"ConfigMap ä¸ Secret åœ¨Dockerä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬é€šè¿‡ç»‘å®šæŒ‚è½½çš„æ–¹å¼å°†é…ç½®æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨é‡Œã€‚ åœ¨Kubernetesé›†ç¾¤ä¸­ï¼Œå®¹å™¨å¯èƒ½è¢«è°ƒåº¦åˆ°ä»»æ„èŠ‚ç‚¹ï¼Œé…ç½®æ–‡ä»¶éœ€è¦èƒ½åœ¨é›†ç¾¤ä»»æ„èŠ‚ç‚¹ä¸Šè®¿é—®ã€åˆ†å‘å’Œæ›´æ–°ã€‚ ConfigMap ConfigMap ç”¨æ¥åœ¨é”®å€¼å¯¹æ•°æ®åº“(etcd)ä¸­ä¿å­˜éåŠ å¯†æ•°æ®ã€‚ä¸€èˆ¬ç”¨æ¥ä¿å­˜é…ç½®æ–‡ä»¶ã€‚ ConfigMap å¯ä»¥ç”¨ä½œç¯å¢ƒå˜é‡ã€å‘½ä»¤è¡Œå‚æ•°æˆ–è€…å­˜å‚¨å·ã€‚ ConfigMap å°†ç¯å¢ƒé…ç½®ä¿¡æ¯ä¸ å®¹å™¨é•œåƒ è§£è€¦ï¼Œä¾¿äºé…ç½®çš„ä¿®æ”¹ã€‚ ConfigMap åœ¨è®¾è®¡ä¸Šä¸æ˜¯ç”¨æ¥ä¿å­˜å¤§é‡æ•°æ®çš„ã€‚ åœ¨ ConfigMap ä¸­ä¿å­˜çš„æ•°æ®ä¸å¯è¶…è¿‡ 1 MiBã€‚ è¶…å‡ºæ­¤é™åˆ¶ï¼Œéœ€è¦è€ƒè™‘æŒ‚è½½å­˜å‚¨å·æˆ–è€…è®¿é—®æ–‡ä»¶å­˜å‚¨æœåŠ¡ã€‚ ConfigMap ç”¨æ³• ConfigMap é…ç½®ç¤ºä¾‹ Pod ä¸­ä½¿ç”¨ ConfigMap apiVersion: v1 kind: Pod metadata: name: mysql-pod labels: app: mysql spec: containers: - name: mysql image: mysql:5.7 env: - name: MYSQL_ROOT_PASSWORD value: \"123456\" volumeMounts: - mountPath: /var/lib/mysql name: data-volume - mountPath: /etc/mysql/conf.d name: conf-volume readOnly: true volumes: - name: conf-volume configMap: name: mysql-config - name: data-volume hostPath: # directory location on host path: /src/mysqldata # this field is optional type: DirectoryOrCreate --- apiVersion: v1 kind: ConfigMap metadata: name: mysql-config data: mysql.cnf: | [mysqld] character-set-server=utf8mb4 collation-server=utf8mb4_general_ci init-connect='SET NAMES utf8mb4' [client] default-character-set=utf8mb4 [mysql] default-character-set=utf8mb4 # è·å–å¯¹åº”é”®å€¼ä¿¡æ¯ï¼Œ configMap ä¹Ÿå¯ç¼©å†™ä¸º cm $ kubectl describe configMap mysql-config Name: mysql-config Namespace: default Labels: Annotations: Data ==== mysql.cnf: ---- [mysqld] character-set-server=utf8mb4 collation-server=utf8mb4_general_ci init-connect='SET NAMES utf8mb4' [client] default-character-set=utf8mb4 [mysql] default-character-set=utf8mb4 BinaryData ==== Events: # è·å–ä¿¡æ¯ $ kubectl get pod -owide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES mysql-pod 1/1 Running 0 2m 10.42.1.5 k3d-demo-agent-1 # è¿›å…¥mysql æŸ¥çœ‹å­—ç¬¦é›† $ kubectl exec -ti mysql-pod -- bash bash-4.2# mysql -uroot -p123456 mysql: [Warning] Using a password on the command line interface can be insecure. Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 2 Server version: 5.7.43 MySQL Community Server (GPL) Copyright (c) 2000, 2023, Oracle and/or its affiliates. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners. Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement. mysql> show variables like \"%char%\" -> ; +--------------------------+----------------------------+ | Variable_name | Value | +--------------------------+----------------------------+ | character_set_client | utf8mb4 | | character_set_connection | utf8mb4 | | character_set_database | utf8mb4 | | character_set_filesystem | binary | | character_set_results | utf8mb4 | | character_set_server | utf8mb4 | | character_set_system | utf8 | | character_sets_dir | /usr/share/mysql/charsets/ | +--------------------------+----------------------------+ 8 rows in set (0.00 sec) ä¿®æ”¹é…ç½®æ–‡ä»¶ $ kubectl edit cm mysql-config åœ¨[client]ä¸Šåˆ†å¢åŠ ä¸€è¡Œæ³¨é‡Š # this is a new comment, æŸ¥çœ‹é…ç½®æ–‡ä»¶å·²ä¿®æ”¹ï¼š $ kubectl exec -ti mysql-pod -- bash bash-4.2# cat /etc/mysql/conf.d/mysql.cnf [mysqld] character-set-server=utf8mb4 collation-server=utf8mb4_general_ci init-connect='SET NAMES utf8mb4' # this is a new comment [client] default-character-set=utf8mb4 [mysql] default-character-set=utf8mb4 Secret Secret ç”¨äºä¿å­˜æœºå¯†æ•°æ®çš„å¯¹è±¡ã€‚ä¸€èˆ¬ç”±äºä¿å­˜å¯†ç ã€ä»¤ç‰Œæˆ–å¯†é’¥ç­‰ã€‚ data å­—æ®µç”¨æ¥å­˜å‚¨ base64 ç¼–ç æ•°æ®ã€‚ stringData å­˜å‚¨æœªç¼–ç çš„å­—ç¬¦ä¸²ã€‚ Secret æ„å‘³ç€ä½ ä¸éœ€è¦åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­åŒ…å«æœºå¯†æ•°æ®ï¼Œå‡å°‘æœºå¯†æ•°æ®(å¦‚å¯†ç )æ³„éœ²çš„é£é™©ã€‚ Secret å¯ä»¥ç”¨ä½œç¯å¢ƒå˜é‡ã€å‘½ä»¤è¡Œå‚æ•°æˆ–è€…å­˜å‚¨å·æ–‡ä»¶ã€‚ Secret ç”¨æ³• Secret é…ç½®ç¤ºä¾‹ å°† Secret ç”¨ä½œç¯å¢ƒå˜é‡ $ echo -n '123456' | base64 MTIzNDU2 $ echo 'MTIzNDU2' | base64 --decode 123456 apiVersion: v1 kind: Secret metadata: name: mysql-password type: Opaque data: # åŠ å¯†åçš„å¯†ç  PASSWORD: MTIzNDU2Cg== --- apiVersion: v1 kind: Pod metadata: name: mysql-pod labels: app: mysql spec: containers: - name: mysql image: mysql:5.7 env: - name: MYSQL_ROOT_PASSWORD valueFrom: secretKeyRef: name: mysql-password key: PASSWORD optional: false # è¡¨ç¤ºä¸ä½¿ç”¨é»˜è®¤å€¼ volumeMounts: - mountPath: /var/lib/mysql name: data-volume - mountPath: /etc/mysql/conf.d name: conf-volume readOnly: true volumes: - name: conf-volume configMap: name: mysql-config - name: data-volume hostPath: # directory location on host path: /src/mysqldata # this field is optional type: DirectoryOrCreate --- apiVersion: v1 kind: ConfigMap metadata: name: mysql-config data: mysql.cnf: | [mysqld] character-set-server=utf8mb4 collation-server=utf8mb4_general_ci init-connect='SET NAMES utf8mb4' [client] default-character-set=utf8mb4 [mysql] default-character-set=utf8mb4 æŸ¥çœ‹ secret $ kubectl apply -f mysql-pod_secret.yml secret/mysql-password created pod/mysql-pod created configmap/mysql-config configured $ kubectl describe secret/mysql-password Name: mysql-password Namespace: default Labels: Annotations: Type: Opaque Data ==== PASSWORD: 7 bytes "},"runapp/volume.html":{"url":"runapp/volume.html","title":"å·(Volume)","keywords":"","body":"å·(Volume) å°†æ•°æ®å­˜å‚¨åœ¨å®¹å™¨ä¸­ï¼Œä¸€æ—¦å®¹å™¨è¢«åˆ é™¤ï¼Œæ•°æ®ä¹Ÿä¼šè¢«åˆ é™¤ã€‚ å·æ˜¯ç‹¬ç«‹äºå®¹å™¨ä¹‹å¤–çš„ä¸€å—å­˜å‚¨åŒºåŸŸï¼Œé€šè¿‡æŒ‚è½½(Mount)çš„æ–¹å¼ä¾› Pod ä¸­çš„å®¹å™¨ä½¿ç”¨ã€‚ ä½¿ç”¨åœºæ™¯ å·å¯ä»¥åœ¨å¤šä¸ªå®¹å™¨ä¹‹é—´å…±äº«æ•°æ®ã€‚ å·å¯ä»¥å°†å®¹å™¨æ•°æ®å­˜å‚¨åœ¨å¤–éƒ¨å­˜å‚¨æˆ–äº‘å­˜å‚¨ä¸Šã€‚ å·æ›´å®¹æ˜“å¤‡ä»½æˆ–è¿ç§»ã€‚ å¸¸è§çš„å·ç±»å‹ ä¸´æ—¶å·(Ephemeral Volume)ï¼š ä¸ Pod ä¸€èµ·åˆ›å»ºå’Œåˆ é™¤ï¼Œç”Ÿå‘½å‘¨æœŸä¸ Pod ç›¸åŒ emptyDir - ä½œä¸ºç¼“å­˜æˆ–å­˜å‚¨æ—¥å¿— configMap ã€secretã€ downwardAPI - ç»™ Pod æ³¨å…¥æ•°æ® æŒä¹…å·(Persistent Volume)ï¼š åˆ é™¤ Pod åï¼ŒæŒä¹…å·ä¸ä¼šè¢«åˆ é™¤ æœ¬åœ°å­˜å‚¨ - hostPathã€ local ç½‘ç»œå­˜å‚¨ - NFS åˆ†å¸ƒå¼å­˜å‚¨ - Ceph(cephfs æ–‡ä»¶å­˜å‚¨ã€rbd å—å­˜å‚¨) æŠ•å°„å·(Projected Volumes)ï¼šprojected å·å¯ä»¥å°†å¤šä¸ªå·æ˜ å°„åˆ°åŒä¸€ä¸ªç›®å½•ä¸Š åç«¯å­˜å‚¨ ä¸€ä¸ªé›†ç¾¤ä¸­å¯ä»¥åŒ…å«å¤šç§å­˜å‚¨(å¦‚ localã€NFSã€Ceph æˆ–äº‘å­˜å‚¨)ã€‚ æ¯ç§å­˜å‚¨éƒ½å¯¹åº”ä¸€ä¸ªå­˜å‚¨ç±»ï¼ˆStorageClassï¼‰ ï¼Œå­˜å‚¨ç±»ç”¨æ¥åˆ›å»ºå’Œç®¡ç†æŒä¹…å·ï¼Œæ˜¯é›†ç¾¤ä¸å­˜å‚¨æœåŠ¡ä¹‹é—´çš„æ¡¥æ¢ã€‚ ç®¡ç†å‘˜åˆ›å»ºæŒä¹…å·(PV)æ—¶ï¼Œé€šè¿‡è®¾ç½®ä¸åŒçš„ StorageClass æ¥åˆ›å»ºä¸åŒç±»å‹çš„æŒä¹…å·ã€‚ å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/zh-cn/docs/concepts/storage/volumes/ https://kubernetes.io/zh-cn/docs/concepts/storage/ephemeral-volumes/ https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-volume-storage/ "},"runapp/ev.html":{"url":"runapp/ev.html","title":"ä¸´æ—¶å·(EV)","keywords":"","body":"ä¸´æ—¶å·(EV) ä¸´æ—¶å·(Ephemeral Volume) ä¸ Pod ä¸€èµ·åˆ›å»ºå’Œåˆ é™¤ï¼Œç”Ÿå‘½å‘¨æœŸä¸ Pod ç›¸åŒ emptyDir - åˆå§‹å†…å®¹ä¸ºç©ºçš„æœ¬åœ°ä¸´æ—¶ç›®å½• configMap - ä¸º Pod æ³¨å…¥é…ç½®æ–‡ä»¶ secret - ä¸º Pod æ³¨å…¥åŠ å¯†æ•°æ® emptyDir emptyDir ä¼šåˆ›å»ºä¸€ä¸ªåˆå§‹çŠ¶æ€ä¸ºç©ºçš„ç›®å½•ï¼Œå­˜å‚¨ç©ºé—´æ¥è‡ªæœ¬åœ°çš„ kubelet æ ¹ç›®å½•æˆ–å†…å­˜(éœ€è¦å°† emptyDir.medium è®¾ç½®ä¸º\"Memory\")ã€‚ é€šå¸¸ä½¿ç”¨æœ¬åœ°ä¸´æ—¶å­˜å‚¨æ¥è®¾ç½®ç¼“å­˜ã€ä¿å­˜æ—¥å¿—ç­‰ã€‚ ä¾‹å¦‚ï¼Œå°† redis çš„å­˜å‚¨ç›®å½•è®¾ç½®ä¸º emptyDir apiVersion: v1 kind: Pod metadata: name: redis-pod spec: containers: - name: redis image: redis volumeMounts: - name: redis-storage mountPath: /data/redis volumes: - name: redis-storage emptyDir: {} configMap å·å’Œ secret å· æ³¨æ„ï¼šè¿™é‡Œçš„ configMap å’Œ secret ä»£è¡¨çš„æ˜¯å·çš„ç±»å‹ï¼Œä¸æ˜¯ configMap å’Œ secret å¯¹è±¡ã€‚ åˆ é™¤ Pod å¹¶ä¸ä¼šåˆ é™¤ ConfigMap å¯¹è±¡å’Œ secret å¯¹è±¡ã€‚ # è·å–æ‰€æœ‰ä¸´æ—¶å·, ä½†å¾—ä¸åˆ°æœ‰æ•ˆä¿¡æ¯ $ kubectl get ev ã€‚ã€‚ã€‚ æŸ¥çœ‹ä¸´æ—¶å· configMap æœ‰æ•ˆä¿¡æ¯ # è·å–pod UID $ kubectl get pods mysql-pod -o jsonpath='{.metadata.uid}' f49b79ac-e233-45fb-9928-967a55de6b43# $ cd /var/lib/kubelet/pods/ $ ls 66b1bd24-e020-4665-9c0a-f00c8d1eb15c 8aff060c-d1e8-4b17-87ff-8a820525cb34 93717d34-0df2-40db-905a-2929ac3e99b4 f49b79ac-e233-45fb-9928-967a55de6b43 # è¿›å…¥ä¸´æ—¶å· $ cd f49b79ac-e233-45fb-9928-967a55de6b43/volumes/kubernetes.io~configmap/conf-volume # å¾—åˆ°ä¿¡æ¯ $ cat mysql.cnf [mysqld] character-set-server=utf8mb4 collation-server=utf8mb4_general_ci init-connect='SET NAMES utf8mb4' [client] default-character-set=utf8mb4 [mysql] default-character-set=utf8mb4 åˆ é™¤ pod ä¸´æ—¶å·ä¹Ÿè¢«åˆ é™¤ï¼Œä½† configMap å¯¹è±¡ä¾ç„¶å­˜åœ¨ $ cd /var/lib/kubelet/pods $ ls 66b1bd24-e020-4665-9c0a-f00c8d1eb15c 8aff060c-d1e8-4b17-87ff-8a820525cb34 93717d34-0df2-40db-905a-2929ac3e99b4 f49b79ac-e233-45fb-9928-967a55de6b43 $ kubectl delete pod mysql-pod pod \"mysql-pod\" deleted # è¢«åˆ é™¤ $ ls 66b1bd24-e020-4665-9c0a-f00c8d1eb15c 8aff060c-d1e8-4b17-87ff-8a820525cb34 93717d34-0df2-40db-905a-2929ac3e99b4 # çœ‹åˆ°configMap ä¾ç„¶å­˜åœ¨ $ kubectl get cm NAME DATA AGE kube-root-ca.crt 1 69m mysql-config 1 52m å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/zh-cn/docs/concepts/storage/volumes/ https://kubernetes.io/zh-cn/docs/concepts/storage/ephemeral-volumes/ https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-volume-storage/ "},"runapp/persistent_volume.html":{"url":"runapp/persistent_volume.html","title":"æŒä¹…å·(PV)ä¸æŒä¹…å·å£°æ˜(PVC)","keywords":"","body":"æŒä¹…å·(PV)ä¸æŒä¹…å·å£°æ˜(PVC) æŒä¹…å·(Persistent Volume)ï¼šåˆ é™¤ Pod åï¼Œå·ä¸ä¼šè¢«åˆ é™¤ æœ¬åœ°å­˜å‚¨ hostPath - èŠ‚ç‚¹ä¸»æœºä¸Šçš„ç›®å½•æˆ–æ–‡ä»¶ (ä»…ä¾›å•èŠ‚ç‚¹æµ‹è¯•ä½¿ç”¨ï¼›å¤šèŠ‚ç‚¹é›†ç¾¤è¯·ç”¨ local å·ä»£æ›¿) local - èŠ‚ç‚¹ä¸ŠæŒ‚è½½çš„æœ¬åœ°å­˜å‚¨è®¾å¤‡(ä¸æ”¯æŒåŠ¨æ€åˆ›å»ºå·) ç½‘ç»œå­˜å‚¨ NFS - ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ (NFS) åˆ†å¸ƒå¼å­˜å‚¨ Ceph(cephfs æ–‡ä»¶å­˜å‚¨ã€rbd å—å­˜å‚¨) æŒä¹…å·(PV)å’ŒæŒä¹…å·å£°æ˜(PVC) æŒä¹…å·ï¼ˆPersistentVolumeï¼ŒPVï¼‰ æ˜¯é›†ç¾¤ä¸­çš„ä¸€å—å­˜å‚¨ã€‚å¯ä»¥ç†è§£ä¸ºä¸€å—è™šæ‹Ÿç¡¬ç›˜ã€‚ æŒä¹…å·å¯ä»¥ç”±ç®¡ç†å‘˜äº‹å…ˆåˆ›å»ºï¼Œ æˆ–è€…ä½¿ç”¨å­˜å‚¨ç±»ï¼ˆStorage Classï¼‰æ ¹æ®ç”¨æˆ·è¯·æ±‚æ¥åŠ¨æ€åˆ›å»ºã€‚ æŒä¹…å·å±äºé›†ç¾¤çš„å…¬å…±èµ„æºï¼Œå¹¶ä¸å±äºæŸä¸ª namespace; æŒä¹…å·å£°æ˜ï¼ˆPersistentVolumeClaimï¼ŒPVCï¼‰ è¡¨è¾¾çš„æ˜¯ç”¨æˆ·å¯¹å­˜å‚¨çš„è¯·æ±‚ã€‚ PVC å£°æ˜å¥½æ¯”ç”³è¯·å•ï¼Œå®ƒæ›´è´´è¿‘äº‘æœåŠ¡çš„ä½¿ç”¨åœºæ™¯ï¼Œä½¿ç”¨èµ„æºå…ˆç”³è¯·ï¼Œä¾¿äºç»Ÿè®¡å’Œè®¡è´¹ã€‚ Pod å°† PVC å£°æ˜å½“åšå­˜å‚¨å·æ¥ä½¿ç”¨ï¼ŒPVC å¯ä»¥è¯·æ±‚æŒ‡å®šå®¹é‡çš„å­˜å‚¨ç©ºé—´å’Œè®¿é—®æ¨¡å¼ ã€‚PVC å¯¹è±¡æ˜¯å¸¦æœ‰ namespace çš„ã€‚ åˆ›å»ºæŒä¹…å·ï¼ˆPVï¼‰ åˆ›å»ºæŒä¹…å·(PV)æ˜¯æœåŠ¡ç«¯çš„è¡Œä¸ºï¼Œé€šå¸¸é›†ç¾¤ç®¡ç†å‘˜ä¼šæå‰åˆ›å»ºä¸€äº›å¸¸ç”¨è§„æ ¼çš„æŒä¹…å·ä»¥å¤‡ä½¿ç”¨ã€‚ hostPath ä»…ä¾›å•èŠ‚ç‚¹æµ‹è¯•ä½¿ç”¨ï¼Œå½“ Pod è¢«é‡æ–°åˆ›å»ºæ—¶ï¼Œå¯èƒ½ä¼šè¢«è°ƒåº¦åˆ°ä¸åŸå…ˆä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œå¯¼è‡´æ–°çš„ Pod æ²¡æœ‰æ•°æ®ã€‚å¤šèŠ‚ç‚¹é›†ç¾¤ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œå¯ä»¥ä½¿ç”¨ local å· åˆ›å»º local ç±»å‹çš„æŒä¹…å·ï¼Œéœ€è¦å…ˆåˆ›å»ºå­˜å‚¨ç±»(StorageClass)ã€‚ æœ¬åœ°å­˜å‚¨ç±»ç¤ºä¾‹ # åˆ›å»ºæœ¬åœ°å­˜å‚¨ç±» apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: local-storage provisioner: kubernetes.io/no-provisioner volumeBindingMode: Immediate local å·ä¸æ”¯æŒåŠ¨æ€åˆ›å»ºï¼Œå¿…é¡»æ‰‹åŠ¨åˆ›å»ºæŒä¹…å·(PV)ã€‚ åˆ›å»º local ç±»å‹çš„æŒä¹…å·ï¼Œå¿…é¡» è®¾ç½® nodeAffinity(èŠ‚ç‚¹äº²å’Œæ€§)ã€‚ è°ƒåº¦å™¨ä½¿ç”¨ nodeAffinity ä¿¡æ¯æ¥å°†ä½¿ç”¨ local å·çš„ Pod è°ƒåº¦åˆ°æŒä¹…å·æ‰€åœ¨çš„èŠ‚ç‚¹ä¸Šï¼Œä¸ä¼šå‡ºç° Pod è¢«è°ƒåº¦åˆ°åˆ«çš„èŠ‚ç‚¹ä¸Šçš„æƒ…å†µã€‚ æ³¨æ„ï¼šlocalå·ä¹Ÿå­˜åœ¨è‡ªèº«çš„é—®é¢˜ï¼Œå½“Podæ‰€åœ¨èŠ‚ç‚¹ä¸Šçš„å­˜å‚¨å‡ºç°æ•…éšœæˆ–è€…æ•´ä¸ªèŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼ŒPodå’Œå·éƒ½ä¼šå¤±æ•ˆï¼Œä»ç„¶ä¼šä¸¢å¤±æ•°æ®ï¼Œå› æ­¤æœ€å®‰å…¨çš„åšæ³•è¿˜æ˜¯å°†æ•°æ®å­˜å‚¨åˆ°é›†ç¾¤ä¹‹å¤–çš„å­˜å‚¨æˆ–äº‘å­˜å‚¨ä¸Šã€‚ åˆ›å»º PV PV ç¤ºä¾‹/local å·ç¤ºä¾‹ # åˆ›å»ºæœ¬åœ°å­˜å‚¨ç±» apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: local-storage provisioner: kubernetes.io/no-provisioner volumeBindingMode: Immediate --- apiVersion: v1 kind: PersistentVolume metadata: name: local-pv-1 spec: capacity: storage: 1Gi volumeMode: Filesystem accessModes: - ReadWriteOnce persistentVolumeReclaimPolicy: Delete storageClassName: local-storage #é€šè¿‡æŒ‡å®šå­˜å‚¨ç±»æ¥è®¾ç½®å·çš„ç±»å‹ local: path: /mnt/disks/ssd1 nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: In values: # - k8s-worker1 - k3d-demo-agent-1 è¿›å…¥ worker èŠ‚ç‚¹åˆ›å»ºæ–‡ä»¶å¤¹ $ mkdir -p /mnt/disks/ssd1 è¿›å…¥ä¸»èŠ‚ç‚¹ $ kubectl apply -f local-storage-pv.yml storageclass.storage.k8s.io/local-storage created persistentvolume/local-pv-1 created å¯ä»¥çœ‹åˆ°åˆ›å»ºäº†ä¸€ä¸ª local å­˜å‚¨ç±»å’Œ pv æŒä¹…å· æŸ¥çœ‹æŒä¹…å· # è·å–åˆ°ä¿¡æ¯ï¼Œç›®å‰ å£°æ˜CLAIM ä¸ºç©º $ kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE local-pv-1 1Gi RWO Delete Available local-storage 83s åˆ›å»ºæŒä¹…å·å£°æ˜(PVC) æŒä¹…å·å£°æ˜(PVC)æ˜¯ç”¨æˆ·ç«¯çš„è¡Œä¸º,ç”¨æˆ·åœ¨åˆ›å»º Pod æ—¶ï¼Œæ— æ³•çŸ¥é“é›†ç¾¤ä¸­ PV çš„çŠ¶æ€(åç§°ã€å®¹é‡ã€æ˜¯å¦å¯ç”¨ç­‰)ï¼Œç”¨æˆ·ä¹Ÿæ— éœ€å…³å¿ƒè¿™äº›å†…å®¹ï¼Œåªéœ€è¦åœ¨å£°æ˜ä¸­æå‡ºç”³è¯·ï¼Œé›†ç¾¤ä¼šè‡ªåŠ¨åŒ¹é…ç¬¦åˆéœ€æ±‚çš„æŒä¹…å·(PV)ã€‚ Pod ä½¿ç”¨æŒä¹…å·å£°æ˜(PVC)ä½œä¸ºå­˜å‚¨å·ã€‚ PVC ç¤ºä¾‹ apiVersion: v1 kind: PersistentVolumeClaim metadata: name: local-pv-claim spec: storageClassName: local-storage # ä¸PVä¸­çš„storageClassNameä¸€è‡´ accessModes: - ReadWriteOnce resources: requests: storage: 1Gi # åˆ›å»ºäº† pv claimå¯¹è±¡ $ kubectl apply -f pvc.yaml persistentvolumeclaim/local-pv-claim created # local-pv-1 ä¸å‰é¢å£°æ˜ä¸€è‡´ $ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-pv-claim Bound local-pv-1 1Gi RWO local-storage 62s # å¯ä»¥çœ‹åˆ°ç»‘å®šçŠ¶æ€å’Œç±»å‹éƒ½æœ‰äº† $ kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE local-pv-1 1Gi RWO Delete Bound default/local-pv-claim local-storage 7m41s ä½¿ç”¨ PVC ä½œä¸ºå· Pod çš„é…ç½®æ–‡ä»¶æŒ‡å®šäº† PersistentVolumeClaimï¼Œä½†æ²¡æœ‰æŒ‡å®š PersistentVolumeã€‚ å¯¹ Pod è€Œè¨€ï¼ŒPersistentVolumeClaim å°±æ˜¯ä¸€ä¸ªå­˜å‚¨å·ã€‚ PVC å·ç¤ºä¾‹ apiVersion: v1 kind: Secret metadata: name: mysql-password type: Opaque data: # åŠ å¯†åçš„å¯†ç  PASSWORD: MTIzNDU2Cg== --- apiVersion: v1 kind: Pod metadata: name: mysql-pod labels: app: mysql spec: containers: - name: mysql image: mysql:5.7 env: - name: MYSQL_ROOT_PASSWORD valueFrom: secretKeyRef: name: mysql-password key: PASSWORD optional: false # è¡¨ç¤ºä¸ä½¿ç”¨é»˜è®¤å€¼ volumeMounts: - mountPath: /var/lib/mysql name: data-volume - mountPath: /etc/mysql/conf.d name: conf-volume readOnly: true volumes: - name: conf-volume configMap: name: mysql-config - name: data-volume persistentVolumeClaim: claimName: local-pv-claim # hostPath: # # directory location on host # path: /src/mysqldata # # this field is optional # type: DirectoryOrCreate --- apiVersion: v1 kind: ConfigMap metadata: name: mysql-config data: mysql.cnf: | [mysqld] character-set-server=utf8mb4 collation-server=utf8mb4_general_ci init-connect='SET NAMES utf8mb4' [client] default-character-set=utf8mb4 [mysql] default-character-set=utf8mb4 ç»‘å®š åˆ›å»ºæŒä¹…å·å£°æ˜(PVC)ä¹‹åï¼Œé›†ç¾¤ä¼šæŸ¥æ‰¾æ»¡è¶³è¦æ±‚çš„æŒä¹…å·(PV)ï¼Œå°† PVC ç»‘å®šåˆ°è¯¥ PV ä¸Šã€‚ PVC ä¸ PV ä¹‹é—´çš„ç»‘å®šæ˜¯ä¸€å¯¹ä¸€çš„æ˜ å°„å…³ç³»ï¼Œç»‘å®šå…·æœ‰æ’ä»–æ€§ï¼Œä¸€æ—¦ç»‘å®šå…³ç³»å»ºç«‹ï¼Œè¯¥ PV æ— æ³•è¢«å…¶ä»– PVC ä½¿ç”¨ã€‚ PVC å¯èƒ½ä¼šåŒ¹é…åˆ°æ¯”å£°æ˜å®¹é‡å¤§çš„æŒä¹…å·ï¼Œä½†æ˜¯ä¸ä¼šåŒ¹é…æ¯”å£°æ˜å®¹é‡å°çš„æŒä¹…å·ã€‚ ä¾‹å¦‚ï¼Œå³ä½¿é›†ç¾¤ä¸Šå­˜åœ¨å¤šä¸ª 50 G å¤§å°çš„ PV ï¼Œä»–ä»¬åŠ èµ·æ¥çš„å®¹é‡å¤§äº 100Gï¼Œä¹Ÿæ— æ³•åŒ¹é… 100 G å¤§å°çš„ PVCã€‚ æ‰¾ä¸åˆ°æ»¡è¶³è¦æ±‚çš„ PV ï¼ŒPVC ä¼šæ— é™æœŸåœ°å¤„äºæœªç»‘å®šçŠ¶æ€(Pending) , ç›´åˆ°å‡ºç°äº†æ»¡è¶³è¦æ±‚çš„ PV æ—¶ï¼ŒPVC æ‰ä¼šè¢«ç»‘å®šã€‚ è®¿é—®æ¨¡å¼ ReadWriteOnce å·å¯ä»¥è¢«ä¸€ä¸ªèŠ‚ç‚¹ä»¥è¯»å†™æ–¹å¼æŒ‚è½½ï¼Œå¹¶å…è®¸åŒä¸€èŠ‚ç‚¹ä¸Šçš„å¤šä¸ª Pod è®¿é—®ã€‚ ReadOnlyMany å·å¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹ä»¥åªè¯»æ–¹å¼æŒ‚è½½ã€‚ ReadWriteMany å·å¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹ä»¥è¯»å†™æ–¹å¼æŒ‚è½½ã€‚ ReadWriteOncePod å·å¯ä»¥è¢«å•ä¸ª Pod ä»¥è¯»å†™æ–¹å¼æŒ‚è½½ã€‚ é›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ª Pod å¯ä»¥è¯»å–æˆ–å†™å…¥è¯¥ PVCã€‚ åªæ”¯æŒ CSI å·ä»¥åŠéœ€è¦ Kubernetes 1.22 ä»¥ä¸Šç‰ˆæœ¬ã€‚ å·çš„çŠ¶æ€ Availableï¼ˆå¯ç”¨ï¼‰-- å·æ˜¯ä¸€ä¸ªç©ºé—²èµ„æºï¼Œå°šæœªç»‘å®šåˆ°ä»»ä½•ï¼› Boundï¼ˆå·²ç»‘å®šï¼‰-- è¯¥å·å·²ç»ç»‘å®šåˆ°æŸä¸ªæŒä¹…å·å£°æ˜ä¸Šï¼› Releasedï¼ˆå·²é‡Šæ”¾ï¼‰-- æ‰€ç»‘å®šçš„å£°æ˜å·²è¢«åˆ é™¤ï¼Œä½†æ˜¯èµ„æºå°šæœªè¢«é›†ç¾¤å›æ”¶ï¼› Failedï¼ˆå¤±è´¥ï¼‰-- å·çš„è‡ªåŠ¨å›æ”¶æ“ä½œå¤±è´¥ã€‚ **åˆ é™¤ pod åï¼Œpod ä¸­çš„æŒä¹…å·å£°æ˜å’ŒæŒä¹…å·éƒ½ä¸ä¼šè¢«åˆ é™¤ï¼Œéœ€æ‰‹åŠ¨æ¸…é™¤ # åˆ é™¤pod $ kubectl delete pod mysql-pod pod \"mysql-pod\" deleted # pvcå’Œpvè¿˜åœ¨ $ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-pv-claim Bound local-pv-1 1Gi RWO local-storage 19m # pv RECLAIM POLICYçŠ¶æ€å˜ä¸º Delete $ kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE local-pv-1 1Gi RWO Delete Bound default/local-pv-claim local-storage 23m # åˆ é™¤pvc $ kubectl delete pvc local-pv-claim persistentvolumeclaim \"local-pv-claim\" deleted $ kubectl get pvc No resources found in default namespace. $ pvçŠ¶æ€failed $ kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE local-pv-1 1Gi RWO Delete Failed default/local-pv-claim local-storage 24m # åˆ é™¤pv $ kubectl delete pv local-pv-1 persistentvolume \"local-pv-1\" deleted $ kubectl get pv No resources found å·æ¨¡å¼ å·æ¨¡å¼(volumeMode)æ˜¯ä¸€ä¸ªå¯é€‰å‚æ•°ã€‚ é’ˆå¯¹ PV æŒä¹…å·ï¼ŒKubernetes æ”¯æŒä¸¤ç§å·æ¨¡å¼ï¼ˆvolumeModesï¼‰ï¼š â— Filesystemï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰ é»˜è®¤çš„å·æ¨¡å¼ã€‚ â— Blockï¼ˆå—ï¼‰ å°†å·ä½œä¸ºåŸå§‹å—è®¾å¤‡æ¥ä½¿ç”¨ã€‚ å‚è€ƒæ–‡æ¡£ï¼š https://kubernetes.io/zh-cn/docs/concepts/storage/volumes/ https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/ https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-persistent-volume-storage/ "},"runapp/storage_class.html":{"url":"runapp/storage_class.html","title":"å­˜å‚¨ç±»(StorageClass)","keywords":"","body":"å­˜å‚¨ç±»(StorageClass) åˆ›å»ºæŒä¹…å·(PV) é™æ€åˆ›å»º ç®¡ç†å‘˜é¢„å…ˆæ‰‹åŠ¨åˆ›å»º æ‰‹åŠ¨åˆ›å»ºéº»çƒ¦ã€ä¸å¤Ÿçµæ´»ï¼ˆlocal å·ä¸æ”¯æŒåŠ¨æ€åˆ›å»ºï¼Œå¿…é¡»æ‰‹åŠ¨åˆ›å»º PVï¼‰ èµ„æºæµªè´¹ï¼ˆä¾‹å¦‚ä¸€ä¸ª PVC å¯èƒ½åŒ¹é…åˆ°æ¯”å£°æ˜å®¹é‡å¤§çš„å·ï¼‰ å¯¹è‡ªåŠ¨åŒ–å·¥å…·ä¸å¤Ÿå‹å¥½ åŠ¨æ€åˆ›å»º æ ¹æ®ç”¨æˆ·è¯·æ±‚æŒ‰éœ€åˆ›å»ºæŒä¹…å·ï¼Œåœ¨ç”¨æˆ·è¯·æ±‚æ—¶è‡ªåŠ¨åˆ›å»º åŠ¨æ€åˆ›å»ºéœ€è¦ä½¿ç”¨å­˜å‚¨ç±»ï¼ˆStorageClassï¼‰ ç”¨æˆ·éœ€è¦åœ¨æŒä¹…å·å£°æ˜(PVC)ä¸­æŒ‡å®šå­˜å‚¨ç±»æ¥è‡ªåŠ¨åˆ›å»ºå£°æ˜ä¸­çš„å·ã€‚ å¦‚æœæ²¡æœ‰æŒ‡å®šå­˜å‚¨ç±»ï¼Œä½¿ç”¨é›†ç¾¤ä¸­é»˜è®¤çš„å­˜å‚¨ç±»ã€‚ å­˜å‚¨ç±»(StorageClass) ä¸€ä¸ªé›†ç¾¤å¯ä»¥å­˜åœ¨å¤šä¸ªå­˜å‚¨ç±»ï¼ˆStorageClassï¼‰æ¥åˆ›å»ºå’Œç®¡ç†ä¸åŒç±»å‹çš„å­˜å‚¨ã€‚ æ¯ä¸ª StorageClass éƒ½æœ‰ä¸€ä¸ªåˆ¶å¤‡å™¨ï¼ˆProvisionerï¼‰ï¼Œç”¨æ¥å†³å®šä½¿ç”¨å“ªä¸ªå·æ’ä»¶åˆ›å»ºæŒä¹…å·ã€‚ è¯¥å­—æ®µå¿…é¡»æŒ‡å®šã€‚ Local Path Provisioner kubectl get sc NAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGE local-path (default) rancher.io/local-path Delete WaitForFirstConsumer false 131m local-storage kubernetes.io/no-provisioner Delete Immediate false 35m K3s è‡ªå¸¦äº†ä¸€ä¸ªåä¸º local-path çš„å­˜å‚¨ç±»(StorageClass)ï¼Œå®ƒæ”¯æŒ åŠ¨æ€åˆ›å»º åŸºäº hostPath æˆ– local çš„æŒä¹…å·ã€‚ åˆ›å»º PVC åï¼Œä¼šè‡ªåŠ¨åˆ›å»º PVï¼Œä¸éœ€è¦å†å»æ‰‹åŠ¨çš„åˆ›å»º PVã€‚ åˆ é™¤ PVCï¼ŒPV ä¹Ÿä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚ apiVersion: v1 kind: PersistentVolumeClaim metadata: name: local-pvc-1 namespace: default spec: accessModes: - ReadWriteOnce storageClassName: local-path resources: requests: storage: 1Gi åˆ›å»º localpath å£°æ˜ $ kubectl apply -f local-path-pvc.yaml persistentvolumeclaim/local-pvc-1 created $ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-pvc-1 Pending local-path 7s # å› ä¸ºåˆ›å»ºçš„localpath ç»‘å®šæ¨¡å¼ä¸º WaitForFirstConsumerï¼Œæ‰€ä»¥ä¸ä¼šæœ‰pv $ kubectl get pv No resources found å·ç»‘å®šæ¨¡å¼ volumeBindingMode ç”¨äºæ§åˆ¶ä»€ä¹ˆæ—¶å€™åŠ¨æ€åˆ›å»ºå·å’Œç»‘å®šå·ã€‚ Immediate ç«‹å³åˆ›å»º åˆ›å»º PVC åï¼Œç«‹å³åˆ›å»º PV å¹¶å®Œæˆç»‘å®šã€‚ WaitForFirstConsumer å»¶è¿Ÿåˆ›å»º å½“ä½¿ç”¨è¯¥ PVC çš„ Pod è¢«åˆ›å»ºæ—¶ï¼Œæ‰ä¼šè‡ªåŠ¨åˆ›å»º PV å¹¶å®Œæˆç»‘å®šã€‚ ä½¿ç”¨ mysql-pod ç»‘å®š localpath çš„æŒä¹…å· apiVersion: v1 kind: Secret metadata: name: mysql-password type: Opaque data: # åŠ å¯†åçš„å¯†ç  PASSWORD: MTIzNDU2Cg== --- apiVersion: v1 kind: Pod metadata: name: mysql-pod labels: app: mysql spec: containers: - name: mysql image: mysql:5.7 env: - name: MYSQL_ROOT_PASSWORD valueFrom: secretKeyRef: name: mysql-password key: PASSWORD optional: false # è¡¨ç¤ºä¸ä½¿ç”¨é»˜è®¤å€¼ volumeMounts: - mountPath: /var/lib/mysql name: data-volume - mountPath: /etc/mysql/conf.d name: conf-volume readOnly: true volumes: - name: conf-volume configMap: name: mysql-config - name: data-volume persistentVolumeClaim: claimName: local-pvc-1 # hostPath: # # directory location on host # path: /src/mysqldata # # this field is optional # type: DirectoryOrCreate --- apiVersion: v1 kind: ConfigMap metadata: name: mysql-config data: mysql.cnf: | [mysqld] character-set-server=utf8mb4 collation-server=utf8mb4_general_ci init-connect='SET NAMES utf8mb4' [client] default-character-set=utf8mb4 [mysql] default-character-set=utf8mb4 $ kubectl apply -f mysql-pod_pvc_localpath.yml secret/mysql-password unchanged pod/mysql-pod created configmap/mysql-config unchanged # å¯ä»¥çœ‹åˆ°ç»‘å®šæˆåŠŸ $ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-pvc-1 Bound pvc-04601457-1ff9-4c53-9817-643e62fe01e2 1Gi RWO local-path 8m13s $ kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE pvc-04601457-1ff9-4c53-9817-643e62fe01e2 1Gi RWO Delete Bound default/local-pvc-1 local-path 29s åˆ é™¤ pod å pvc å’Œ pv ä¸ä¼šè¢«åˆ é™¤ $ kubectl delete pod mysql-pod pod \"mysql-pod\" deleted $ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-pvc-1 Bound pvc-04601457-1ff9-4c53-9817-643e62fe01e2 1Gi RWO local-path 11m $ kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE pvc-04601457-1ff9-4c53-9817-643e62fe01e2 1Gi RWO Delete Bound default/local-pvc-1 local-path 3m11s åˆ é™¤ pvc å pv ä¼šå…ˆé‡Šæ”¾ï¼Œé‡Šæ”¾ç»“æŸåæ¸…ç©ºèµ„æº $ kubectl delete pvc local-pvc-1 persistentvolumeclaim \"local-pvc-1\" deleted $ kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE pvc-04601457-1ff9-4c53-9817-643e62fe01e2 1Gi RWO Delete Released default/local-pvc-1 local-path 3m47s $ kubectl get pv No resources found å›æ”¶ç­–ç•¥ï¼ˆReclaim Policyï¼‰ å›æ”¶ç­–ç•¥å‘Šè¯‰é›†ç¾¤ï¼Œå½“ç”¨æˆ·åˆ é™¤ PVC å¯¹è±¡æ—¶ï¼Œ ä» PVC ä¸­é‡Šæ”¾å‡ºæ¥çš„ PV å°†è¢«å¦‚ä½•å¤„ç†ã€‚ â— åˆ é™¤ï¼ˆDeleteï¼‰ å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤ä¸º Delete å½“ PVC è¢«åˆ é™¤æ—¶ï¼Œå…³è”çš„ PV å¯¹è±¡ä¹Ÿä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚ â— ä¿ç•™ï¼ˆRetainï¼‰ å½“ PVC å¯¹è±¡è¢«åˆ é™¤æ—¶ï¼ŒPV å·ä»ç„¶å­˜åœ¨ï¼Œæ•°æ®å·çŠ¶æ€å˜ä¸º\"å·²é‡Šæ”¾(Released)\"ã€‚ æ­¤æ—¶å·ä¸Šä»ä¿ç•™æœ‰æ•°æ®ï¼Œè¯¥å·è¿˜ä¸èƒ½ç”¨äºå…¶ä»– PVCã€‚éœ€è¦æ‰‹åŠ¨åˆ é™¤ PVã€‚ å‚è€ƒæ–‡æ¡£ï¼š https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/ https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/#volume-binding-mode https://rancher.com/docs/k3s/latest/en/storage/ "},"runapp/stateful_set.html":{"url":"runapp/stateful_set.html","title":"StatefulSet(æœ‰çŠ¶æ€åº”ç”¨é›†)","keywords":"","body":"StatefulSet(æœ‰çŠ¶æ€åº”ç”¨é›†) StatefulSet å¦‚æœæˆ‘ä»¬éœ€è¦éƒ¨ç½²å¤šä¸ª MySQL å®ä¾‹ï¼Œå°±éœ€è¦ç”¨åˆ° StatefulSetã€‚ StatefulSet æ˜¯ç”¨æ¥ç®¡ç†æœ‰çŠ¶æ€çš„åº”ç”¨ã€‚ä¸€èˆ¬ç”¨äºç®¡ç†æ•°æ®åº“ã€ç¼“å­˜ç­‰ã€‚ ä¸ Deployment ç±»ä¼¼ï¼Œ StatefulSet ç”¨æ¥ç®¡ç† Pod é›†åˆçš„éƒ¨ç½²å’Œæ‰©ç¼©ã€‚ Deployment ç”¨æ¥éƒ¨ç½²æ— çŠ¶æ€åº”ç”¨ã€‚StatefulSet ç”¨æ¥æœ‰çŠ¶æ€åº”ç”¨ã€‚ åˆ›å»º StatefulSet StatefulSet é…ç½®æ¨¡ç‰ˆ apiVersion: apps/v1 kind: StatefulSet metadata: name: mysql-sts spec: selector: matchLabels: app: mysql # å¿…é¡»åŒ¹é… .spec.template.metadata.labels serviceName: \"mysql-svc\" replicas: 3 # é»˜è®¤å€¼æ˜¯ 1 minReadySeconds: 10 # é»˜è®¤å€¼æ˜¯ 0 template: metadata: labels: app: mysql # å¿…é¡»åŒ¹é… .spec.selector.matchLabels spec: terminationGracePeriodSeconds: 10 containers: - name: mysql image: mysql:5.7 env: - name: MYSQL_ROOT_PASSWORD value: \"123456\" ports: - containerPort: 3306 volumeMounts: - mountPath: /var/lib/mysql #å®¹å™¨ä¸­çš„ç›®å½• name: data-volume volumeClaimTemplates: - metadata: name: data-volume spec: accessModes: [\"ReadWriteOnce\"] storageClassName: local-path resources: requests: storage: 1Gi ç¨³å®šçš„å­˜å‚¨ åœ¨ StatefulSet ä¸­ä½¿ç”¨ VolumeClaimTemplateï¼Œä¸ºæ¯ä¸ª Pod åˆ›å»ºæŒä¹…å·å£°æ˜(PVC)ã€‚ æ¯ä¸ª Pod å°†ä¼šå¾—åˆ°åŸºäº local-path å­˜å‚¨ç±»åŠ¨æ€åˆ›å»ºçš„æŒä¹…å·(PV)ã€‚ Pod åˆ›å»º(æˆ–é‡æ–°è°ƒåº¦ï¼‰æ—¶ï¼Œä¼šæŒ‚è½½ä¸å…¶å£°æ˜ç›¸å…³è”çš„æŒä¹…å·ã€‚ è¯·æ³¨æ„ï¼Œå½“ Pod æˆ–è€… StatefulSet è¢«åˆ é™¤æ—¶ï¼ŒæŒä¹…å·å£°æ˜å’Œå…³è”çš„æŒä¹…å·ä¸ä¼šè¢«åˆ é™¤ã€‚ Pod æ ‡è¯† åœ¨å…·æœ‰ N ä¸ªå‰¯æœ¬çš„ StatefulSet ä¸­ï¼Œæ¯ä¸ª Pod ä¼šè¢«åˆ†é…ä¸€ä¸ªä» 0 åˆ° N-1 çš„æ•´æ•°åºå·ï¼Œè¯¥åºå·åœ¨æ­¤ StatefulSet ä¸Šæ˜¯å”¯ä¸€çš„ã€‚ StatefulSet ä¸­çš„æ¯ä¸ª Pod ä¸»æœºåçš„æ ¼å¼ä¸º StatefulSet åç§°-åºå·ã€‚ ä¸Šä¾‹å°†ä¼šåˆ›å»ºä¸‰ä¸ªåç§°åˆ†åˆ«ä¸º mysql-0ã€mysql-1ã€mysql-2 çš„ Podã€‚ éƒ¨ç½²å’Œæ‰©ç¼©ä¿è¯ å¯¹äºåŒ…å« N ä¸ª å‰¯æœ¬çš„ StatefulSetï¼Œå½“éƒ¨ç½² Pod æ—¶ï¼Œå®ƒä»¬æ˜¯ä¾æ¬¡åˆ›å»ºçš„ï¼Œé¡ºåºä¸º 0..N-1ã€‚ å½“åˆ é™¤ Pod æ—¶ï¼Œå®ƒä»¬æ˜¯é€†åºç»ˆæ­¢çš„ï¼Œé¡ºåºä¸º N-1..0ã€‚ åœ¨å°†æ‰©ç¼©æ“ä½œåº”ç”¨åˆ° Pod ä¹‹å‰ï¼Œå®ƒå‰é¢çš„æ‰€æœ‰ Pod å¿…é¡»æ˜¯ Running å’Œ Ready çŠ¶æ€ã€‚ åœ¨ä¸€ä¸ª Pod ç»ˆæ­¢ä¹‹å‰ï¼Œæ‰€æœ‰çš„ç»§ä»»è€…å¿…é¡»å®Œå…¨å…³é—­ã€‚ # è¿è¡Œ $ kubectl apply -f statefulset.yaml statefulset.apps/mysql-sts created # è§‚å¯Ÿè¿›åº¦ $ kubectl get pod --watch NAME READY STATUS RESTARTS AGE mysql-sts-0 0/1 Pending 0 0s mysql-sts-0 0/1 Pending 0 17s mysql-sts-0 0/1 ContainerCreating 0 17s mysql-sts-0 1/1 Running 0 22s mysql-sts-1 0/1 Pending 0 0s mysql-sts-1 0/1 Pending 0 18s mysql-sts-1 0/1 ContainerCreating 0 19s mysql-sts-1 1/1 Running 0 35s mysql-sts-2 0/1 Pending 0 0s mysql-sts-2 0/1 Pending 0 16s mysql-sts-2 0/1 ContainerCreating 0 16s mysql-sts-2 1/1 Running 0 63s åœ¨ä¸Šé¢çš„ mysql ç¤ºä¾‹è¢«åˆ›å»ºåï¼Œä¼šæŒ‰ç…§ mysql-0ã€mysql-1ã€mysql-2 çš„é¡ºåºéƒ¨ç½²ä¸‰ä¸ª Podã€‚ åœ¨ mysql-0 è¿›å…¥ Running å’Œ Ready çŠ¶æ€å‰ä¸ä¼šéƒ¨ç½² mysql-1ã€‚ åœ¨ mysql-1 è¿›å…¥ Running å’Œ Ready çŠ¶æ€å‰ä¸ä¼šéƒ¨ç½² mysql-2ã€‚ å¦‚æœ mysql-1 å·²ç»å¤„äº Running å’Œ Ready çŠ¶æ€ï¼Œè€Œ mysql-2 å°šæœªéƒ¨ç½²ï¼Œåœ¨æ­¤æœŸé—´å‘ç”Ÿäº† mysql-0 è¿è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆ mysql-2 å°†ä¸ä¼šè¢«éƒ¨ç½²ï¼Œè¦ç­‰åˆ° mysql-0 éƒ¨ç½²å®Œæˆå¹¶è¿›å…¥ Running å’Œ Ready çŠ¶æ€åï¼Œæ‰ä¼šéƒ¨ç½² mysql-2ã€‚ å¦‚æœç”¨æˆ·æƒ³å°†ç¤ºä¾‹ä¸­çš„ StatefulSet æ‰©ç¼©ä¸º replicas=1ï¼Œé¦–å…ˆè¢«ç»ˆæ­¢çš„æ˜¯ mysql-2ã€‚ åœ¨ mysql-2 æ²¡æœ‰è¢«å®Œå…¨åœæ­¢å’Œåˆ é™¤å‰ï¼Œmysql-1 ä¸ä¼šè¢«ç»ˆæ­¢ã€‚ å½“ mysql-2 å·²è¢«ç»ˆæ­¢å’Œåˆ é™¤ã€mysql-1 å°šæœªè¢«ç»ˆæ­¢ï¼Œå¦‚æœåœ¨æ­¤æœŸé—´å‘ç”Ÿ mysql-0 è¿è¡Œå¤±è´¥ï¼Œ é‚£ä¹ˆå°±ä¸ä¼šç»ˆæ­¢ mysql-1ï¼Œå¿…é¡»ç­‰åˆ° mysql-0 è¿›å…¥ Running å’Œ Ready çŠ¶æ€åæ‰ä¼šç»ˆæ­¢ web-1ã€‚ å‚è€ƒæ–‡æ¡£ï¼šhttps://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/statefulset/ https://kubernetes.io/zh-cn/docs/tasks/run-application/run-replicated-stateful-application/ "},"runapp/headless_service.html":{"url":"runapp/headless_service.html","title":"Headless Service(æ— å¤´æœåŠ¡)","keywords":"","body":"Headless Service(æ— å¤´æœåŠ¡) ä¹‹å‰æˆ‘ä»¬åˆ›å»ºäº†ä¸‰ä¸ªå„è‡ªç‹¬ç«‹çš„æ•°æ®åº“å®ä¾‹ï¼Œmysql-0ï¼Œmysql-1ï¼Œmysql-2ã€‚ è¦æƒ³è®©åˆ«çš„å®¹å™¨è®¿é—®æ•°æ®åº“ï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒå‘å¸ƒä¸º Serviceï¼Œä½†æ˜¯ Service å¸¦è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½ä¼šè½¬å‘ç»™ä¸åŒçš„æ•°æ®åº“ï¼Œè¿™æ ·å­ä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šæœ‰å¾ˆå¤§çš„é—®é¢˜ã€‚ æ— å¤´æœåŠ¡ï¼ˆHeadless Servicesï¼‰ æ— å¤´æœåŠ¡ï¼ˆHeadless Serviceï¼‰å¯ä»¥ä¸º StatefulSet æˆå‘˜æä¾›ç¨³å®šçš„ DNS åœ°å€ã€‚ åœ¨ä¸éœ€è¦è´Ÿè½½å‡è¡¡çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®š Cluster IP çš„å€¼ä¸º \"None\" æ¥åˆ›å»ºæ— å¤´æœåŠ¡ã€‚ æ³¨æ„:StatefulSetä¸­çš„ServiceNameå¿…é¡»è¦è·ŸServiceä¸­çš„metadata.nameä¸€è‡´ # ä¸º StatefulSet æˆå‘˜æä¾›ç¨³å®šçš„ DNS è¡¨é¡¹çš„æ— å¤´æœåŠ¡ï¼ˆHeadless Serviceï¼‰ apiVersion: v1 kind: Service metadata: #é‡è¦ï¼è¿™é‡Œçš„åå­—è¦è·Ÿåé¢StatefulSeté‡ŒServiceNameä¸€è‡´ name: mysql-svc labels: app: mysql-svc spec: ports: - name: mysql port: 3306 # è®¾ç½®Headless Service clusterIP: None selector: app: mysql --- apiVersion: apps/v1 kind: StatefulSet metadata: name: mysql-sts spec: selector: matchLabels: app: mysql # å¿…é¡»åŒ¹é… .spec.template.metadata.labels serviceName: \"mysql-svc\" replicas: 3 # é»˜è®¤å€¼æ˜¯ 1 minReadySeconds: 10 # é»˜è®¤å€¼æ˜¯ 0 template: metadata: labels: app: mysql # å¿…é¡»åŒ¹é… .spec.selector.matchLabels spec: terminationGracePeriodSeconds: 10 containers: - name: mysql image: mysql:5.7 env: - name: MYSQL_ROOT_PASSWORD value: \"123456\" ports: - containerPort: 3306 volumeMounts: - mountPath: /var/lib/mysql #å®¹å™¨ä¸­çš„ç›®å½• name: data-volume volumeClaimTemplates: - metadata: name: data-volume spec: accessModes: [\"ReadWriteOnce\"] storageClassName: local-path resources: requests: storage: 1Gi $ kubectl apply -f statefulset_headless.yaml service/mysql-svc created statefulset.apps/mysql-sts configured $ kubectl describe svc/mysql-svc Name: mysql-svc Namespace: default Labels: app=mysql-svc Annotations: Selector: app=mysql Type: ClusterIP IP Family Policy: SingleStack IP Families: IPv4 IP: None IPs: None Port: mysql 3306/TCP TargetPort: 3306/TCP Endpoints: 10.42.0.6:3306,10.42.1.8:3306,10.42.2.12:3306 Session Affinity: None Events: # å¯ä»¥çœ‹åˆ° CLUSTER-IP ä¸º None $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 443/TCP 177m mysql-svc ClusterIP None 3306/TCP 37s ç¨³å®šçš„ç½‘ç»œ ID StatefulSet ä¸­çš„æ¯ä¸ª Pod éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ª StatefulSet åç§°-åºå·æ ¼å¼çš„ä¸»æœºåã€‚ é›†ç¾¤å†…ç½®çš„ DNS ä¼šä¸º Service åˆ†é…ä¸€ä¸ªå†…éƒ¨åŸŸå db.default.svc.cluster.local,å®ƒçš„æ ¼å¼ä¸º æœåŠ¡åç§°.å‘½åç©ºé—´.svc.cluster.localã€‚ Service ä¸‹çš„æ¯ä¸ª Pod ä¼šè¢«åˆ†é…ä¸€ä¸ªå­åŸŸåï¼Œæ ¼å¼ä¸º pod åç§°.æ‰€å±æœåŠ¡çš„åŸŸåï¼Œä¾‹å¦‚ mysql-0 çš„åŸŸåä¸º mysql-0.db.default.svc.cluster.localã€‚ åˆ›å»º Pod æ—¶ï¼ŒDNS åŸŸåç”Ÿæ•ˆå¯èƒ½ä¼šæœ‰ä¸€äº›å»¶è¿Ÿ(å‡ ç§’æˆ–å‡ åç§’)ã€‚ Pod ä¹‹é—´å¯ä»¥é€šè¿‡ DNS åŸŸåè®¿é—®ï¼ŒåŒä¸€ä¸ªå‘½åç©ºé—´ä¸‹å¯ä»¥çœç•¥å‘½åç©ºé—´åŠå…¶ä¹‹åçš„å†…å®¹ã€‚ æŸ¥çœ‹ä¸»èŠ‚ç‚¹ host æ–‡ä»¶ $ cat /etc/hosts # Kubernetes-managed hosts file. 127.0.0.1 localhost ::1 localhost ip6-localhost ip6-loopback fe00::0 ip6-localnet fe00::0 ip6-mcastprefix fe00::1 ip6-allnodes fe00::2 ip6-allrouters 10.42.1.8 mysql-sts-0.mysql-svc.default.svc.cluster.local mysql-sts-0 æ–° pod å¯ä»¥çœ‹åˆ°è®¿é—®è·¯ç”± $ kubectl run dns-test -ti --image=busybox:1.28 --rm If you don't see a command prompt, try pressing enter. / # nslookup mysql-svc Server: 10.43.0.10 Address 1: 10.43.0.10 kube-dns.kube-system.svc.cluster.local Name: mysql-svc Address 1: 10.42.0.6 mysql-sts-2.mysql-svc.default.svc.cluster.local Address 2: 10.42.1.8 mysql-sts-0.mysql-svc.default.svc.cluster.local Address 3: 10.42.2.12 mysql-sts-1.mysql-svc.default.svc.cluster.local / # nslookup mysql-sts-0.mysql-svc Server: 10.43.0.10 Address 1: 10.43.0.10 kube-dns.kube-system.svc.cluster.local Name: mysql-sts-0.mysql-svc Address 1: 10.42.1.8 mysql-sts-0.mysql-svc.default.svc.cluster.local æ¸…é™¤ $ kubectl delete -f statefulset_headless.yaml service \"mysql-svc\" deleted statefulset.apps \"mysql-sts\" deleted å‚è€ƒæ–‡æ¡£ï¼š https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/statefulset/ https://kubernetes.io/zh-cn/docs/tutorials/stateful-application/basic-stateful-set/ https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#headless-services https://kubernetes.io/zh-cn/docs/tasks/run-application/run-replicated-stateful-application/ https://kubernetes.io/zh-cn/docs/concepts/services-networking/dns-pod-service/ "},"runapp/mysql_replicate.html":{"url":"runapp/mysql_replicate.html","title":"Mysql ä¸»ä»å¤åˆ¶","keywords":"","body":"Mysql ä¸»ä»å¤åˆ¶ æ³¨æ„ 1.æœ¬ä¾‹å­é…ç½®æ¯”è¾ƒå¤æ‚ï¼Œä»…ç”¨äºè®²è§£åŸç†ï¼Œæ— éœ€æŒæ¡é…ç½®ç»†èŠ‚ã€‚ 2.åé¢æˆ‘ä»¬ä¼šè®²ä½¿ç”¨helmè‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œç”¨èµ·æ¥éå¸¸ç®€å•ã€‚ 3.æœ¬ä¾‹å­ä¸èƒ½ç”¨äºç”Ÿäº§ï¼Œmysqlçš„å¯†ç å…è®¸è®¾ç½®ä¸ºç©ºã€‚ ä¸‹é¢æ˜¯éƒ¨ç½²ä¸€ä¸ªè¯»å†™åˆ†ç¦» Mysql æ•°æ®åº“çš„ç¤ºæ„å›¾ã€‚ é€šè¿‡éƒ¨ç½²æ— å¤´æœåŠ¡(Headless Service)å°†å†™æ“ä½œæŒ‡å‘å›ºå®šçš„æ•°æ®åº“ã€‚ éƒ¨ç½²ä¸€ä¸ª Service ç”¨æ¥åšè¯»æ“ä½œçš„è´Ÿè½½å‡è¡¡ã€‚ æ•°æ®åº“ä¹‹é—´é€šè¿‡åŒæ­¥ç¨‹åºä¿æŒæ•°æ®ä¸€è‡´ã€‚ Mysql ä¸»ä»å¤åˆ¶ è¿è¡Œä¸€ä¸ªæœ‰çŠ¶æ€çš„åº”ç”¨ç¨‹åº æ³¨æ„ï¼š 1.å®˜æ–¹çš„å®‰è£…æ–‡æ¡£æœ‰é”™è¯¯ï¼Œmysqlé•œåƒéœ€è¦ä½¿ç”¨mysql:5.7-debianã€‚å¦åˆ™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š è¯¦è§ï¼š https://github.com/kubernetes/website/pull/35857 2.è°·æ­Œçš„é•œåƒgcr.io/google-samples/xtrabackup:1.0è®¿é—®ä¸åˆ°ï¼Œä½¿ç”¨ist0ne/xtrabackup:1.0ä»£æ›¿ apiVersion: v1 kind: ConfigMap metadata: name: mysql labels: app: mysql app.kubernetes.io/name: mysql data: primary.cnf: | # ä»…åœ¨ä¸»æœåŠ¡å™¨ä¸Šåº”ç”¨æ­¤é…ç½® [mysqld] log-bin replica.cnf: | # ä»…åœ¨å‰¯æœ¬æœåŠ¡å™¨ä¸Šåº”ç”¨æ­¤é…ç½® [mysqld] super-read-only --- # ä¸º StatefulSet æˆå‘˜æä¾›ç¨³å®šçš„ DNS è¡¨é¡¹çš„æ— å¤´æœåŠ¡ï¼ˆHeadless Serviceï¼‰ apiVersion: v1 kind: Service metadata: name: mysql labels: app: mysql app.kubernetes.io/name: mysql spec: ports: - name: mysql port: 3306 clusterIP: None selector: app: mysql --- # ç”¨äºè¿æ¥åˆ°ä»»ä¸€ MySQL å®ä¾‹æ‰§è¡Œè¯»æ“ä½œçš„å®¢æˆ·ç«¯æœåŠ¡ # å¯¹äºå†™æ“ä½œï¼Œä½ å¿…é¡»è¿æ¥åˆ°ä¸»æœåŠ¡å™¨ï¼šmysql-0.mysql apiVersion: v1 kind: Service metadata: name: mysql-read labels: app: mysql app.kubernetes.io/name: mysql readonly: \"true\" spec: ports: - name: mysql port: 3306 selector: app: mysql --- apiVersion: apps/v1 kind: StatefulSet metadata: name: mysql spec: selector: matchLabels: app: mysql app.kubernetes.io/name: mysql serviceName: mysql replicas: 3 template: metadata: labels: app: mysql app.kubernetes.io/name: mysql spec: initContainers: - name: init-mysql image: mysql:5.7-debian command: - bash - \"-c\" - | set -ex # åŸºäº Pod åºå·ç”Ÿæˆ MySQL æœåŠ¡å™¨çš„ IDã€‚ [[ $HOSTNAME =~ -([0-9]+)$ ]] || exit 1 ordinal=${BASH_REMATCH[1]} echo [mysqld] > /mnt/conf.d/server-id.cnf # æ·»åŠ åç§»é‡ä»¥é¿å…ä½¿ç”¨ server-id=0 è¿™ä¸€ä¿ç•™å€¼ã€‚ echo server-id=$((100 + $ordinal)) >> /mnt/conf.d/server-id.cnf # å°†åˆé€‚çš„ conf.d æ–‡ä»¶ä» config-map å¤åˆ¶åˆ° emptyDirã€‚ if [[ $ordinal -eq 0 ]]; then cp /mnt/config-map/primary.cnf /mnt/conf.d/ else cp /mnt/config-map/replica.cnf /mnt/conf.d/ fi volumeMounts: - name: conf mountPath: /mnt/conf.d - name: config-map mountPath: /mnt/config-map - name: clone-mysql image: ist0ne/xtrabackup:1.0 command: - bash - \"-c\" - | set -ex # å¦‚æœå·²æœ‰æ•°æ®ï¼Œåˆ™è·³è¿‡å…‹éš†ã€‚ [[ -d /var/lib/mysql/mysql ]] && exit 0 # è·³è¿‡ä¸»å®ä¾‹ï¼ˆåºå·ç´¢å¼• 0ï¼‰çš„å…‹éš†ã€‚ [[ `hostname` =~ -([0-9]+)$ ]] || exit 1 ordinal=${BASH_REMATCH[1]} [[ $ordinal -eq 0 ]] && exit 0 # ä»åŸæ¥çš„å¯¹ç­‰èŠ‚ç‚¹å…‹éš†æ•°æ®ã€‚ ncat --recv-only mysql-$(($ordinal-1)).mysql 3307 | xbstream -x -C /var/lib/mysql # å‡†å¤‡å¤‡ä»½ã€‚ xtrabackup --prepare --target-dir=/var/lib/mysql volumeMounts: - name: data mountPath: /var/lib/mysql subPath: mysql - name: conf mountPath: /etc/mysql/conf.d containers: - name: mysql image: mysql:5.7-debian env: - name: MYSQL_ALLOW_EMPTY_PASSWORD value: \"1\" ports: - name: mysql containerPort: 3306 volumeMounts: - name: data mountPath: /var/lib/mysql subPath: mysql - name: conf mountPath: /etc/mysql/conf.d resources: requests: cpu: 500m memory: 1Gi livenessProbe: exec: command: [\"mysqladmin\", \"ping\"] initialDelaySeconds: 30 periodSeconds: 10 timeoutSeconds: 5 readinessProbe: exec: # æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å¯ä»¥é€šè¿‡ TCP æ‰§è¡ŒæŸ¥è¯¢ï¼ˆskip-networking æ˜¯å…³é—­çš„ï¼‰ã€‚ command: [\"mysql\", \"-h\", \"127.0.0.1\", \"-e\", \"SELECT 1\"] initialDelaySeconds: 5 periodSeconds: 2 timeoutSeconds: 1 - name: xtrabackup image: ist0ne/xtrabackup:1.0 ports: - name: xtrabackup containerPort: 3307 command: - bash - \"-c\" - | set -ex cd /var/lib/mysql # ç¡®å®šå…‹éš†æ•°æ®çš„ binlog ä½ç½®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚ if [[ -f xtrabackup_slave_info && \"x$( change_master_to.sql.in # åœ¨è¿™é‡Œè¦å¿½ç•¥ xtrabackup_binlog_info ï¼ˆå®ƒæ˜¯æ²¡ç”¨çš„ï¼‰ã€‚ rm -f xtrabackup_slave_info xtrabackup_binlog_info elif [[ -f xtrabackup_binlog_info ]]; then # æˆ‘ä»¬ç›´æ¥ä»ä¸»å®ä¾‹è¿›è¡Œå…‹éš†ã€‚è§£æ binlog ä½ç½®ã€‚ [[ `cat xtrabackup_binlog_info` =~ ^(.*?)[[:space:]]+(.*?)$ ]] || exit 1 rm -f xtrabackup_binlog_info xtrabackup_slave_info echo \"CHANGE MASTER TO MASTER_LOG_FILE='${BASH_REMATCH[1]}',\\ MASTER_LOG_POS=${BASH_REMATCH[2]}\" > change_master_to.sql.in fi # æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦éœ€è¦é€šè¿‡å¯åŠ¨å¤åˆ¶æ¥å®Œæˆå…‹éš†ã€‚ if [[ -f change_master_to.sql.in ]]; then echo \"Waiting for mysqld to be ready (accepting connections)\" until mysql -h 127.0.0.1 -e \"SELECT 1\"; do sleep 1; done echo \"Initializing replication from clone position\" mysql -h 127.0.0.1 \\ -e \"$( æ“ä½œä¸»åº“å’Œä»åº“ $ kubectl run mysql-client --image=arey/mysql-client -ti --rm -- mysql -h mysql-0.mysql If you don't see a command prompt, try pressing enter. MySQL [mysql]> CREATE DATABASE test; Query OK, 1 row affected (0.011 sec) MySQL [mysql]> CREATE TABLE test.messages (message VARCHAR(250)); Query OK, 0 rows affected (0.031 sec) MySQL [mysql]> INSERT INTO test.messages VALUES ('hello'); Query OK, 1 row affected (0.024 sec) MySQL [mysql]> SELECT * FROM test.messages; +---------+ | message | +---------+ | hello | +---------+ 1 row in set (0.001 sec) MySQL [mysql]> exit Bye Session ended, resume using 'kubectl attach mysql-client -c mysql-client -i -t' command when the pod is running pod \"mysql-client\" deleted # ç™»å½•ä»åº“ï¼Œéšæœºé€‰æ‹© $ kubectl run mysql-client --image=arey/mysql-client -ti --rm -- mysql -h mysql-read If you don't see a command prompt, try pressing enter. MySQL [mysql]> SELECT * FROM test.messages; +---------+ | message | +---------+ | hello | +---------+ 1 row in set (0.002 sec) # å¯è§ä»åº“æ˜¯åªè¯»çš„ï¼Œä¸èƒ½å†™å…¥ MySQL [mysql]> INSERT INTO test.messages VALUES ('k8s'); ERROR 1290 (HY000): The MySQL server is running with the --super-read-only option so it cannot execute this statement åˆå§‹åŒ–å®¹å™¨(Init Containers) åˆå§‹åŒ–å®¹å™¨(Init Containers)æ˜¯ä¸€ç§ç‰¹æ®Šå®¹å™¨ï¼Œå®ƒåœ¨ Pod å†…çš„åº”ç”¨å®¹å™¨å¯åŠ¨ä¹‹å‰è¿è¡Œã€‚ åˆå§‹åŒ–å®¹å™¨æœªæ‰§è¡Œå®Œæ¯•æˆ–ä»¥é”™è¯¯çŠ¶æ€é€€å‡ºï¼ŒPod å†…çš„åº”ç”¨å®¹å™¨ä¸ä¼šå¯åŠ¨ã€‚ åˆå§‹åŒ–å®¹å™¨éœ€è¦åœ¨ initContainers ä¸­å®šä¹‰ï¼Œä¸ containers åŒçº§ã€‚ åŸºäºä¸Šé¢çš„ç‰¹æ€§ï¼Œåˆå§‹åŒ–å®¹å™¨é€šå¸¸ç”¨äº ç”Ÿæˆé…ç½®æ–‡ä»¶ æ‰§è¡Œåˆå§‹åŒ–å‘½ä»¤æˆ–è„šæœ¬ æ‰§è¡Œå¥åº·æ£€æŸ¥ï¼ˆæ£€æŸ¥ä¾èµ–çš„æœåŠ¡æ˜¯å¦å¤„äº Ready æˆ–å¥åº· Health çš„çŠ¶æ€ï¼‰ åœ¨æœ¬ä¾‹å­ä¸­ï¼Œæœ‰ä¸¤ä¸ªåˆå§‹åŒ–å®¹å™¨ã€‚ init-mysql ä¸º MySQL å®ä¾‹åˆ†é… server-id,å¹¶å°† mysql-0 çš„é…ç½®æ–‡ä»¶è®¾ç½®ä¸º primary.cnf,å…¶ä»–å‰¯æœ¬è®¾ç½®ä¸º replica.cnf clone-mysql ä»å‰ä¸€ä¸ª Pod ä¸­è·å–å¤‡ä»½çš„æ•°æ®æ–‡ä»¶æ”¾åˆ°è‡ªå·±çš„æ•°æ®ç›®å½•ä¸‹ è¾¹è½¦ Sidecar Pod ä¸­è¿è¡Œäº† 2 ä¸ªå®¹å™¨ï¼ŒMySQL å®¹å™¨å’Œä¸€ä¸ªå……å½“è¾…åŠ©å·¥å…·çš„ xtrabackup å®¹å™¨ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºè¾¹è½¦(sidecar)ã€‚ Xtrabackup æ˜¯ä¸€ä¸ªå¼€æºçš„ MySQL å¤‡ä»½å·¥å…·ï¼Œæ”¯æŒåœ¨çº¿çƒ­å¤‡ä»½ï¼ˆå¤‡ä»½æ—¶ä¸å½±å“æ•°æ®è¯»å†™ï¼‰ï¼Œæ˜¯ç›®å‰å„ä¸ªäº‘å‚å•†æ™®éä½¿ç”¨çš„ MySQL å¤‡ä»½å·¥å…·ã€‚ sidecar å®¹å™¨è´Ÿè´£å°†å¤‡ä»½çš„æ•°æ®æ–‡ä»¶å‘é€ç»™ä¸‹ä¸€ä¸ª Podï¼Œå¹¶åœ¨å‰¯æœ¬æœåŠ¡å™¨åˆæ¬¡å¯åŠ¨æ—¶ï¼Œä½¿ç”¨æ•°æ®æ–‡ä»¶å®Œæˆæ•°æ®çš„å¯¼å…¥ã€‚ MySQL ä½¿ç”¨ bin-log åŒæ­¥æ•°æ®ï¼Œä½†æ˜¯ï¼Œå½“æ•°æ®åº“è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œäº§ç”Ÿäº†ä¸€äº›æ•°æ®ï¼Œè¿™æ—¶å€™å¦‚æœæˆ‘ä»¬è¿›è¡Œæ‰©å®¹ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å‰¯æœ¬ï¼Œæœ‰å¯èƒ½è¿½æº¯ä¸åˆ° bin-log çš„æºå¤´(å¯èƒ½è¢«æ‰‹åŠ¨æ¸…ç†æˆ–è€…è¿‡æœŸè‡ªåŠ¨åˆ é™¤)ï¼Œå› æ­¤éœ€è¦å°†ç°æœ‰çš„æ•°æ®å¯¼å…¥åˆ°å‰¯æœ¬ä¹‹åï¼Œå†å¼€å¯æ•°æ®åŒæ­¥ï¼Œsidecar åªè´Ÿè´£æ•°æ®åº“åˆæ¬¡å¯åŠ¨æ—¶å®Œæˆå†å²æ•°æ®å¯¼å…¥ï¼Œåç»­çš„æ•°æ® MySQL ä¼šè‡ªåŠ¨åŒæ­¥ã€‚ å®¢æˆ·ç«¯è¿æ¥ å†™æ“ä½œ å†™æ“ä½œè¿æ¥ mysql-0.mysql, å‚è€ƒ æ“ä½œä¸»åº“å’Œä»åº“ è¯»æ“ä½œ è¯»æ“ä½œè¿æ¥åˆ°mysql-readï¼Œå®ƒæ˜¯ä¸€ä¸ªserviceï¼Œä¼šè‡ªåŠ¨å°†è¯·æ±‚è´Ÿè½½å‡è¡¡åˆ°åç«¯çš„ä¸‰ä¸ª mysql å®ä¾‹ä¸Š, æ“ä½œä¸»åº“å’Œä»åº“ æ¸…ç©º $ kubectl delete -f mysql-cluster.yaml å‚è€ƒæ–‡æ¡£ï¼š https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/init-containers/ https://kubernetes.io/zh-cn/docs/tasks/run-application/run-replicated-stateful-application/ æ·±å…¥ç†è§£ StatefulSet:æœ‰çŠ¶æ€åº”ç”¨å®è·µ "},"runapp/port_forward.html":{"url":"runapp/port_forward.html","title":"Port-forward ç«¯å£è½¬å‘","keywords":"","body":"Port-forward ç«¯å£è½¬å‘ é€šå¸¸ï¼Œé›†ç¾¤ä¸­çš„æ•°æ®åº“ä¸ç›´æ¥å¯¹å¤–è®¿é—®ã€‚ ä½†æ˜¯ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å›¾å½¢åŒ–å·¥å…·è¿æ¥åˆ°æ•°æ®åº“è¿›è¡Œæ“ä½œæˆ–è€…è°ƒè¯•ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç«¯å£è½¬å‘æ¥è®¿é—®é›†ç¾¤ä¸­çš„åº”ç”¨ã€‚ kubectl port-forward å¯ä»¥å°†æœ¬åœ°ç«¯å£çš„è¿æ¥è½¬å‘ç»™å®¹å™¨ã€‚ æ­¤å‘½ä»¤åœ¨å‰å°è¿è¡Œï¼Œå‘½ä»¤ç»ˆæ­¢åï¼Œè½¬å‘ä¼šè¯å°†ç»“æŸã€‚ è¿™ç§ç±»å‹çš„è¿æ¥å¯¹æ•°æ®åº“è°ƒè¯•å¾ˆæœ‰ç”¨ã€‚ $ kubectl port-forward pods/mysql-0 --address=172.29.0.2 33060:3306 Forwarding from 172.29.0.2:33060 -> 3306 Handling connection for 33060 åœ¨å¤–éƒ¨å¯ä»¥ç”¨ ip + ç«¯å£ è®¿é—®äº† $ kubectl run mysql-client --image=arey/mysql-client -ti --rm -- mysql -h 172.29.0.2 -P 33060 If you don't see a command prompt, try pressing enter. MySQL [mysql]> SHOW DATABASES; +------------------------+ | Database | +------------------------+ | information_schema | | mysql | | performance_schema | | sys | | test | | xtrabackup_backupfiles | +------------------------+6 rows in set (0.002 sec) ç½‘ç»œè®¿é—® å®¹å™¨ä¸­åº”ç”¨è®¿é—®æ•°æ®åº“ï¼š è¯»æ“ä½œï¼šmysql-read:3306 å†™æ“ä½œï¼šmysql-0.mysql:3306 é›†ç¾¤ä¸­çš„ Node è®¿é—®ï¼š ClusterIPï¼šport é›†ç¾¤å¤–çš„ä¸»æœºè®¿é—®ï¼š ä¸»æœº IPï¼šnodePort å‚è€ƒèµ„æ–™ï¼šhttps://kubernetes.io/zh-cn/docs/tasks/run-application/run-replicated-stateful-application/ https://kubernetes.io/zh-cn/docs/concepts/services-networking/dns-pod-service/ https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/port-forward-access-application-cluster/ "},"runapp/helm.html":{"url":"runapp/helm.html","title":"Helmå®‰è£…MySQLæœºç¾¤","keywords":"","body":"Helm å®‰è£… MySQL æœºç¾¤ Helm ç®€ä»‹ Helm(http://helm.sh/) æ˜¯ä¸€ä¸ª Kubernetes åº”ç”¨çš„åŒ…ç®¡ç†å·¥å…·ï¼Œç±»ä¼¼äº Ubuntu çš„ APT å’Œ CentOS ä¸­çš„ YUMã€‚ Helm ä½¿ç”¨ chart æ¥å°è£… kubernetes åº”ç”¨çš„ YAML æ–‡ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦è®¾ç½®è‡ªå·±çš„å‚æ•°ï¼Œå°±å¯ä»¥å®ç°è‡ªåŠ¨åŒ–çš„å¿«é€Ÿéƒ¨ç½²åº”ç”¨ã€‚ å®‰è£… Helm å®‰è£… Helm ä¸‹è½½å®‰è£…åŒ…ï¼šhttps://github.com/helm/helm/releases https://get.helm.sh/helm-v3.10.0-linux-amd64.tar.gz mv linux-amd64/helm /usr/local/bin/helm åœ¨ K3s ä¸­ä½¿ç”¨ï¼Œéœ€è¦é…ç½®ç¯å¢ƒå˜é‡ export KUBECONFIG=/etc/rancher/k3s/k3s.yaml ä¸‰å¤§æ¦‚å¿µ Chart ä»£è¡¨ç€ Helm åŒ…ã€‚ å®ƒåŒ…å«è¿è¡Œåº”ç”¨ç¨‹åºéœ€è¦çš„æ‰€æœ‰èµ„æºå®šä¹‰å’Œä¾èµ–ï¼Œç›¸å½“äºæ¨¡ç‰ˆã€‚ ç±»ä¼¼äº maven ä¸­çš„ pom.xmlã€Apt ä¸­çš„ dpkb æˆ– Yum ä¸­çš„ RPMã€‚ Repositoryï¼ˆä»“åº“ï¼‰ ç”¨æ¥å­˜æ”¾å’Œå…±äº« chartsã€‚ ä¸ç”¨çš„åº”ç”¨æ”¾åœ¨ä¸åŒçš„ä»“åº“ä¸­ã€‚ Release æ˜¯è¿è¡Œ chart çš„å®ä¾‹ã€‚ ä¸€ä¸ª chart é€šå¸¸å¯ä»¥åœ¨åŒä¸€ä¸ªé›†ç¾¤ä¸­å®‰è£…å¤šæ¬¡ã€‚ æ¯ä¸€æ¬¡å®‰è£…éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ releaseï¼Œrelease name ä¸èƒ½é‡å¤ã€‚ Helm ä»“åº“ Helm æœ‰ä¸€ä¸ªè·Ÿ docker Hub ç±»ä¼¼çš„åº”ç”¨ä¸­å¿ƒ(https://artifacthub.io/)ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é‡Œé¢æ‰¾åˆ°æˆ‘ä»¬éœ€è¦éƒ¨ç½²çš„åº”ç”¨ã€‚ å®‰è£…å•èŠ‚ç‚¹ Mysql æœç´¢ mysql è¿›å…¥åŒ…åä¸º Bitnamiçš„ chart INSTALL: å®‰è£…æ–¹å¼ VALUES SCHEMA: å¸¸ç”¨å‚æ•° # å®‰è£… $ helm install my-mysql --set-string auth.rootPassword=123456 --set primary.persistence.size=1Gi bitnami/mysql NAME: my-mysqlLAST DEPLOYED: Thu Oct 26 07:41:56 2023NAMESPACE: default STATUS: deployedREVISION: 1 TEST SUITE: None NOTES: CHART NAME: mysql CHART VERSION: 9.14.1 APP VERSION: 8.0.35 ** Please be patient while the chart is being deployed ** Tip: Watch the deployment status using the command: kubectl get pods -w --namespace default Services: echo Primary: my-mysql.default.svc.cluster.local:3306 Execute the following to get the administrator credentials: echo Username: root MYSQL_ROOT_PASSWORD=$(kubectl get secret --namespace default my-mysql -o jsonpath=\"{.data.mysql-root-password}\" | base64 -d) To connect to your database: 1. Run a pod that you can use as a client: kubectl run my-mysql-client --rm --tty -i --restart='Never' --image docker.io/bitnami/mysql:8.0.35-debian-11-r0 --namespace default --env MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD --command -- bash 2. To connect to primary service (read/write): mysql -h my-mysql.default.svc.cluster.local -uroot -p\"$MYSQL_ROOT_PASSWORD\" # æŸ¥çœ‹è®¾ç½® $ helm get values my-mysql USER-SUPPLIED VALUES: auth: rootPassword: \"123456\" primary: persistence: size: 1Gi # åˆ é™¤æœ¬æ¬¡ release $ helm delete my-mysql release \"my-mysql\" uninstalled æ³¨æ„å¦‚æœå®‰è£…å¤±è´¥ï¼Œéœ€åˆ é™¤ä¹‹å‰çš„ release åç§° # åŒä¸Šé¢çš„delete $ helm uninstall my-mysql release \"my-mysql\" uninstalled å…¶ä»–å‘½ä»¤ #æŸ¥çœ‹chart helm show chart bitnami/mysql #æŸ¥çœ‹é»˜è®¤å€¼ helm show values bitnami/mysql Helm éƒ¨ç½² MySQL é›†ç¾¤ å®‰è£…è¿‡ç¨‹ä¸­æœ‰ä¸¤ç§æ–¹å¼ä¼ é€’é…ç½®æ•°æ®ï¼š -f(æˆ–--values):ä½¿ç”¨ YAML æ–‡ä»¶è¦†ç›–é»˜è®¤é…ç½®ã€‚å¯ä»¥æŒ‡å®šå¤šæ¬¡ï¼Œä¼˜å…ˆä½¿ç”¨æœ€å³è¾¹çš„æ–‡ä»¶ã€‚ --set:é€šè¿‡å‘½ä»¤è¡Œçš„æ–¹å¼å¯¹æŒ‡å®šé¡¹è¿›è¡Œè¦†ç›–ã€‚ å¦‚æœåŒæ—¶ä½¿ç”¨ä¸¤ç§æ–¹å¼ï¼Œåˆ™ --set ä¸­çš„å€¼ä¼šè¢«åˆå¹¶åˆ° -f ä¸­ï¼Œä½†æ˜¯ --set ä¸­çš„å€¼ä¼˜å…ˆçº§æ›´é«˜ã€‚ ä½¿ç”¨é…ç½®æ–‡ä»¶è®¾ç½® MySQL çš„å‚æ•°ã€‚ auth: rootPassword: \"123456\" # Primary database configuration primary: # Enable persistence using Persistent Volume Claims persistence: # ä¸»èŠ‚ç‚¹æŒä¹…å·å¤§å° size: 1Gi # If true, use a Persistent Volume Claim, If false, use emptyDir enabled: true # Secondary database configuration secondary: # è®¾ç½®ä»èŠ‚ç‚¹æ•°é‡ replicaCount: 2 # Enable persistence using Persistent Volume Claims persistence: # ä»èŠ‚ç‚¹æŒä¹…å·å¤§å° size: 1Gi # If true, use a Persistent Volume Claim, If false, use emptyDir enabled: true # å®‰è£…é›†ç¾¤å¿…é¡»é…ç½® architecture: replication é€šè¿‡yamlé—®å·å®‰è£… $ helm install cluster -f values.yaml bitnami/mysql NAME: cluster LAST DEPLOYED: Thu Oct 26 07:56:15 2023 NAMESPACE: default STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: CHART NAME: mysql CHART VERSION: 9.14.1 APP VERSION: 8.0.35 ** Please be patient while the chart is being deployed ** Tip: Watch the deployment status using the command: kubectl get pods -w --namespace default Services: echo Primary: cluster-mysql-primary.default.svc.cluster.local:3306 echo Secondary: cluster-mysql-secondary.default.svc.cluster.local:3306 Execute the following to get the administrator credentials: echo Username: root MYSQL_ROOT_PASSWORD=$(kubectl get secret --namespace default cluster-mysql -o jsonpath=\"{.data.mysql-root-password}\" | base64 -d) To connect to your database: 1. Run a pod that you can use as a client: kubectl run cluster-mysql-client --rm --tty -i --restart='Never' --image docker.io/bitnami/mysql:8.0.35-debian-11-r0 --namespace default --env MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD --command -- bash 2. To connect to primary service (read/write): mysql -h cluster-mysql-primary.default.svc.cluster.local -uroot -p\"$MYSQL_ROOT_PASSWORD\" 3. To connect to secondary service (read-only): mysql -h cluster-mysql-secondary.default.svc.cluster.local -uroot -p\"$MYSQL_ROOT_PASSWORD\" è·å–åˆ›å»ºè¿‡ç¨‹ $ kubectl get pod --watch NAME READY STATUS RESTARTS AGE cluster-mysql-primary-0 0/1 ContainerCreating 0 2m33s cluster-mysql-secondary-0 0/1 Running 0 2m33s cluster-mysql-primary-0 0/1 Running 0 2m48s cluster-mysql-primary-0 0/1 Running 0 3m34s cluster-mysql-primary-0 1/1 Running 0 3m34s cluster-mysql-secondary-0 0/1 Running 1 (3s ago) 4m22s cluster-mysql-secondary-0 0/1 Running 1 (19s ago) 4m38s cluster-mysql-secondary-0 1/1 Running 1 (29s ago) 4m48s cluster-mysql-secondary-1 0/1 Pending 0 0s cluster-mysql-secondary-1 0/1 Pending 0 22s cluster-mysql-secondary-1 0/1 ContainerCreating 0 22s cluster-mysql-secondary-1 0/1 Running 0 2m9s $ kubectl get all NAME READY STATUS RESTARTS AGE pod/cluster-mysql-primary-0 1/1 Running 0 8m20s pod/cluster-mysql-secondary-0 1/1 Running 1 (4m1s ago) 8m20s pod/cluster-mysql-secondary-1 1/1 Running 0 3m32s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/kubernetes ClusterIP 10.43.0.1 443/TCP 25h service/cluster-mysql-primary-headless ClusterIP None 3306/TCP 8m20s service/cluster-mysql-secondary-headless ClusterIP None 3306/TCP 8m20s service/cluster-mysql-secondary ClusterIP 10.43.119.2 3306/TCP 8m20s service/cluster-mysql-primary ClusterIP 10.43.131.119 3306/TCP 8m20s NAME READY AGE statefulset.apps/cluster-mysql-primary 1/1 8m21s statefulset.apps/cluster-mysql-secondary 2/2 8m21s ä»¥ä¸Šå¯ä»¥çœ‹åˆ°åˆ†åˆ«ä¸ºä¸»ä»åº“åˆ›å»ºäº†æ— å¤´å’Œæœ‰å¤´çš„ serviceï¼Œä¸»ä»åº“åˆ†åˆ«ç”¨ statefulset åˆ›å»º æŒ‰ç…§å‰é¢å®‰è£…æˆåŠŸåè¯´æ˜æ“ä½œï¼š # é…ç½®rootç”¨æˆ·å¯†ç ç¯å¢ƒå˜é‡ $ MYSQL_ROOT_PASSWORD=$(kubectl get secret --namespace default cluster-mysql -o jsonpath=\"{.data.mysql-root-password}\" | base64 -d) # åˆ›å»ºmysql å®¢æˆ·ç«¯pod kubectl run cluster-mysql-client --rm --tty -i --restart='Never' --image docker.io/bitnami/mysql:8.0.35-debian-11-r0 --namespace default --env MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD --command -- bash If you don't see a command prompt, try pressing enter. I have no name!@cluster-mysql-client:/$ åœ¨ pod ä¸­è¿æ¥ä¸»åº“æµ‹è¯• $ mysql -h cluster-mysql-primary.default.svc.cluster.local -uroot -p\"$MYSQL_ROOT_PASSWORD\" mysql: [Warning] Using a password on the command line interface can be insecure. Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 133 Server version: 8.0.35 Source distribution Copyright (c) 2000, 2023, Oracle and/or its affiliates. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners. Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement. mysql> CREATE DATABASE test; Query OK, 1 row affected (0.07 sec) mysql> CREATE TABLE test.message (message VARCHAR(250)); Query OK, 0 rows affected (0.12 sec) mysql> INSERT INTO test.message VALUES ('hello'); Query OK, 1 row affected (0.05 sec) mysql> exit Bye åœ¨ pod ä¸­è¿æ¥ä»åº“æµ‹è¯• $ mysql -h cluster-mysql-secondary.default.svc.cluster.local -uroot -p\"$MYSQL_ROOT_PASSWORD\" mysql: [Warning] Using a password on the command line interface can be insecure. Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 159 Server version: 8.0.35 Source distribution Copyright (c) 2000, 2023, Oracle and/or its affiliates. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners. Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement. mysql> SELECT * FROM test.message; +---------+ | message | +---------+ | hello | +---------+ 1 row in set (0.02 sec) å‚è€ƒæ–‡æ¡£ï¼š https://helm.sh/zh/docs/intro/install/ https://helm.sh/zh/docs/intro/using_helm/ "}}